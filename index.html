<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Ads Creator | Soundvertise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Courier+Prime:wght@400;700&family=Inter:wght@400;600;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/mp4-muxer@latest/build/mp4-muxer.js"></script>
    <style>
        :root {
            --sv-purple: #8B5CF6;
            --sv-blue: #3B82F6;
            --sv-bg: #050505;
            --sv-card: #0F0F0F;
        }

        body {
            background-color: var(--sv-bg);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .iphone-frame {
            width: 290px;
            height: calc(290px * 16 / 9);
            border: 10px solid #1A1A1A;
            border-radius: 42px;
            position: relative;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 0 2px #000, 0 20px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .notch {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 75px;
            height: 22px;
            background: #000;
            border-radius: 20px;
            z-index: 50;
            border: 1px solid #222;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }

        #caption-overlay {
            position: absolute;
            cursor: move;
            user-select: none;
            text-align: center;
            max-width: 85%;
            word-wrap: break-word;
            z-index: 30;
            display: block;
            line-height: 1.1;
            left: 50%;
            transform: translateX(-50%);
            --outline-color: #000000;
            paint-order: stroke fill;
        }
        
        #caption-overlay:not(.dragging) {
            transition: top 0.1s ease-out;
        }

        .text-bold-outline {
            text-shadow: 
                0 0 1px var(--outline-color),
                -1.5px -1.5px 0 var(--outline-color),  
                 1.5px -1.5px 0 var(--outline-color),
                -1.5px  1.5px 0 var(--outline-color),
                 1.5px  1.5px 0 var(--outline-color),
                 0px 3px 8px rgba(0,0,0,0.6);
        }

        .tiktok-ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            display: block;
            background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.2) 100%);
        }

        .right-actions {
            position: absolute;
            right: 8px;
            bottom: 85px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .action-text { font-size: 8px; font-weight: 600; }

        .bottom-info {
            position: absolute;
            left: 12px;
            bottom: 20px;
            max-width: 190px;
        }

        .trimmer-track {
            position: relative;
            width: 100%;
            background: #111;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
            cursor: pointer;
        }

        .thumbnail-track {
            position: absolute;
            inset: 0;
            display: flex;
            pointer-events: none;
            opacity: 0.4;
        }

        .thumbnail-track canvas {
            height: 100%;
            flex: 1;
            object-fit: cover;
        }

        .trim-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            z-index: 5;
            cursor: grab;
            border-radius: 6px;
        }

        #video-trim-overlay {
            background: rgba(59, 130, 246, 0.2);
            border: 3px solid var(--sv-blue);
        }

        #audio-trim-overlay {
            background: rgba(139, 92, 246, 0.15);
            border: 3px solid var(--sv-purple);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .playhead-cursor {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #ffffff;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }

        .trim-handle {
            position: absolute;
            top: 0;
            width: 16px;
            height: 100%;
            background: inherit;
            cursor: ew-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #video-trim-overlay .trim-handle { background-color: var(--sv-blue); }
        #audio-trim-overlay .trim-handle { display: none; }

        .trim-handle::after {
            content: '';
            width: 2px;
            height: 14px;
            background: white;
            border-radius: 1px;
        }
        .handle-left { left: -8px; border-radius: 6px 0 0 6px; }
        .handle-right { right: -8px; border-radius: 0 6px 6px 0; }

        .waveform-wrapper {
            position: relative;
            width: 100%;
            height: 70px;
            background: #000;
        }

        #waveform { width: 100%; height: 100%; pointer-events: none; }

        .btn-sv {
            background: linear-gradient(135deg, var(--sv-blue) 0%, var(--sv-purple) 100%);
            transition: all 0.3s ease;
        }
        .btn-sv:hover { filter: brightness(1.1); transform: scale(1.02); }
        .btn-sv:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .font-tiktok { font-family: 'Montserrat', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        .font-typewriter { font-family: 'Courier Prime', monospace; }
        .font-classic { font-family: 'Inter', sans-serif; font-weight: 800; }
        .font-handwriting { font-family: 'Dancing Script', cursive; font-weight: 700; }

        .font-btn {
            background: #000;
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 10px;
            transition: all 0.2s;
            color: #666;
        }
        .font-btn.active {
            border-color: var(--sv-blue);
            background: rgba(59, 130, 246, 0.1);
            color: #fff;
        }

        .color-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
            background: #000;
            flex-shrink: 0;
        }
        
        .color-input {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            cursor: pointer;
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            background: #111;
            border: 1px solid #333;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            color: #666;
            cursor: pointer;
        }
        .toggle-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--sv-blue);
            color: #fff;
        }

        .caption-cat-btn {
            background: #000;
            border: 1px solid #333;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            color: #666;
            cursor: pointer;
        }
        .caption-cat-btn.active {
            border-color: var(--sv-purple);
            background: rgba(139, 92, 246, 0.15);
            color: #fff;
        }
        .caption-cat-btn:hover {
            border-color: var(--sv-purple);
            color: #fff;
        }

        #render-canvas {
            display: none;
        }

        .queue-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: all 0.2s;
        }

        .queue-item.active {
            border-color: var(--sv-blue);
            background: rgba(59, 130, 246, 0.15);
        }

        .queue-item:hover {
            border-color: var(--sv-blue);
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-caption {
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-meta {
            font-size: 8px;
            color: #888;
            margin-top: 2px;
        }

        .queue-item-actions {
            display: flex;
            gap: 4px;
        }

        .queue-item-btn {
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .queue-item-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #666;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
        
        <!-- Preview Column -->
        <div class="preview-column space-y-4 order-2 lg:order-1">

            <!-- Quick Controls Bar (above preview) -->
            <div class="bg-zinc-900/60 border border-zinc-800 rounded-2xl p-3 flex items-center gap-2 flex-wrap backdrop-blur-xl">
                <!-- Audio selector -->
                <select id="audio-selector" class="bg-zinc-900 border border-zinc-700 rounded-lg px-2 py-1.5 text-[10px] text-zinc-300 font-bold cursor-pointer hover:border-violet-500 transition-all flex-1 min-w-0">
                    <option value="">No Audio</option>
                </select>
                <!-- Prev/Next video -->
                <button id="prev-video-btn" class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1 disabled:opacity-30">
                    <i data-lucide="chevron-left" class="w-3.5 h-3.5"></i>
                </button>
                <button id="next-video-btn" class="px-3 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1 disabled:opacity-30">
                    <i data-lucide="chevron-right" class="w-3.5 h-3.5"></i>
                </button>
                <!-- Auto Queue -->
                <button id="auto-queue-btn" class="px-3 py-2 bg-violet-600 hover:bg-violet-500 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1.5 shadow-lg">
                    <i data-lucide="zap" class="w-3.5 h-3.5"></i>
                    Auto
                </button>
                <!-- Add / Save -->
                <button id="add-to-queue-btn" class="px-3 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1.5 shadow-lg">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                    Add
                </button>
                <button id="save-queue-btn" class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded-xl text-[10px] font-black uppercase transition-all flex items-center gap-1.5 shadow-lg hidden">
                    <i data-lucide="save" class="w-3.5 h-3.5"></i>
                    Save
                </button>
            </div>

            <!-- Queue List (compact, below top controls) -->
            <div id="queue-list-wrapper" class="bg-zinc-900/60 border border-zinc-800 rounded-2xl overflow-hidden backdrop-blur-xl hidden">
                <div class="px-3 py-1.5 border-b border-zinc-800 flex items-center justify-between">
                    <span class="text-[9px] font-black uppercase text-zinc-500 tracking-widest">Queue</span>
                    <span id="queue-count" class="text-violet-400 font-mono text-[9px] font-bold uppercase">0/20</span>
                </div>
                <div id="queue-list" class="space-y-0.5 max-h-40 overflow-y-auto p-2"></div>
            </div>

            <div class="iphone-frame" id="iphone">
                <div class="notch"></div>
                <div class="video-container" id="drop-zone">
                    <video id="main-video" crossorigin="anonymous" playsinline loop muted></video>
                    <div id="caption-overlay" class="font-tiktok text-bold-outline" style="top: 35%; font-size: 12px; color: white;">
                        Write your text
                    </div>
                    <div id="safe-guide" class="tiktok-ui-overlay">
                        <div class="right-actions">
                            <div class="action-item flex flex-col items-center">
                                <div class="w-9 h-9 rounded-full border border-white bg-zinc-800 mb-1 overflow-hidden">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=SV" alt="avatar">
                                </div>
                            </div>
                            <div class="action-item flex flex-col items-center">
                                <i data-lucide="heart" class="text-white fill-white w-7 h-7"></i>
                                <span class="action-text text-white">580K</span>
                            </div>
                            <div class="action-item flex flex-col items-center">
                                <i data-lucide="message-circle" class="text-white fill-white w-7 h-7"></i>
                                <span class="action-text text-white">2.4K</span>
                            </div>
                        </div>
                        <div class="bottom-info space-y-0.5">
                            <p class="font-bold text-[11px]">@soundvertise.co</p>
                            <p class="text-[10px] opacity-90 leading-tight">Video made with Soundvertise.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="toggle-guide" class="flex-1 px-5 py-2 bg-zinc-900 rounded-full text-[9px] font-black uppercase border border-zinc-800 hover:border-blue-500 transition-all text-zinc-400 hover:text-white">
                   TikTok UI Preview
                </button>
                <button id="toggle-watermark" class="toggle-btn">
                    <i data-lucide="zoom-in" class="w-3.5 h-3.5"></i>
                    Remove VEO
                </button>
            </div>
        </div>

        <!-- Editor Controls -->
        <div class="bg-zinc-900/40 border border-zinc-800 p-6 md:p-8 rounded-[2.5rem] space-y-6 backdrop-blur-xl order-1 lg:order-2">
            <header class="flex justify-between items-end border-b border-zinc-800/50 pb-4">
                <div>
                    <h1 class="text-xl font-black italic uppercase">Video <span class="text-blue-400">Ads Creator</span></h1>
                    <p class="text-[9px] font-bold tracking-widest text-zinc-600">SOUNDVERTISE</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <span id="video-dur-label" class="text-blue-400 font-mono text-xs font-bold uppercase block">Video: 15.0s</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-zinc-500">Video Files (Max 20)</label>
                    <label for="video-input" class="flex items-center gap-3 bg-black border border-zinc-800 p-3 rounded-xl cursor-pointer hover:border-blue-500 transition-all">
                        <i data-lucide="video" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-[11px] text-zinc-400 truncate" id="video-label">Load Videos (Multiple)</span>
                        <input type="file" id="video-input" accept="video/*" multiple class="hidden">
                    </label>
                    <div id="video-files-list" class="text-[9px] text-zinc-500 mt-1"></div>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-zinc-500">Audio Files (Max 20)</label>
                    <label for="audio-input" class="flex items-center gap-3 bg-black border border-zinc-800 p-3 rounded-xl cursor-pointer hover:border-violet-500 transition-all">
                        <i data-lucide="music" class="w-4 h-4 text-violet-400"></i>
                        <span class="text-[11px] text-zinc-400 truncate" id="audio-label">Load Audio (Multiple)</span>
                        <input type="file" id="audio-input" accept="audio/*" multiple class="hidden">
                    </label>
                    <div id="audio-files-list" class="text-[9px] text-zinc-500 mt-1"></div>
                </div>
            </div>

            <!-- Video Trimmer -->
            <div class="space-y-2">
                <div class="flex justify-between items-center text-[9px] font-black uppercase text-zinc-500">
                    <span>Trim Video Clip (Max 30s)</span>
                    <span id="v-range-text">0.0s - 15.0s</span>
                </div>
                <div class="trimmer-track h-[54px]" id="v-trimmer-track">
                    <div class="thumbnail-track" id="v-thumbs"></div>
                    <div id="video-playhead" class="playhead-cursor" style="left: 0; display: none;"></div>
                    <div id="video-trim-overlay" class="trim-overlay">
                        <div class="trim-handle handle-left" id="v-handle-l"></div>
                        <div class="trim-handle handle-right" id="v-handle-r"></div>
                    </div>
                </div>
            </div>

            <!-- Audio Waveform Trimmer -->
            <div class="space-y-3 bg-black p-4 rounded-3xl border border-zinc-800/50">
                <div class="flex items-center gap-4">
                    <button id="play-btn" class="w-12 h-12 rounded-xl btn-sv text-white flex items-center justify-center shadow-lg shrink-0">
                        <i data-lucide="play" id="play-icon" class="w-5 h-5 fill-white"></i>
                    </button>
                    <div class="flex-1 space-y-1">
                        <div class="flex justify-between items-center text-[9px] font-black uppercase text-zinc-500">
                            <span>Audio Waveform (Loop Preview)</span>
                            <span id="audio-start-label">Start: 0.0s</span>
                        </div>

                        <div class="trimmer-track h-[70px]" id="a-trimmer-track">
                            <div class="waveform-wrapper">
                                <canvas id="waveform"></canvas>
                            </div>
                            <div id="audio-playhead" class="playhead-cursor" style="left: 0; display: none;"></div>
                            <div id="audio-trim-overlay" class="trim-overlay"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Editor -->
            <div class="p-5 bg-zinc-900/60 rounded-3xl border border-zinc-800 space-y-4">
                <!-- Viral Captions Generator -->
                <div class="space-y-3 p-4 bg-gradient-to-br from-violet-950/30 to-blue-950/30 rounded-2xl border border-violet-800/30">
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-black uppercase text-violet-300 tracking-widest">âœ¨ Viral Captions</span>
                        <button id="random-caption-btn" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-[9px] font-black uppercase transition-all flex items-center gap-1.5">
                            <i data-lucide="shuffle" class="w-3 h-3"></i>
                            Random
                        </button>
                    </div>
                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-1.5">
                        <button class="caption-cat-btn active" data-category="happy">Happy</button>
                        <button class="caption-cat-btn" data-category="sad">Sad</button>
                        <button class="caption-cat-btn" data-category="dance">Dance</button>
                        <button class="caption-cat-btn" data-category="chill">Chill</button>
                        <button class="caption-cat-btn" data-category="love">Love</button>
                        <button class="caption-cat-btn" data-category="pov">POV</button>
                        <button class="caption-cat-btn" data-category="gym">Gym</button>
                        <button class="caption-cat-btn" data-category="energy">Energy</button>
                        <button class="caption-cat-btn" data-category="party">Party</button>
                        <button class="caption-cat-btn" data-category="viral">Viral</button>
                        <button class="caption-cat-btn" data-category="beauty">Beauty</button>
                        <button class="caption-cat-btn" data-category="sensual">Sensual</button>
                        <button class="caption-cat-btn" data-category="savage">Savage</button>
                        <button class="caption-cat-btn" data-category="aesthetic">Aesthetic</button>
                        <button class="caption-cat-btn" data-category="relatable">Relatable</button>
                        <button class="caption-cat-btn" data-category="dreamy">Dreamy</button>
                        <button class="caption-cat-btn" data-category="chaotic">Chaotic</button>
                        <button class="caption-cat-btn" data-category="main">Main Char</button>
                    </div>
                </div>

                <textarea id="caption-input" rows="2" placeholder="Write your text here..." class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-sm focus:ring-1 focus:ring-blue-500 outline-none resize-none font-semibold"></textarea>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <button class="font-btn active" data-font="font-tiktok">TIKTOK</button>
                    <button class="font-btn" data-font="font-typewriter">RETRO</button>
                    <button class="font-btn" data-font="font-classic">BOLD</button>
                    <button class="font-btn" data-font="font-handwriting">SCRIPT</button>
                </div>

                <div class="space-y-4 pt-2">
                    <div class="flex-1 space-y-2">
                        <div class="flex justify-between text-[9px] font-black text-zinc-500 uppercase tracking-widest">
                            <span>Font Size</span>
                            <span id="fs-val" class="text-blue-400">12px</span>
                        </div>
                        <input type="range" id="font-size" min="12" max="60" value="12" class="w-full accent-blue-500 h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <div class="flex flex-col gap-4 p-4 bg-black/40 rounded-2xl border border-zinc-800/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="color-wrapper shadow-lg"><input type="color" id="text-color" value="#ffffff" class="color-input"></div>
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Text Color</span>
                            </div>

                            <div class="h-6 w-[1px] bg-zinc-800"></div>

                            <div class="flex items-center gap-3">
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Outline</span>
                                <div class="color-wrapper shadow-lg"><input type="color" id="outline-color" value="#000000" class="color-input"></div>
                            </div>
                        </div>

                        <button id="outline-toggle" class="toggle-btn active justify-center w-full">
                            <i data-lucide="check" class="w-3.5 h-3.5"></i>
                            Stile Outline Attivo
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="export-btn" class="btn-sv text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest text-[10px]">
                    <i data-lucide="download" class="w-4 h-4"></i> Export Single Video
                </button>
                <button id="export-all-btn" class="bg-gradient-to-r from-violet-600 to-blue-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest text-[10px] disabled:opacity-50 disabled:cursor-not-allowed hover:from-violet-500 hover:to-blue-500 transition-all">
                    <i data-lucide="download-cloud" class="w-4 h-4"></i> Export All (<span id="export-count">0</span>)
                </button>
            </div>
            
            <div id="export-status" class="hidden bg-black border border-zinc-800 p-4 rounded-2xl">
                <div class="flex justify-between text-[10px] mb-2 font-black uppercase text-blue-400">
                    <span id="status-text">Preparing...</span>
                    <span id="percent-text">0%</span>
                </div>
                <div class="w-full bg-zinc-900 rounded-full h-1.5 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="bg-music" crossorigin="anonymous"></audio>
    <canvas id="render-canvas"></canvas>
    <video id="source-video" style="display: none;"></video>

    <script>
        lucide.createIcons();

        // ============ TOP BAR AUDIO SELECTOR SYNC ============
        function syncTopSaveAdd(saveVisible) {
            if (saveVisible) {
                document.getElementById('save-queue-btn').classList.remove('hidden');
                document.getElementById('add-to-queue-btn').classList.add('hidden');
            } else {
                document.getElementById('save-queue-btn').classList.add('hidden');
                document.getElementById('add-to-queue-btn').classList.remove('hidden');
            }
        }
        function syncTopAudioSelector() {
            // audio-selector IS the top selector now â€” no sync needed
        }
        // ============ END TOP BAR ============

        const video = document.getElementById('main-video');
        const audio = document.getElementById('bg-music');
        const caption = document.getElementById('caption-overlay');
        const captionElement = document.getElementById('caption-overlay');
        const videoContainer = document.getElementById('drop-zone');
        const vTrimOverlay = document.getElementById('video-trim-overlay');
        const aTrimOverlay = document.getElementById('audio-trim-overlay');
        const vTrimmerTrack = document.getElementById('v-trimmer-track');
        const aTrimmerTrack = document.getElementById('a-trimmer-track');
        const vPlayhead = document.getElementById('video-playhead');
        const aPlayhead = document.getElementById('audio-playhead');
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');

        let videoFile, audioFile;
        let videoDuration = 0, audioDuration = 0;
        let vStart = 0, vEnd = 15;
        let aStart = 0;
        
        const MAX_DUR = 30; 
        
        let outlineEnabled = true;
        let removeWatermark = false;
        let isDraggingV = null; 
        let isDraggingA = false;
        let dragOffsetV = 0;
        let dragOffsetA = 0;

        // File libraries for bulk workflow
        let videoLibrary = [];
        let audioLibrary = [];
        let currentVideoIndex = 0;
        let currentAudioIndex = -1; // -1 means no audio selected

        function updateFileLibraryUI() {
            const videoList = document.getElementById('video-files-list');
            const audioList = document.getElementById('audio-files-list');
            
            if (videoLibrary.length > 0) {
                videoList.innerHTML = `ðŸ“ ${videoLibrary.length} videos loaded`;
                document.getElementById('video-label').innerText = `${videoLibrary.length} videos ready`;
            } else {
                videoList.innerHTML = '';
                document.getElementById('video-label').innerText = 'Load Videos (Multiple)';
            }
            
            if (audioLibrary.length > 0) {
                audioList.innerHTML = `ðŸŽµ ${audioLibrary.length} audio files loaded`;
                document.getElementById('audio-label').innerText = `${audioLibrary.length} audio files ready`;
                
                // Update audio selector
                const selector = document.getElementById('audio-selector');
                selector.innerHTML = '<option value="">No Audio</option>';
                audioLibrary.forEach((audioFile, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = audioFile.name;
                    selector.appendChild(option);
                });
                // Sync top selector
                syncTopAudioSelector();
            } else {
                audioList.innerHTML = '';
                document.getElementById('audio-label').innerText = 'Load Audio (Multiple)';
            }
        }

        function loadVideoFromLibrary(index) {
            if (index < 0 || index >= videoLibrary.length) return;
            
            currentVideoIndex = index;
            videoFile = videoLibrary[index];
            video.src = URL.createObjectURL(videoFile);
            video.onloadedmetadata = () => {
                videoDuration = video.duration;
                vStart = 0;
                vEnd = Math.min(videoDuration, 15);
                updateTrimmers();
                video.currentTime = vStart;
            };
            generateThumbnails(videoFile);
        }

        function loadAudioFromSelector() {
            const selector = document.getElementById('audio-selector');
            const selectedIndex = parseInt(selector.value);
            
            if (isNaN(selectedIndex) || selectedIndex < 0) {
                // No audio selected
                currentAudioIndex = -1;
                audioFile = null;
                audio.src = '';
                audioDuration = 0;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                updateTrimmers();
                return;
            }
            
            currentAudioIndex = selectedIndex;
            audioFile = audioLibrary[selectedIndex];
            audio.src = URL.createObjectURL(audioFile);
            audio.onloadedmetadata = () => {
                audioDuration = audio.duration;
                drawWaveform(audioFile);
                updateTrimmers();
                audio.currentTime = aStart;
            };
        }

        // Toggle watermark removal
        document.getElementById('toggle-watermark').onclick = function() {
            removeWatermark = !removeWatermark;
            this.classList.toggle('active');
            
            if (removeWatermark) {
                video.style.transform = 'scale(1.1)';
                this.innerHTML = '<i data-lucide="zoom-out" class="w-3.5 h-3.5"></i> Reset Zoom';
            } else {
                video.style.transform = 'scale(1)';
                this.innerHTML = '<i data-lucide="zoom-in" class="w-3.5 h-3.5"></i> Remove VEO';
            }
            lucide.createIcons();
        };

        function updateTrimmers() {
            if (videoDuration > 0) {
                const vLeft = (vStart / videoDuration) * 100;
                const vWidth = ((vEnd - vStart) / videoDuration) * 100;
                vTrimOverlay.style.left = vLeft + '%';
                vTrimOverlay.style.width = vWidth + '%';
                
                document.getElementById('v-range-text').innerText = `${vStart.toFixed(1)}s - ${vEnd.toFixed(1)}s`;
                document.getElementById('video-dur-label').innerText = `Video: ${(vEnd - vStart).toFixed(1)}s`;
                
                if (audioDuration > 0) {
                    const currentVidDur = vEnd - vStart;
                    const aWidth = (currentVidDur / audioDuration) * 100;
                    
                    if (aStart + currentVidDur > audioDuration) {
                        aStart = Math.max(0, audioDuration - currentVidDur);
                    }
                    
                    const aLeft = (aStart / audioDuration) * 100;
                    aTrimOverlay.style.left = aLeft + '%';
                    aTrimOverlay.style.width = aWidth + '%';
                    document.getElementById('audio-start-label').innerText = `Audio Start: ${aStart.toFixed(1)}s`;
                }
            }
        }

        function loopMonitor() {
            if (!video.paused) {
                if (videoDuration > 0) {
                    const vPerc = (video.currentTime / videoDuration) * 100;
                    vPlayhead.style.left = vPerc + '%';
                    vPlayhead.style.display = 'block';
                }

                if (audio.src && audioDuration > 0) {
                    const aPerc = (audio.currentTime / audioDuration) * 100;
                    aPlayhead.style.left = aPerc + '%';
                    aPlayhead.style.display = 'block';
                }

                if (video.currentTime >= vEnd - 0.05) {
                    video.currentTime = vStart;
                    if (audio.src) {
                        audio.currentTime = aStart;
                        audio.play().catch(() => {});
                    }
                }

                if (audio.src && !audio.paused) {
                    const videoOffset = video.currentTime - vStart;
                    const expectedAudioTime = aStart + videoOffset;
                    if (Math.abs(audio.currentTime - expectedAudioTime) > 0.2) {
                        audio.currentTime = expectedAudioTime;
                    }
                }
            } else {
                vPlayhead.style.display = 'none';
                aPlayhead.style.display = 'none';
            }
            requestAnimationFrame(loopMonitor);
        }
        requestAnimationFrame(loopMonitor);

        vTrimmerTrack.onmousedown = (e) => {
            if (videoDuration === 0) return;
            const rect = vTrimmerTrack.getBoundingClientRect();
            const clickTime = ((e.clientX - rect.left) / rect.width) * videoDuration;
            
            if (e.target.id === 'v-handle-l') {
                isDraggingV = 'left';
            } else if (e.target.id === 'v-handle-r') {
                isDraggingV = 'right';
            } else if (e.target.closest('#video-trim-overlay')) {
                isDraggingV = 'center';
                dragOffsetV = clickTime - vStart;
            } else {
                video.currentTime = clickTime;
                if (audio.src) {
                    const offset = clickTime - vStart;
                    audio.currentTime = Math.max(0, aStart + offset);
                }
            }
        };

        aTrimmerTrack.onmousedown = (e) => {
            if (audioDuration === 0) return;
            const rect = aTrimmerTrack.getBoundingClientRect();
            const clickTime = ((e.clientX - rect.left) / rect.width) * audioDuration;
            
            if (e.target.closest('#audio-trim-overlay')) {
                isDraggingA = true;
                dragOffsetA = clickTime - aStart;
            } else {
                const currentVidDur = vEnd - vStart;
                let newAStart = clickTime - (currentVidDur / 2);
                if (newAStart < 0) newAStart = 0;
                if (newAStart + currentVidDur > audioDuration) newAStart = audioDuration - currentVidDur;
                aStart = newAStart;
                updateTrimmers();
                audio.currentTime = aStart;
                video.currentTime = vStart;
            }
        };

        window.onmousemove = (e) => {
            if (isDraggingV && videoDuration > 0) {
                const rect = vTrimmerTrack.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const currentTime = (x / rect.width) * videoDuration;

                if (isDraggingV === 'left') {
                    if (currentTime < vEnd && vEnd - currentTime <= MAX_DUR) vStart = currentTime;
                    else if (vEnd - currentTime > MAX_DUR) vStart = vEnd - MAX_DUR;
                } else if (isDraggingV === 'right') {
                    if (currentTime > vStart && currentTime - vStart <= MAX_DUR) vEnd = currentTime;
                    else if (currentTime - vStart > MAX_DUR) vEnd = vStart + MAX_DUR;
                } else if (isDraggingV === 'center') {
                    let dur = vEnd - vStart;
                    let newStart = currentTime - dragOffsetV;
                    if (newStart >= 0 && newStart + dur <= videoDuration) {
                        vStart = newStart;
                        vEnd = newStart + dur;
                    }
                }
                updateTrimmers();
                syncPlayback();
            }

            if (isDraggingA && audioDuration > 0) {
                const rect = aTrimmerTrack.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const currentTime = (x / rect.width) * audioDuration;
                const currentVidDur = vEnd - vStart;
                let newAStart = currentTime - dragOffsetA;
                if (newAStart >= 0 && newAStart + currentVidDur <= audioDuration) {
                    aStart = newAStart;
                }
                updateTrimmers();
                syncPlayback();
            }
        };

        window.onmouseup = () => {
            isDraggingV = null;
            isDraggingA = false;
        };

        document.getElementById('video-input').onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            if (files.length > MAX_QUEUE_SIZE) {
                alert(`Puoi caricare massimo ${MAX_QUEUE_SIZE} video!`);
                videoLibrary = files.slice(0, MAX_QUEUE_SIZE);
            } else {
                videoLibrary = files;
            }
            
            updateFileLibraryUI();
            
            // Load first video automatically
            if (videoLibrary.length > 0) {
                loadVideoFromLibrary(0);
                
                // Show success notification
                const statusDiv = document.createElement('div');
                statusDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
                statusDiv.innerText = `âœ“ ${videoLibrary.length} videos loaded!`;
                document.body.appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 2000);
            }
        };

        document.getElementById('audio-input').onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            if (files.length > MAX_QUEUE_SIZE) {
                alert(`Puoi caricare massimo ${MAX_QUEUE_SIZE} audio!`);
                audioLibrary = files.slice(0, MAX_QUEUE_SIZE);
            } else {
                audioLibrary = files;
            }
            
            updateFileLibraryUI();
            
            // Show success notification
            const statusDiv = document.createElement('div');
            statusDiv.className = 'fixed top-4 right-4 bg-violet-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
            statusDiv.innerText = `âœ“ ${audioLibrary.length} audio files loaded!`;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 2000);
        };

        // Audio selector change handler
        document.getElementById('audio-selector').onchange = () => {
            loadAudioFromSelector();
        };

        document.getElementById('play-btn').onclick = () => {
            if (video.paused) {
                video.currentTime = vStart;
                if (audio.src) {
                    audio.currentTime = aStart;
                    audio.play().catch(() => {});
                }
                video.play();
                updatePlayIcon(true);
            } else {
                video.pause();
                audio.pause();
                updatePlayIcon(false);
            }
        };

        function syncPlayback() {
            video.currentTime = vStart;
            if (audio.src) audio.currentTime = aStart;
            if (!video.paused) {
                video.play();
                if (audio.src) audio.play().catch(() => {});
            }
        }

        function updatePlayIcon(isPlaying) {
            const icon = document.getElementById('play-icon');
            icon.setAttribute('data-lucide', isPlaying ? 'pause' : 'play');
            lucide.createIcons();
        }

        async function drawWaveform(file) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = await file.arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(buffer);
            const rawData = decoded.getChannelData(0);
            const samples = 120;
            const blockSize = Math.floor(rawData.length / samples);
            const data = [];
            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < blockSize; j++) sum += Math.abs(rawData[i * blockSize + j]);
                data.push(sum / blockSize);
            }
            const max = Math.max(...data);
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            const step = canvas.width / samples;
            const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            grad.addColorStop(0, '#3B82F6');
            grad.addColorStop(1, '#8B5CF6');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = grad;
            data.forEach((val, i) => {
                const h = (val / max) * canvas.height * 0.8;
                const x = i * step;
                const y = (canvas.height - h) / 2;
                ctx.beginPath();
                ctx.roundRect(x, y, step - 3, h, 2);
                ctx.fill();
            });
        }

        document.getElementById('caption-input').oninput = (e) => caption.innerText = e.target.value || 'Scrivi il tuo testo';
        document.getElementById('font-size').oninput = (e) => {
            caption.style.fontSize = e.target.value + 'px';
            document.getElementById('fs-val').innerText = e.target.value + 'px';
        };
        document.getElementById('text-color').oninput = (e) => caption.style.color = e.target.value;
        
        const outlineBtn = document.getElementById('outline-toggle');
        const outlineColorInput = document.getElementById('outline-color');

        function updateOutlineUI() {
            if (outlineEnabled) {
                caption.classList.add('text-bold-outline');
                outlineBtn.classList.add('active');
                outlineBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5"></i> Stile Outline Attivo';
            } else {
                caption.classList.remove('text-bold-outline');
                outlineBtn.classList.remove('active');
                outlineBtn.innerHTML = '<i data-lucide="x" class="w-3.5 h-3.5"></i> Stile Outline Spento';
            }
            lucide.createIcons();
        }

        outlineBtn.onclick = () => {
            outlineEnabled = !outlineEnabled;
            updateOutlineUI();
        };

        outlineColorInput.oninput = (e) => {
            caption.style.setProperty('--outline-color', e.target.value);
            if (!outlineEnabled) {
                outlineEnabled = true;
                updateOutlineUI();
            }
        };

        document.querySelectorAll('.font-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const hasOutline = caption.classList.contains('text-bold-outline');
                caption.className = btn.dataset.font + (hasOutline ? ' text-bold-outline' : '');
            };
        });

        let dragText = false, dragStartY, dragStartTop;
        
        caption.onmousedown = (e) => { 
            dragText = true; 
            dragStartY = e.clientY;
            dragStartTop = caption.offsetTop;
            caption.style.cursor = 'grabbing';
            caption.classList.add('dragging');
            e.preventDefault();
        };
        
        window.addEventListener('mousemove', (e) => {
            if (dragText) {
                const rect = document.getElementById('drop-zone').getBoundingClientRect();
                const deltaY = e.clientY - dragStartY;
                let newTop = dragStartTop + deltaY;
                
                const minTop = 10;
                const maxTop = rect.height - caption.offsetHeight - 10;
                newTop = Math.max(minTop, Math.min(newTop, maxTop));
                
                caption.style.top = newTop + 'px';
            }
        });
        
        window.addEventListener('mouseup', () => {
            if (dragText) {
                dragText = false;
                caption.style.cursor = 'move';
                caption.classList.remove('dragging');
            }
        });

        async function generateThumbnails(file) {
            const container = document.getElementById('v-thumbs');
            container.innerHTML = '';
            const tempVideo = document.createElement('video');
            tempVideo.src = URL.createObjectURL(file);
            tempVideo.muted = true;
            tempVideo.playsInline = true;
            await new Promise(r => tempVideo.onloadedmetadata = r);
            const count = 10;
            const interval = tempVideo.duration / count;
            for (let i = 0; i < count; i++) {
                tempVideo.currentTime = i * interval;
                await new Promise(r => tempVideo.onseeked = r);
                const c = document.createElement('canvas');
                const ratio = tempVideo.videoWidth / tempVideo.videoHeight;
                c.width = 100; c.height = 100 / ratio;
                c.getContext('2d').drawImage(tempVideo, 0, 0, c.width, c.height);
                container.appendChild(c);
            }
            URL.revokeObjectURL(tempVideo.src);
        }

        // Export usando mp4-muxer
        document.getElementById('export-btn').onclick = async () => {
            if (!videoFile) {
                alert('Load a video before exporting!');
                return;
            }

            const exportBtn = document.getElementById('export-btn');
            exportBtn.disabled = true;
            
            const status = document.getElementById('export-status');
            const progress = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            const percentText = document.getElementById('percent-text');
            
            status.classList.remove('hidden');
            progress.style.width = '0%';
            percentText.innerText = '0%';
            statusText.innerText = 'Initializing...';

            try {
                const sourceVideo = document.getElementById('source-video');
                sourceVideo.src = URL.createObjectURL(videoFile);
                await new Promise(r => sourceVideo.onloadedmetadata = r);

                const renderCanvas = document.getElementById('render-canvas');
                const renderCtx = renderCanvas.getContext('2d', { willReadFrequently: true });
                
                const targetWidth = 1080;
                const targetHeight = 1920;
                
                renderCanvas.width = targetWidth;
                renderCanvas.height = targetHeight;

                const fps = 30;
                const duration = vEnd - vStart;

                statusText.innerText = 'Creating MP4 muxer...';

                const { Muxer, ArrayBufferTarget } = window.Mp4Muxer;

                const muxerConfig = {
                    target: new ArrayBufferTarget(),
                    video: {
                        codec: 'avc',
                        width: renderCanvas.width,
                        height: renderCanvas.height
                    },
                    fastStart: 'in-memory'
                };

                if (audioFile) {
                    muxerConfig.audio = {
                        codec: 'aac',
                        numberOfChannels: 2,
                        sampleRate: 48000
                    };
                }

                const muxer = new Muxer(muxerConfig);

                statusText.innerText = 'Encoding video...';
                
                const videoEncoder = new VideoEncoder({
                    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                    error: e => {
                        console.error('Video encoder error:', e);
                        throw new Error('Errore di codifica video: ' + e.message);
                    }
                });

                videoEncoder.configure({
                    codec: 'avc1.640028',
                    width: renderCanvas.width,
                    height: renderCanvas.height,
                    bitrate: 25_000_000,
                    framerate: fps,
                    avc: { format: 'avc' }
                });

                let audioEncoder = null;
                let audioContext = null;
                let audioData = null;

                if (audioFile) {
                    statusText.innerText = 'Preparing audio...';
                    
                    audioContext = new AudioContext({ sampleRate: 48000 });
                    const audioBuffer = await audioFile.arrayBuffer();
                    const decodedAudio = await audioContext.decodeAudioData(audioBuffer);
                    
                    const startSample = Math.floor(aStart * decodedAudio.sampleRate);
                    const endSample = Math.floor((aStart + duration) * decodedAudio.sampleRate);
                    const sampleCount = endSample - startSample;
                    
                    audioData = {
                        left: new Float32Array(sampleCount),
                        right: new Float32Array(sampleCount),
                        sampleRate: decodedAudio.sampleRate
                    };
                    
                    const leftChannel = decodedAudio.getChannelData(0);
                    const rightChannel = decodedAudio.numberOfChannels > 1 ? decodedAudio.getChannelData(1) : leftChannel;
                    
                    for (let i = 0; i < sampleCount; i++) {
                        audioData.left[i] = leftChannel[startSample + i] || 0;
                        audioData.right[i] = rightChannel[startSample + i] || 0;
                    }

                    audioEncoder = new AudioEncoder({
                        output: (chunk, meta) => muxer.addAudioChunk(chunk, meta),
                        error: e => {
                            console.error('Audio encoder error:', e);
                            throw new Error('Errore di codifica audio: ' + e.message);
                        }
                    });

                    audioEncoder.configure({
                        codec: 'mp4a.40.2',
                        sampleRate: 48000,
                        numberOfChannels: 2,
                        bitrate: 192000
                    });
                }

                // Capture caption position before rendering
                const captionElement = document.getElementById('caption-overlay');
                const videoContainer = document.getElementById('drop-zone');
                const containerRect = videoContainer.getBoundingClientRect();
                const captionRect = captionElement.getBoundingClientRect();
                const captionPosition = {
                    text: captionElement.innerText,
                    topPx: captionRect.top - containerRect.top,
                    maxWidthPx: captionElement.offsetWidth,
                    fontSize: parseInt(captionElement.style.fontSize || '12'),
                    color: captionElement.style.color || '#ffffff',
                    outlineColor: getComputedStyle(captionElement).getPropertyValue('--outline-color') || '#000000',
                    fontClass: captionElement.className,
                    hasOutline: captionElement.classList.contains('text-bold-outline')
                };

                // SMOOTH FRAME CAPTURE: play video and grab frames via requestVideoFrameCallback
                // This avoids slow/imprecise seek-per-frame and produces smooth output
                sourceVideo.currentTime = vStart;
                await new Promise(r => { sourceVideo.onseeked = r; });

                const totalFrames = Math.ceil(duration * fps);
                let frameCount = 0;
                let audioSampleOffset = 0;
                const targetSampleRate = 48000;
                const sourceSampleRate = audioData ? audioData.sampleRate : 48000;
                const samplesPerFrame = Math.floor(targetSampleRate / fps);

                {
                    let capturedFrames = 0;

                    function drawCaption() {
                        if (captionPosition.text && captionPosition.text !== 'Write your text here' && captionPosition.text !== 'Scrivi il tuo testo') {
                            const previewHeight = videoContainer.offsetHeight;
                            const exportHeight = renderCanvas.height;
                            const scaleFactor = exportHeight / previewHeight;
                            const scaledFontSize = captionPosition.fontSize * scaleFactor;
                            const scaledMaxWidth = captionPosition.maxWidthPx * scaleFactor;

                            let fontFamily = 'Montserrat';
                            if (captionPosition.fontClass.includes('font-typewriter')) fontFamily = 'Courier Prime';
                            else if (captionPosition.fontClass.includes('font-classic')) fontFamily = 'Inter';
                            else if (captionPosition.fontClass.includes('font-handwriting')) fontFamily = 'Dancing Script';

                            renderCtx.font = `800 ${scaledFontSize}px ${fontFamily}`;
                            renderCtx.textAlign = 'center';
                            renderCtx.textBaseline = 'top';

                            function wrapText(text, maxWidth) {
                                const words = text.split(' ');
                                const lines = [];
                                let currentLine = words[0];
                                for (let wi = 1; wi < words.length; wi++) {
                                    const testLine = currentLine + ' ' + words[wi];
                                    if (renderCtx.measureText(testLine).width > maxWidth) {
                                        lines.push(currentLine);
                                        currentLine = words[wi];
                                    } else {
                                        currentLine = testLine;
                                    }
                                }
                                lines.push(currentLine);
                                return lines;
                            }

                            const lines = wrapText(captionPosition.text, scaledMaxWidth);
                            const lineHeight = scaledFontSize * 1.2;
                            const textY = captionPosition.topPx * scaleFactor;

                            lines.forEach((line, li) => {
                                const y = textY + (li * lineHeight);
                                if (captionPosition.hasOutline) {
                                    renderCtx.strokeStyle = captionPosition.outlineColor;
                                    renderCtx.lineWidth = Math.max(scaleFactor * 1.5, 3);
                                    renderCtx.lineJoin = 'round';
                                    renderCtx.miterLimit = 2;
                                    renderCtx.strokeText(line, renderCanvas.width / 2, y);
                                }
                                renderCtx.fillStyle = captionPosition.color;
                                renderCtx.fillText(line, renderCanvas.width / 2, y);
                            });
                        }
                    }

                    function encodeAudioFrame(frameIdx) {
                        if (!audioEncoder || !audioData) return;
                        const resampleRatio = sourceSampleRate / targetSampleRate;
                        const leftChannel = new Float32Array(samplesPerFrame);
                        const rightChannel = new Float32Array(samplesPerFrame);
                        for (let j = 0; j < samplesPerFrame; j++) {
                            const srcIdx = Math.floor(audioSampleOffset + (j * resampleRatio));
                            leftChannel[j] = srcIdx < audioData.left.length ? audioData.left[srcIdx] : 0;
                            rightChannel[j] = srcIdx < audioData.right.length ? audioData.right[srcIdx] : 0;
                        }
                        const audioFrame = new AudioData({
                            format: 'f32-planar',
                            sampleRate: targetSampleRate,
                            numberOfFrames: samplesPerFrame,
                            numberOfChannels: 2,
                            timestamp: (frameIdx * 1_000_000) / fps,
                            data: new Float32Array([...leftChannel, ...rightChannel])
                        });
                        audioEncoder.encode(audioFrame);
                        audioFrame.close();
                        audioSampleOffset += Math.floor(samplesPerFrame * resampleRatio);
                    }

                    function onVideoFrame(now, metadata) {
                        // Not used directly - handled in loop below
                    }

                    // Reliable seek-per-frame capture with high quality settings
                    // requestVideoFrameCallback causes sync issues; precise seeking is more reliable
                    for (let i = 0; i < totalFrames; i++) {
                        sourceVideo.currentTime = vStart + (i / fps);
                        await new Promise(r => { sourceVideo.onseeked = r; });

                        // Draw video frame
                        if (removeWatermark) {
                            const scale = 1.1;
                            const sw = sourceVideo.videoWidth * scale;
                            const sh = sourceVideo.videoHeight * scale;
                            renderCtx.drawImage(sourceVideo, -(sw - renderCanvas.width) / 2, -(sh - renderCanvas.height) / 2, sw, sh);
                        } else {
                            renderCtx.drawImage(sourceVideo, 0, 0, renderCanvas.width, renderCanvas.height);
                        }
                        drawCaption();

                        const videoFrame = new VideoFrame(renderCanvas, {
                            timestamp: (i * 1_000_000) / fps
                        });
                        videoEncoder.encode(videoFrame, { keyFrame: i % 30 === 0 });
                        videoFrame.close();

                        encodeAudioFrame(i);

                        frameCount = i + 1;

                        const progressPercent = Math.round(((i + 1) / totalFrames) * 100);
                        progress.style.width = progressPercent + '%';
                        percentText.innerText = progressPercent + '%';

                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                    }
                } // end capture block

                statusText.innerText = 'Finalizing MP4...';
                await videoEncoder.flush();
                if (audioEncoder) await audioEncoder.flush();
                muxer.finalize();

                const buffer = muxer.target.buffer;
                const blob = new Blob([buffer], { type: 'video/mp4' });
                
                statusText.innerText = 'Download...';
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'TikTok_Clip.mp4';
                a.click();

                statusText.innerText = 'Done!';
                percentText.innerText = '100%';
                progress.style.width = '100%';
                
                setTimeout(() => {
                    status.classList.add('hidden');
                    exportBtn.disabled = false;
                }, 2000);

            } catch (e) {
                console.error('Error during l\'export:', e);
                statusText.innerText = 'Errore: ' + e.message;
                alert('Error during l\'export. Il tuo browser potrebbe non supportare questa funzionalitÃ . Prova con Chrome o Edge aggiornati.');
                percentText.innerText = '';
                setTimeout(() => status.classList.add('hidden'), 3000);
                exportBtn.disabled = false;
            }
        };

        document.getElementById('toggle-guide').onclick = () => {
            const g = document.getElementById('safe-guide');
            g.style.display = g.style.display === 'none' ? 'block' : 'none';
        };

        // ============================================
        // BULK VIDEO QUEUE SYSTEM
        // ============================================
        
        const MAX_QUEUE_SIZE = 20;
        let videoQueue = [];
        let currentQueueIndex = -1;

        function updateQueueUI() {
            const queueList = document.getElementById('queue-list');
            const queueCount = document.getElementById('queue-count');
            const exportCount = document.getElementById('export-count');
            const exportAllBtn = document.getElementById('export-all-btn');
            const prevBtn = document.getElementById('prev-video-btn');
            const nextBtn = document.getElementById('next-video-btn');
            const wrapper = document.getElementById('queue-list-wrapper');
            
            queueCount.innerText = `${videoQueue.length}/20`;
            exportCount.innerText = videoQueue.length;
            exportAllBtn.disabled = videoQueue.length === 0;
            wrapper.classList.toggle('hidden', videoQueue.length === 0);
            
            if (videoQueue.length === 0) {
                queueList.innerHTML = '<div class="text-center text-zinc-500 text-[10px] py-4">No videos in queue</div>';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                queueList.innerHTML = videoQueue.map((item, index) => `
                    <div class="queue-item ${index === currentQueueIndex ? 'active' : ''}" data-index="${index}" style="cursor:pointer;">
                        <div class="queue-item-info">
                            <div class="queue-item-caption">${index + 1}. ${item.caption || 'No text'}</div>
                            <div class="queue-item-meta">${item.duration.toFixed(1)}s â€¢ ${item.hasAudio ? 'With audio' : 'Video only'}</div>
                        </div>
                        <div class="queue-item-actions">
                            <button class="queue-item-btn delete-queue-item" data-index="${index}">
                                <i data-lucide="trash-2" class="w-3 h-3 text-red-400"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
                
                // Whole row is clickable
                document.querySelectorAll('.queue-item').forEach(row => {
                    row.onclick = (e) => {
                        if (!e.target.closest('.delete-queue-item')) {
                            loadQueueItem(parseInt(row.dataset.index));
                        }
                    };
                });
                
                document.querySelectorAll('.delete-queue-item').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        deleteQueueItem(parseInt(btn.dataset.index));
                    };
                });
                
                prevBtn.disabled = currentQueueIndex <= 0;
                nextBtn.disabled = currentQueueIndex >= videoQueue.length - 1;
            }
        }

        function captureCurrentState() {
            console.log('captureCurrentState called');
            console.log('videoFile:', videoFile);
            
            if (!videoFile) {
                alert('Load a video first!');
                return null;
            }

            try {
                const containerRect = videoContainer.getBoundingClientRect();
                const captionRect = captionElement.getBoundingClientRect();
                
                console.log('Container rect:', containerRect);
                console.log('Caption rect:', captionRect);

                const state = {
                    // Video data
                    videoFile: videoFile,
                    videoFileName: videoFile.name,
                    videoLibraryIndex: currentVideoIndex,
                    vStart: vStart,
                    vEnd: vEnd,
                    duration: vEnd - vStart,
                    
                    // Audio data
                    audioFile: audioFile,
                    audioFileName: audioFile ? audioFile.name : null,
                    audioLibraryIndex: currentAudioIndex,
                    aStart: aStart,
                    hasAudio: !!audioFile,
                    
                    // Caption data
                    caption: captionElement.innerText,
                    captionTopPx: captionRect.top - containerRect.top,
                    captionMaxWidthPx: captionElement.offsetWidth,
                    fontSize: parseInt(captionElement.style.fontSize || '12'),
                    textColor: captionElement.style.color || '#ffffff',
                    outlineColor: getComputedStyle(captionElement).getPropertyValue('--outline-color') || '#000000',
                    fontClass: captionElement.className,
                    hasOutline: captionElement.classList.contains('text-bold-outline'),
                    
                    // Settings
                    removeWatermark: removeWatermark,
                    
                    // Timestamp
                    timestamp: Date.now()
                };
                
                console.log('State created successfully:', state);
                return state;
                
            } catch (error) {
                console.error('Error in captureCurrentState:', error);
                alert('Errore nel catturare lo stato: ' + error.message);
                return null;
            }
        }

        function loadQueueItem(index) {
            if (index < 0 || index >= videoQueue.length) return;
            
            const item = videoQueue[index];
            currentQueueIndex = index;

            // Show SAVE button
            document.getElementById('save-queue-btn').classList.remove('hidden');
            document.getElementById('add-to-queue-btn').classList.add('hidden');
            syncTopSaveAdd(true);
            
            // Restore video
            if (item.videoFile) {
                videoFile = item.videoFile;
                currentVideoIndex = item.videoLibraryIndex || 0;
                video.src = URL.createObjectURL(item.videoFile);
                video.onloadedmetadata = () => {
                    videoDuration = video.duration;
                    vStart = item.vStart;
                    vEnd = item.vEnd;
                    updateTrimmers();
                    video.currentTime = vStart;
                };
                generateThumbnails(item.videoFile);
            }
            
            // Restore audio
            if (item.audioFile) {
                audioFile = item.audioFile;
                currentAudioIndex = item.audioLibraryIndex || -1;
                audio.src = URL.createObjectURL(item.audioFile);
                audio.onloadedmetadata = () => {
                    audioDuration = audio.duration;
                    aStart = item.aStart;
                    drawWaveform(item.audioFile);
                    updateTrimmers();
                };
                
                // Update selector
                const selector = document.getElementById('audio-selector');
                if (currentAudioIndex >= 0) {
                    selector.value = currentAudioIndex;
                }
            } else {
                audioFile = null;
                currentAudioIndex = -1;
                audio.src = '';
                document.getElementById('audio-selector').value = '';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // Restore caption
            captionElement.innerText = item.caption;
            document.getElementById('caption-input').value = item.caption;
            captionElement.style.fontSize = item.fontSize + 'px';
            document.getElementById('fs-val').innerText = item.fontSize + 'px';
            document.getElementById('font-size').value = item.fontSize;
            captionElement.style.color = item.textColor;
            document.getElementById('text-color').value = item.textColor;
            captionElement.style.setProperty('--outline-color', item.outlineColor);
            document.getElementById('outline-color').value = item.outlineColor;
            
            // Restore font
            const hasOutline = item.hasOutline;
            captionElement.className = item.fontClass;
            outlineEnabled = hasOutline;
            updateOutlineUI();
            
            // Update font buttons
            document.querySelectorAll('.font-btn').forEach(btn => {
                if (item.fontClass.includes(btn.dataset.font)) {
                    document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            });
            
            // Restore watermark setting
            removeWatermark = item.removeWatermark;
            const watermarkBtn = document.getElementById('toggle-watermark');
            if (removeWatermark) {
                video.style.transform = 'scale(1.1)';
                watermarkBtn.classList.add('active');
                watermarkBtn.innerHTML = '<i data-lucide="zoom-out" class="w-3.5 h-3.5"></i> Reset Zoom';
            } else {
                video.style.transform = 'scale(1)';
                watermarkBtn.classList.remove('active');
                watermarkBtn.innerHTML = '<i data-lucide="zoom-in" class="w-3.5 h-3.5"></i> Remove VEO';
            }
            lucide.createIcons();
            
            updateQueueUI();
        }

        function deleteQueueItem(index) {
            videoQueue.splice(index, 1);
            if (currentQueueIndex === index) {
                currentQueueIndex = -1;
            } else if (currentQueueIndex > index) {
                currentQueueIndex--;
            }
            updateQueueUI();
        }

        // Add to queue button
        document.getElementById('add-to-queue-btn').onclick = () => {
            console.log('Add to queue clicked');
            console.log('Current queue length:', videoQueue.length);
            console.log('Video file:', videoFile);
            
            if (videoQueue.length >= MAX_QUEUE_SIZE) {
                alert(`Puoi aggiungere massimo ${MAX_QUEUE_SIZE} video alla coda!`);
                return;
            }
            
            try {
                const state = captureCurrentState();
                console.log('Captured state:', state);
                
                if (!state) {
                    console.log('State is null, aborting');
                    return;
                }
                
                videoQueue.push(state);
                currentQueueIndex = videoQueue.length - 1;
                console.log('Video added to queue. New length:', videoQueue.length);
                
                // Show SAVE, hide ADD
                document.getElementById('save-queue-btn').classList.remove('hidden');
                document.getElementById('add-to-queue-btn').classList.add('hidden');
                syncTopSaveAdd(true);
                
                updateQueueUI();
                
                // Visual feedback
                const btn = document.getElementById('add-to-queue-btn');
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 100);
                
                // Success message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
                statusDiv.innerText = `âœ“ Video ${videoQueue.length} added to queue!`;
                document.body.appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 2000);
                
            } catch (error) {
                console.error('Error adding to queue:', error);
                alert('Error during l\'aggiunta alla coda: ' + error.message);
            }
        };

        // Save changes to existing queue item
        document.getElementById('save-queue-btn').onclick = () => {
            if (currentQueueIndex < 0 || currentQueueIndex >= videoQueue.length) return;
            const state = captureCurrentState();
            if (!state) return;
            videoQueue[currentQueueIndex] = state;
            updateQueueUI();
            const btn = document.getElementById('save-queue-btn');
            btn.style.background = '#16a34a';
            btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Saved!';
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Salva';
                lucide.createIcons();
            }, 1500);
        };

        // Navigation buttons
        document.getElementById('prev-video-btn').onclick = () => {
            if (currentQueueIndex > 0) {
                loadQueueItem(currentQueueIndex - 1);
            } else if (videoLibrary.length > 0 && currentVideoIndex > 0) {
                // Navigate to previous video in library
                loadVideoFromLibrary(currentVideoIndex - 1);
            }
        };

        document.getElementById('next-video-btn').onclick = () => {
            if (currentQueueIndex < videoQueue.length - 1) {
                loadQueueItem(currentQueueIndex + 1);
            } else if (videoLibrary.length > 0 && currentVideoIndex < videoLibrary.length - 1) {
                // Navigate to next video in library
                loadVideoFromLibrary(currentVideoIndex + 1);
                
                // Auto-select caption if available
                const randomBtn = document.getElementById('random-caption-btn');
                if (randomBtn) {
                    randomBtn.click();
                }
            }
        };

        // Auto-queue all videos button
        document.getElementById('auto-queue-btn').onclick = async () => {
            if (videoLibrary.length === 0) {
                alert('Load videos first!');
                return;
            }

            const autoQueueBtn = document.getElementById('auto-queue-btn');
            autoQueueBtn.disabled = true;
            autoQueueBtn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i> Loading...';
            lucide.createIcons();

            for (let i = 0; i < videoLibrary.length && videoQueue.length < MAX_QUEUE_SIZE; i++) {
                // Load video
                currentVideoIndex = i;
                videoFile = videoLibrary[i];
                
                // Wait for video to load
                video.src = URL.createObjectURL(videoFile);
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        videoDuration = video.duration;
                        vStart = 0;
                        vEnd = Math.min(videoDuration, 15);
                        updateTrimmers();
                        resolve();
                    };
                });

                // Assign a different audio to each video (rotating through library)
                if (audioLibrary.length > 0) {
                    const audioIdx = i % audioLibrary.length;
                    currentAudioIndex = audioIdx;
                    audioFile = audioLibrary[audioIdx];
                    audio.src = URL.createObjectURL(audioFile);
                    await new Promise(resolve => {
                        audio.onloadedmetadata = () => {
                            audioDuration = audio.duration;
                            aStart = 0;
                            updateTrimmers();
                            resolve();
                        };
                    });
                    document.getElementById('audio-selector').value = audioIdx;
                }

                // Generate random caption from all available categories (random category per video)
                const allCats = Object.keys(viralCaptions);
                const randomCat = allCats[Math.floor(Math.random() * allCats.length)];
                const captions = viralCaptions[randomCat];
                const randomCaption = captions[Math.floor(Math.random() * captions.length)];
                captionElement.innerText = randomCaption;
                document.getElementById('caption-input').value = randomCaption;

                // Add to queue
                const state = captureCurrentState();
                if (state) {
                    videoQueue.push(state);
                }

                // Small delay for UI update
                await new Promise(r => setTimeout(r, 100));
            }

            currentQueueIndex = videoQueue.length - 1;
            updateQueueUI();

            autoQueueBtn.disabled = false;
            autoQueueBtn.innerHTML = '<i data-lucide="zap" class="w-3 h-3"></i> Auto-Coda';
            lucide.createIcons();

            // Success notification
            const statusDiv = document.createElement('div');
            statusDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
            statusDiv.innerText = `âœ“ ${videoQueue.length} videos added to queue!`;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 3000);
        };

        // Initialize
        updateQueueUI();

        // ============================================
        // END BULK VIDEO QUEUE SYSTEM
        // ============================================

        // Viral Captions System - 18 Categories x 100 English Captions
        const viralCaptions = {
            happy: [
                "today is one of those days i never want to end","smiling for literally no reason and i love it","when life just decides to be good to you","this song is making me feel things","pure serotonin in audio form","i woke up and chose happiness","something good is coming, i can feel it","the kind of music that makes you smile alone","already in my best mood and it's barely morning","a perfect day? yeah this is it","i don't want this energy to ever go away","feeling invincible today and nobody can change that","no reason to be this happy but here we are","this song = pure joy, no notes","when everything just clicks","sun outside, this song, nothing else needed","the kind of day you want to bottle up","feeling light and i can't explain it","good vibes activated, nothing stopping me now","this is my summer anthem and i'm not sorry","something in my chest when this plays","when life smiles at you and you smile back","smiled for no reason at least 10 times today","this song is a warm hug for your ears","days like this i want forever","just feeling good and that's enough","this music makes me want to dance by myself","the kind of day you'll remember","when you're in a vibe and don't want to come down","happy to exist today honestly","this beat just saved my whole day","don't know where this good mood came from but keeping it","every time it plays something lights up inside me","today yes, tomorrow we'll see","this song is free serotonin","this one put a smile on my face instantly","when your mood is through the roof for no reason","life is beautiful when this is playing","i would literally dance in the middle of the street","an absurd amount of happiness today","the kind of quiet happiness that just feels right","when you realize you're actually okay and that's enough","this song is my peace","feeling like i'm in a good movie","you don't need much to be happy, just this song","the world seems better today","this music is pure joy","waking up and putting this on is a whole ritual","when you're happy and don't need reasons","this song and nothing else matters","days when the sun just gets inside you","makes me want to call everyone i love","good mood energy, catch it if you can","when you feel like things are going the right way","this song makes me feel at peace","i have an insane amount of energy today","i like the world more when this plays","a stupid but sincere smile","when music feels like home","this vibe is everything","no problems today, just this song","when you're in a state of grace","this is one of those songs that changes your whole day","good energy, join in","feeling like i'm in a movie montage","this song makes me dance with my eyes","when you're surrounded by good vibes","don't want this moment to end","the kind of happiness you want to keep in your pocket","this song is a hug","would collect days like this","makes me feel like anything is possible","the kind of good mood that spreads","this music makes me love being alive","today i chose to be okay","when the right song arrives at the right moment","recharges my soul","one of those magical days","this song is worth more than any vitamin","when everything feels in order","danced alone in the kitchen today","the smile you can't hide","this vibe carries me through the whole day","the kind of music that makes you skip steps","when you feel like you're building something good","this is pure happiness in one song","today i feel like the main character of a good story","a mood like this you hold onto tight","when you hear this you want to run","full good mood and i'm not apologizing","this song is my reset button","today i want everything","makes me want to do beautiful things","when you're in harmony with the world","this is my happy collab soundtrack","days like today every single day please","smiling even while writing this","this music is my drug (the good kind)"
            ],
            sad: [
                "some days weigh more than others","this song knows things i've never said out loud","put this on and i disappear into my thoughts","crying and not knowing why","days when silence is too loud","this one hit me where it hurts","not sad, just... tired","when you listen to a song and recognize yourself","some feelings are impossible to explain","i played this when i was struggling and still come back to it","when you miss yourself","the kind of beautiful and painful melancholy at once","this song understands what i can't say","when music does what words can't","makes me feel less alone in all of this","difficult moments have their own songs","when you cry and don't know where it comes from","listened to this too many times at night","the kind of sadness you can't explain","when you're tired of pretending everything is fine","this song is the soundtrack to a hard season","days when something is missing but you don't know what","when music hugs you because people can't","some nights need songs like this","this made me cry more than once","when you realize you've been carrying too much","the kind of solitude you choose","this song keeps me company when i don't want company","when you're broken and that's okay too","some songs you only listen to when you're hurting","this comes back to me in the hard moments","when sadness is elegant","the kind of night that lasts too long","this song is the things i never said","when you feel like you don't fit anywhere","some emotions only you understand and nobody gets it","i listen to this when i need to cry","when you miss people you love or they miss you","the kind of melancholy that keeps you up","this song knows how tired i am","when you regret but can't go back","some nights only pass like this","this song makes me feel everything at once","when you cry in the car thinking of nothing","the kind of sadness you don't want to share","this is the song for when you're not okay","when you need music that sits with you","some days you hold yourself together alone","this keeps me company on difficult nights","when you have everything and still feel empty","the kind of feeling without a name","i listen to this when i can't sleep","when something ends and you're not ready","some thoughts only come at night","this song is a quiet embrace","when you're processing something heavy","the kind of tears you don't cry in front of people","this hits me the same every single time","when you feel small in a big world","some moments of solitude are necessary","this is my favorite way to let go","when everything feels far from where you want to be","the kind of sadness that passes if you give it space","i listen to this when i don't know how to be","when you need to feel understood","some songs look right inside you","this made the tears fall without trying to stop them","when you miss someone you shouldn't still be missing","this song is my 3am","when you understand that being okay takes time","some pain is quiet but it's there","this walks with me through the dark","when you're grieving something that isn't dead","the kind of blues that keeps you company","this song is all the unshed tears","when you finally allow yourself to feel bad","some days you have no strength and that's okay","i listen to this and give myself permission to fall apart","when melancholy is bittersweet","the kind of music for when you're tired of being strong","this song understands my cracks","when something breaks inside you","some nights are longer than others","this makes me feel everything i avoid during the day","when sadness arrives without warning","this song is for the hard days","when you just want someone to understand","some moments you walk through alone","this song is my voice when i have no words","when you're at the bottom but still breathing","the kind of sadness you know well by now","this walked with me through a dark period","when you cry for the right reasons","this is everything i can't say out loud"
            ],
            dance: [
                "my body just decided on its own","this song makes you dance even when you don't want to","put this on and your legs just go","the kind of rhythm you can't ignore","this is the song that gets everyone up","when the beat gets in your bones","i can't dance but with this it doesn't matter","this came on and the room exploded","when you hear this you literally cannot stay still","the kind of music where you don't need to know how to dance","i put this on and everyone got up","when you dance without thinking","this song took control of my body","the rhythm that won't leave you alone","this is for kitchen dance parties at 2am","when the drop hits and you stop belonging to yourself","this song is a trap for your legs","the kind of beat that changes your mood in 2 seconds","i put this on and the whole night changed","when you dance alone and genuinely don't care","this is the song to play at full volume","the beat that keeps you on loop","when you hear this you have to dance, it's the law","this is my secret dance song","the kind of rhythm that moves even the shy ones","this made perfect strangers dance together","when the groove catches you with no warning","this song is illegal for non-dancers","the kind of music that makes you forget where you are","i played this at the party and it destroyed","when this comes on everyone hits the floor","this was born to make people move","the beat you didn't know you were waiting for","when this part comes on the whole room shifts energy","this song makes you want to do things","the kind of rhythm that becomes an obsession","everyone asked for this one after the party","when you dance and for a second you're someone else","this is the soundtrack to my best moves","the drop that makes you jump three steps","this song is pure energy and rhythm","when you hear this beat there's no other option","i put this on and people stopped talking","the kind of music that makes you forget your problems","this is for unplanned dance sessions","when the rhythm makes you do things you didn't know you could","this song is an excuse to move","the kind of beat that becomes addictive","played this 3 times in a row","when this part comes on you stop thinking","this is the song for when you need to let it all out through dancing","the perfect rhythm for forgetting everything","this song has the power to ruin chairs","when the body takes over from the brain","this is the track that changes nights","the kind of music you wait for the drop on","heard this and i was gone","when you dance and feel free","this song is pure rhythm","the beat that makes you do weird things with your neck","this is my current song for dance moments","when you hear this you literally cannot sit down","this is for people who dance badly but with everything they have","the kind of rhythm that gets in your head and stays","danced alone in my room at 11pm","when music takes command","this song is designed to make people dance","the drop you've been waiting for since the beginning","when this part comes on everyone turns around","this is the track that makes you fall in love with dancing","the rhythm that won't let you be at peace","this song literally abducts you","when you dance and think of nothing else","this is the song for your best dance moves","the kind of beat that makes you forget how tired you are","i put this on and someone started dancing alone","when you hear this rhythm you understand everything","this is the soundtrack to the nights","the kind of music that creates new energy","discovered this and can't stop","when the groove is so strong you can't resist","this song is a party all by itself","the rhythm that converts you to dancing","danced to this in the mirror at least 20 times","when you dance badly but with too much energy","this is the song you've been waiting for","the kind of beat that makes you question yourself","this song is the reason i work out","when this part comes on your body already knows what to do","this is for the dances nobody needs to see","the rhythm that moves you without thinking","this song is pure motor instinct","when the drop is so good you don't believe it","i put this on and woke up","the kind of music that makes you want to do everything"
            ],
            chill: [
                "this song is exactly what i needed","the kind of music for being okay without doing anything","i listen to this when i need to breathe","when you want to turn the world off for a bit","this song is a warm blanket","the mood: lying down, this song, nothing to do","this is my soundtrack for resting","when you finally stop and just breathe","this song knows how to be calm","the kind of vibe for sundays with no plans","put this on and immediately felt better","when you need music that doesn't ask anything of you","this song is peace","the kind of slow rhythm that rebalances you","this is for days when you just want to exist","when you're doing fine and don't need anything else","this song is my personal moment","the vibe for when you want nothing specific","i listen to this while staring out the window","when the day is over and you survived","this song gives you 3 minutes of pure peace","the kind of music for people who need a break","this is perfect for evenings at home","when you don't feel like talking to anyone","this song doesn't ask anything of you","the kind of vibe for slow mornings","put this on and time stopped","when you're in that place between awake and asleep","this song is my mental reset","the mood for aimless afternoons","this is my song for disconnecting","when you need quiet but beautiful music","this song is my refuge","the kind of chill you don't have to earn","i listen to this while doing nothing important","when you're in a vibe and don't want it to end","this song is a slow walk","the kind of music for people who live in quiet moments","this is perfect for starry nights","when you're doing fine alone","this song is my dose of calm","the vibe for couch evenings","put this on and forgot all the stress","when music makes you feel okay as you are","this song is for the necessary pauses","the kind of rhythm for people who want to slow down","this is the soundtrack to my quiet moment","when you want nothing and found the right song","this song is silence but with rhythm","the mood you look for on certain days","i listen to this when i want to be alone with myself","when your body asks you to be still","this song is exactly my kind of peace","the kind of music for cooking alone","this is for saturday mornings with no rush","when you're relaxed and the world can wait","this song is the one i'm always looking for","the vibe for moments of doing nothing","put this on and felt at home","when you need music that doesn't intrude","this song is for people who enjoy silence with sound","the kind of chill that recharges you","this is my favourite song to unwind to","when life slows down and you follow it","this song doesn't force anything","the mood: everything's fine, no rush","i listen to this while getting lost in good thoughts","when you hear this you don't need anything else","this song is the deep breath you were looking for","the kind of music for evening commutes home","this is for people who love being well without drama","when you want music that accompanies, not overwhelms","this song is low, beautiful, and that's it","the vibe for in-between moments","discovered this and now it's my go-to chill","when you hear this you can stop running","this song is my sonic coffee break","the kind of calm you can actually listen to","this is for grey days that are somehow okay","when music makes you feel somewhere safe","this song asks nothing, just gives you peace","the mood for people who are fine without anything happening","i listen to this before sleeping","when you're okay and the music knows it","this song is your quiet corner","the vibe for weekends without plans","this is the song for people who've learned to be with themselves","when you just want to exist and nothing more","this song is the quiet you were looking for","the kind of music for your moment of pause"
            ],
            love: [
                "this song makes me want to send it to someone","the kind of music that makes you think of them","listening to this and all my thoughts go to you","when a song says everything you can't","this is the soundtrack to falling for you","makes me want to call you for no reason","this song is everything i feel but can't express","the kind of track you send without writing anything","listened to this thinking of you for hours","when music understands your heart better than you do","this song is a love letter disguised as a song","the kind of feeling you get when you hear this","this makes me want to be with you","when you listen to a song and think of only one person","this is exactly how i feel when you're around","makes me think of you in an unreasonable way","this song is what i can't say to your face","the kind of emotion that hits when you love someone","sent this with no caption and you understood","when your heartbeat syncs with a song","this should be our song, or at least it feels like it","gives me chills and it's not just the music","this song is about us and nobody knows","the kind of love this song describes","listening to this and missing you","when you're in love and every song is about them","this makes me think about all the good things between us","the kind of feeling that lasts","this song is my love on vinyl","makes me want to hold your hand","this is for people quietly in love with someone","when a song reminds you why you fell","listening to this when i miss you","the kind of music for people who found the right person","this song is our story","makes me want to do something romantic","when you hear this and you know exactly who you're thinking of","this is the song that made me realize i loved you","the kind of emotion that doesn't fade","put this on and thought only of you","when love is quiet but it's there","this song is for people who fill you up","makes me want to be with you right now","this is the song for the good moments with you","when you hear this and your heart does something strange","this song is what i feel but don't say","the kind of love that changes songs","listening to this and smiling for reasons you know","when you're in love and music reminds you","this is the soundtrack to my feelings","makes me think of everything beautiful about you","this song knows us","the kind of feeling that comes from inside","this is for loving someone who doesn't know","when you listen and wish they were with you","this song is my heart talking","makes me want to send you a ridiculous message","this is for the people you love and you know it","when music describes exactly what you feel","this song is everything i feel for you","the kind of love this music brings out","put this on when i was missing you","when you're in love and everything reminds you of them","this is the song i'd want you to hear","makes me want to hug you","this song is love in its best form","the kind of emotion you can't hold back","i listen to this when i want to feel in love","when a song perfectly describes your feeling","this is for people living something beautiful","makes me believe love is real","this song is the moments i don't forget","the kind of love that doesn't leave","this is the soundtrack to when i met you","when you hear this and want to send it to that person","this song is a love letter without words","makes me want to let you know i care","this is the song for our good moments","when love is exactly this","this song makes me think of every reason i love you","the kind of emotion that music surfaces","i listen to this when i need to feel loved","when a song reminds you why loving is worth it","this is for people who found their person","makes me want to tell you everything","this song is love in sonic form","the kind of romantic feeling that doesn't expire","this is the song that describes us better than anything"
            ],
            pov: [
                "pov: you're living in my head rent free","pov: thinking about that person at 2am","pov: terrible day but you found this song","pov: driving alone at night and everything is perfect","pov: finally going toward what you actually want","pov: you woke up and for once you're okay","pov: you let go of something that was weighing on you","pov: building the best version of yourself","pov: you're in the moment right before everything changes","pov: your playlist gets you better than people do","pov: walking and the city feels like yours","pov: it's summer and everything is ahead of you","pov: realizing you're actually good alone","pov: about to do something brave","pov: you're your favourite character right now","pov: life finally makes sense","pov: living your own personal film","pov: decided to stop caring about it","pov: you're in your glow up and you can feel it","pov: this song is your sonic signature","pov: coming home after a long time away","pov: you figured out who you actually are","pov: living your best moment without even knowing it","pov: stopped waiting for permission","pov: in your corner of the world and everything's fine","pov: rough day but this song saved it","pov: about to start something new","pov: found your song of the year","pov: exactly where you're supposed to be","pov: becoming the person you always wanted to be","pov: finally stopped apologizing for who you are","pov: watching out the window with this playing","pov: you're the main character of your own story","pov: did something you're proud of","pov: dancing alone and genuinely don't care","pov: life looks like a good film right now","pov: chose yourself for once","pov: living one of those moments you'll remember","pov: found your rhythm in life","pov: at peace with yourself","pov: going through something and actually handling it","pov: this song describes you perfectly","pov: starting your best chapter","pov: in the moment of transition between before and after","pov: stopped caring what people think","pov: living exactly how you want","pov: feeling unstoppable for the first time in a while","pov: in your state of grace","pov: about to do the most courageous thing of your life","pov: finally figured out what you want","pov: heading home and life is good","pov: in your best era","pov: let go of what wasn't serving you","pov: building something that matters","pov: woke up with this song in your head","pov: somewhere safe and you can breathe","pov: about to change everything for the better","pov: this song is your moment","pov: chose courage over fear","pov: living your quiet dream","pov: in your moment of maximum self","pov: finally stopped waiting","pov: looking back and understanding why it all happened","pov: in your personal glow up era","pov: found the song that represents you","pov: about to start the best part","pov: in the middle of your most beautiful story","pov: decided that's enough of the excuses","pov: living slow and well","pov: this song is your powerful quiet moment","pov: exactly where you need to be","pov: becoming who you wanted to be as a kid","pov: finally in control of your life","pov: getting through everything with this song","pov: in your new chapter","pov: let it go and now you can breathe","pov: about to make the right move","pov: in the most beautiful season of your life","pov: everything is ahead and you know it","pov: living the moment you were waiting for","pov: in your flow and nobody can stop you","pov: learned from everything and moving forward","pov: writing your best story","pov: right place, right moment","pov: chose to be okay and it's working","pov: building the life you want","pov: in your golden era","pov: this song is your personal soundtrack","pov: stopped limiting yourself","pov: about to do something important for you","pov: fully yourself with no apologies","pov: living every second of this song","pov: found your rhythm in life"
            ],
            gym: [
                "this song on the 4th set when you want to quit","the kind of track that gets you 2 more reps","this got me through a workout i didn't want to do","put this on and suddenly had energy","this is my most effective pre-workout","the rhythm that makes you forget the burn","hear this and my legs just go","when you're about to quit and the drop hits","this song is my fuel in the gym","the kind of music that makes time disappear","this is for the last set when you're falling apart","when the beat gives you strength you didn't think you had","this saved more than one workout","the kind of rhythm for people who train alone","this is my song for the hard moments","when you're suffering but the music carries you","this is the soundtrack to progress","the kind of track that makes you feel unstoppable","put this on and hit my personal best","when music is the only thing keeping you going","this song is the energy i was looking for","the kind of beat for people who don't give up","this is for days when you don't want to train but do it anyway","when you hear this you know the workout will be tough","this song is my gym partner","the kind of music that makes you push past yourself","i listen to this and stop feeling the muscles burn","when the rhythm syncs with your reps","this is for people who train in silence and let results speak","the kind of track that makes you push harder","this song is my extra strength","when you want to quit everything and then this comes on","this is the final sprint song","the beat that keeps you going when you can't","put this on and finished my workout smiling","when music is the only coach that gets you","this song is pure motivation in sonic form","the kind of rhythm for quiet warriors","this is for 6am workouts","when you're building something physical and mental","this song gives me the charge i don't have","the kind of beat that makes you want to sweat","i listen to this when i have to do the hard things","when the drop hits during the last set","this is my song for not quitting","the kind of music for people who train for themselves, not others","this song is the difference between mediocre and great","when you hear this your body understands","this is for the slow but steady progress","the kind of rhythm that gives you no rest","this song is my second wind","when you're about to give up and music says no","put this on and broke my limit","the kind of track for people who know what results cost","this is the song for maximum effort moments","when the beat reminds you why you started","this song is the invisible workout","the kind of music for people who sacrifice every day","i listen to this and remember my goal","when the pain is sweet because you know where you're going","this is for warriors that nobody sees","the kind of rhythm that builds champions","this song is the motivation that doesn't expire","when you hear this you know you can do more","this is my song for the tough gym days","the kind of beat that leaves you no excuses","put this on in my hardest workout and won","when music does what pre-workouts can't","this song is pure survival instinct in sport form","the kind of rhythm for people who know what they want","this is for people who train when nobody's watching","when you hear this beat you enter the zone","this song is why i don't skip training","the kind of music that makes small people great","i listen to this to remember who i want to become","when the body quits but the mind doesn't, this song","this is my secret weapon in training","the kind of beat for sessions that actually matter","this song is the difference between stopping and going","when you're doing hard things for better things","this is for the athlete inside you that you can't see","the kind of rhythm that feeds ambition","this song is my workouts in one track","when every drop of sweat is worth it","this is for people building something every day","the kind of music for people without excuses","this song is my push when i have nothing left","when you finish a workout to this you know you gave everything"
            ],
            energy: [
                "this song reignited something in me","the kind of beat that makes you take the stairs two at a time","this is for when you need instant energy","when this comes on your mood flips 180 degrees","this song is an electric shock","the kind of music that won't let you sit still","put this on and just went","when the drop hits and you go with it","this is the song for when you want to do everything","the beat that wakes you up even on monday morning","this song is pure fuel","when you hear this and your body activates on its own","this is for the days when you're in GO mode","the kind of energy this song carries","listened to this and did 3 things i'd been putting off","when music gives you the push you couldn't find elsewhere","this song is adrenaline in sonic form","the kind of rhythm that shows no mercy","this is my song for when i need to be at 100%","when you have zero energy and then you put this on","this song wakes something up","the kind of beat for when you need to go hard","this is for days when you're in beast mode","when you hear that drop you know it's the moment","this song is my energy upgrade","the kind of music that makes you forget you're tired","put this on and became a different person","when the beat is so powerful you can't ignore it","this is the song for impossible missions","the kind of explosive energy you were looking for","this song leaves you no excuses","when you hear this you're ready for anything","this is for the moments when you need to be focused","the kind of rhythm that makes you want to run","this song is a concentrated dose of power","when music becomes your fuel","this is my song for doing the big things","the kind of beat that activates warrior mode","listened to this before doing something brave","when you hear this and know you can do it","this song is raw energy without filters","the kind of music for people who don't stop","this is for days when history is being made","when the drop gives you what you were looking for","this song has the power to change your whole mood","the kind of rhythm for people who don't quit","put this on when i needed everything","when music does what coffee can't","this is the song for turning point moments","the kind of radioactive energy in this song","i listen to this when i need to be unstoppable","when you hear this beat you enter the zone of fire","this song is the sound of unlimited potential","the kind of music for people doing impossible things","this is for the moments when you need to explode","when the song becomes part of your strength","this song is my maximum charge","the kind of beat that leaves no room for excuses","listened to this and did what i was afraid to do","when you hear this you know today is the day","this is the song for people who don't know limits","the kind of energy this music injects","put this on and went full throttle","when the rhythm is so good you become invincible","this song is your second wind","the kind of beat for everyday warriors","this is for days when you give everything","when music reminds you what you're capable of","this song is power, speed, and fire","the kind of rhythm for people who want to break things open","listened to this and pushed past my limit","when the drop is so powerful it lifts you off the ground","this is the song for moments that matter","the kind of inexhaustible energy in this beat","put this on and did things i didn't think possible","when you hear this you have everything you need","this song is the controlled explosion you were looking for","the kind of music for people writing their own story","this is for days when you're at your maximum potential","when music becomes a force of nature","this song is my state of maximum power"
            ],
            party: [
                "this song started the party all by itself","the kind of track that gets everyone up in 3 seconds","put this on and the whole night became something else","when you hear this at a party and go into a trance","this is the song everyone was waiting for without knowing","the rhythm that turns anywhere into a club","the dj played this and we lost it","when this comes on everyone stops talking and starts moving","this song is the secret to great nights","the kind of beat that gets even shy people dancing","this is our song of the summer","when you hear it and know the night is finally really starting","this song made perfect strangers dance together","the kind of energy that builds when this track drops","this came on and the room changed frequency","when the dj plays this you know he's the best","this song is the excuse to do things","the kind of rhythm that unites everyone on the floor","this got requested 4 times in a row","when everyone starts singing along without knowing the words","this is the song of the night, full stop","the kind of moment you'll remember in 10 years","this came on and nobody stayed seated","when music creates that collective energy","this song makes you want to be around people","the kind of beat for nights that last till dawn","heard this at the party and searched it for a week","when you hear this and life is good","this is the soundtrack to the best nights","the rhythm that turns strangers into best friends","this song is the party that never ends","when you hear it outside and it takes you back to that night","this is for nights you don't forget","the kind of music that makes you want to stay up","someone put this on and saved the whole night","when the beat is so good you can't stand still","this song is collective energy","the kind of rhythm that makes you want to hug everyone","this is the song for epic moments","when everyone sings together without coordinating","this song makes you forget everything else","the kind of beat that makes nights go longer","everyone danced to this, even the people who don't dance","when music becomes the memory of a special night","this is for nights when everything happens","the kind of song that ends and there's silence and then everyone screams","heard this for the first time at a party and it's been in my head since","when you hear this you know you're in the right place","this song is the recipe for the perfect night","the kind of rhythm for endless nights","this is the song that gives you goosebumps from the rhythm alone","when everyone starts dancing at the exact same moment","this song is cohesion in sonic form","the kind of music that creates collective memory","danced to this with strangers and we felt like lifelong friends","the night was ending but this made it start all over again","this is the weekend song","the kind of energy that only happens at night with the right people","this came on at the perfect moment and everything froze","when the rhythm hits and everyone synchronizes","this song is the reason you go out","the kind of beat that makes you want to scream with joy","heard this and knew the night was about to become legendary","when you hear this you remember why you love live music","this is the song everyone wants but doesn't know the name of","the kind of night this song describes perfectly","this is for nights you remember for years","when music and the right people combine","this song is the best night condensed in one track","the kind of rhythm that makes you want more","danced to this and felt invincible","when you hear this and life makes sense","this is the song for moments of pure collective joy","the kind of beat for people who love the night","this came on and the place was unrecognizable","when everyone sings the same song without agreeing beforehand","this song is the glue of the night","the kind of rhythm for perfect nights","this is for people who appreciate real nights out","when music makes everyone feel part of something","this song is the night everyone has been waiting for"
            ],
            viral: [
                "this song is everywhere and i get why","the kind of track you hear and have to find immediately","this went viral for a reason","when you hear this for the first time and already know it's going to explode","this song is taking over everyone","the kind of rhythm that ends up in every reel","this is the moment song and it's not a coincidence","when everyone uses it and it still makes sense","this song hit something universal","the kind of beat you recognize instantly","this is the song you see everywhere and it never gets old","when a song captures the zeitgeist perfectly","this song became a movement","the kind of track that becomes culture","this is in everyone's head right now","when you hear this and understand why it works","this song has something the others don't","the kind of rhythm that becomes a meme in the best way","this is the song everyone's using and they're right","when a song is everywhere and you love it","this song has the magic touch of going viral","the kind of music that crosses generations","this started and it won't stop","when you understand why everyone is talking about it","this song is the cultural moment we've been waiting for","the kind of beat that makes trends","this is the anthem of the moment and it always will be","when you hear this you want to share it immediately","this song has the right formula","the kind of rhythm that makes people react","this is the soundtrack to this specific moment in history","when a song captures something real","this song is everywhere because it deserves to be","the kind of music that creates conversations","this is the song people will remember this year for","when the viral is 100% justified","this song did something to everyone","the kind of beat that becomes an involuntary anthem","this started and i can't stop playing it","when everyone uses the same song and it never gets boring","this song touches something common to all of us","the kind of rhythm that knows what people want","this is the song you hear out of nowhere and it stops you","when a track becomes pop culture instantly","this song is the phenomenon of the moment","the kind of music that needs no explanation","this has entered the collective culture permanently","when you hear this you understand the power of music","this song is the answer to something i didn't know i was looking for","the kind of beat you recognize from 2 notes","this is everyone's song now","when a track crosses genres and generations","this song is everywhere and that's a good thing","the kind of rhythm that triggers something in everyone","this is the viral song but for the right reasons","when everyone sings it and you already knew it before","this song is the moment we were living in sonic form","the kind of music that makes you understand why tiktok exists","this started and it was written in its dna","when you hear this you understand what impact means","this song created its own universe","the kind of beat that makes you want to dance and cry at the same time","this is the song that stopped being just music","when a track becomes part of how you tell this period","this song is the perfect product of this moment","the kind of rhythm that scales globally","this is the song that defined this season","when everyone knows it and loves it and it doesn't get enough credit","this song is pure human connection","the kind of music that goes beyond platforms","this started on reels and ended up in hearts","when you hear this you want to send it to everyone","this song has an effect nobody can explain","the kind of beat that exists for sharing","this is the moment song and also tomorrow's","when a track captures something eternal disguised as viral","this song is the phenomenon that never gets old","the kind of rhythm that stays after the trend passes","this is for people who love music that does real things","when you hear this you can't not share it","this song is the secret of this period","the kind of music that makes history while you're living it","this is the song everyone has heard but never forgets"
            ],
            beauty: [
                "this song is the soundtrack to my getting ready","the kind of music for when you're getting yourself together","i listen to this while doing my makeup and become someone else","put this on and the makeup just comes out better","this song is my beauty ritual","the kind of rhythm for mornings in front of the mirror","this is my song for feeling beautiful","when you hear this and taking care of yourself feels magical","this song is my skincare moment","the kind of music for beauty rituals","this is the soundtrack to my self care","when this comes on i feel ready for anything","this song is for when you love yourself","the kind of beat for moments of care","i listen to this while getting ready and everything changes","when music turns getting ready into something special","this song is my ode to taking care","the kind of rhythm for people who know their worth","this is the song for moments when you feel your best","when you hear this and realize beauty is a mindset","this song is for everyday care rituals","the kind of music for people who treat themselves well","i listen to this in front of the mirror and like myself more","when music makes you feel more like yourself","this is the song for my daily moment of peace","the kind of beat for people who invest in themselves","this song is my moment that's just mine","when you take care of yourself with this music on","this is for the moments when you're proud of yourself","the kind of rhythm for days when you feel your best","this song is the soundtrack to my glow up","when you hear this and feel unstoppable in the mirror","this is for people who know self care is an act of love","the kind of music for self care evenings","i listen to this and remember i'm worth it","when beauty becomes your meditative moment","this song is for people who treat themselves the way they deserve","the kind of rhythm for rituals that recharge you","this is my song for starting the day right","when getting ready becomes a celebration","this song is my self care manifesto","the kind of music that makes you feel okay with yourself","i listen to this and feel comfortable in my own skin","when music amplifies your beauty moment","this is for people who know looking good starts with feeling good","the kind of beat for sacred self care moments","this song is my daily safe space","when you hear this and the outside world doesn't exist","this is the song for my favourite rituals","the kind of rhythm for people who always put themselves first","i listen to this and stop being critical of myself","when music reminds you how special you are","this song is for moments of personal grace","the kind of music for evenings when you pamper yourself","this is the soundtrack to my love for myself","when you hear this you feel worthy of everything beautiful","this song is my self love anthem","the kind of beat for people who know care equals love","i listen to this and feel beautiful without filters","when music transforms routine into ritual","this is for moments when you feel in harmony","the kind of rhythm for people who accept themselves","this song is my moment of connection with myself","when you hear this you remember to take care of yourself","this is the song for my most authentic moments","the kind of music for people who love themselves deeply","i listen to this and it's just me and myself","when beauty becomes your meditation","this song is for rituals that make you feel good","the kind of beat for evenings when you love yourself a lot","this is my song for moments of total care","when you hear this you know you're investing in yourself","this song is the sound of my self care","the kind of rhythm for people who know wellbeing is a priority","i listen to this and like myself for who i am","when music amplifies the love you have for yourself","this is for people who believe taking care is revolutionary","the kind of music for moments of pure self-acceptance","this song is my moment of being me","when you hear this and finally feel good in your own skin","this is the soundtrack of someone who truly loves themselves"
            ],
            sensual: [
                "this song is dangerously smooth","the kind of rhythm that lowers voices","this sends a clear signal without words","put this on and the air changes","this song is pure tension","the kind of beat that slows everything down","i listen to this and become a different person","when you hear this and want to get closer","this song knows things","the kind of music that says everything without saying anything","this is the song for the right moment","when the rhythm hypnotizes you slowly","this song is a silent invitation","the kind of beat that creates atmosphere alone","put this on and the room changed","when you hear this and time slows down","this is for moments of maximum intensity","the kind of rhythm that needs no words","this song is magnetism in sonic form","when music becomes the protagonist of the moment","this is the song that says without saying","the kind of beat for evenings with the lights low","i listen to this and get lost","when the groove is so good it bewitches you","this song is what happens between the lines","the kind of music for slow burning moments","this is the soundtrack to beautiful tension","when you hear this and can't ignore it","this song is the musical version of attraction","the kind of rhythm that slows your breathing","this is for moments that don't get shared","when music becomes complicity","this song knows how to create a private universe","the kind of beat that makes you want to get closer","i listen to this when i want to feel you near","when the rhythm is so beautiful it enchants you","this is the song for intense moments","the kind of music that creates sensory memory","this is beautiful and dangerous at the same time","when you hear this and lose the thread","this song is controlled electricity","the kind of beat for silent but charged nights","put this on and we stopped talking","when music becomes total atmosphere","this is for moments when words are too much","the kind of rhythm that gives you the good kind of chills","this song is a game","when you hear this you already know how the evening ends","this is the song for untellable moments","the kind of music that gets you from the inside","i listen to this when i want to feel everything","when the groove catches you and won't let go","this song is pure sensation","the kind of beat that lowers your guard","this is for people who love things that are intense and beautiful","when music says what you want to say","this song is a private code","the kind of rhythm for suspended moments","put this on and the moment became perfect","when you hear this and feel desirable","this is the song that creates the right atmosphere","the kind of music for moments of maximum connection","i listen to this when i want to forget everything else","when the beat is so soft you wrap yourself in it","this song is for moments of intense beauty","the kind of rhythm that speaks to the skin","this is the soundtrack to moments you don't forget","when you hear this and you're completely present","this song is the fire that burns slow","the kind of beat for unspoken things","listened to this with someone and now it's tied to them","when music becomes a physical presence","this is for moments when everything else disappears","the kind of rhythm that doesn't ask permission","this song is hypnotic and intentional","when you hear this you want to live it fully","this is the song for moments of maximum intensity","the kind of music you feel on your skin","i listen to this and feel at the center of something","when the groove creates something between people","this song is the kind of beauty you can't explain"
            ],
            savage: [
                "not sorry, i'm doing great actually","the kind of energy for when you're done being nice","this song is for when your patience ran out","when you stopped apologizing for existing","this is the soundtrack to not caring anymore","the kind of rhythm for people who don't go back","i listen to this when i need to remember my worth","when you've reached the point of no return","this song is for people who learned to let the wrong ones go","the kind of music for moments of brutal clarity","this is my song for when i'm done","when you stopped waiting for someone else to value you","this song is my response to all the nonsense","the kind of rhythm for people who don't bow their heads anymore","put this on when i realized i didn't need them","when you stop being available for people who don't deserve it","this song is for people who learned to say no","the kind of energy for when you have your head clear","this is the soundtrack to my era with no excuses","when you decide enough is enough","this song is for people who don't ask permission to shine","the kind of rhythm for moments of personal power","i listen to this when i need to remember who i am","when you stopped making yourself small so others feel big","this is my song for moments of self-respect","the kind of music for people who've learned their limits","this is for people who stopped being a doormat","when you realize your value and nobody can take it away","this song is the signature of my independence","the kind of beat for people who don't get walked on","put this on when i stopped tolerating it","when you have more strength than you thought","this is the song for the moment you say no and mean it","the kind of rhythm for people who found their backbone","i listen to this when i have to do difficult but necessary things","when you understand you were giving too much to the wrong people","this song is for people who have no more time to waste","the kind of music for people who know they've changed for the better","this is the soundtrack to my glow up","when you stopped justifying yourself to people who'll never get it","this song is personal power in sonic form","the kind of rhythm for turning point moments","put this on after the last time i said yes when i meant no","when your energy is too precious to waste","this is the song for people who learned their value","the kind of music for moments when you come first","i listen to this and remember i don't need validation","when you stopped shrinking to make others feel taller","this song is for people who don't turn down their volume for anyone","the kind of beat for people who found their strength","this is my answer to every no i got unfairly","when you decide to stop playing small","this song is for people who finally put themselves first","the kind of rhythm for people who respect themselves","put this on when i stopped loving myself less than i deserved","when you understand your peace is worth more than any toxic relationship","this is the song for moments of maximum self-awareness","the kind of music for people who learned that refusing is okay","this is for people who stopped being responsible for everyone else's problems","when you realize you don't have to prove anything to anyone","this song is the energy of someone who knows what they want and can say no","the kind of beat for people who've learned from everything","i listen to this when i want to feel whole and without regrets","when you have the courage to be exactly who you are","this is the soundtrack of someone who took themselves back","the kind of rhythm for people who are no longer available for one more chance","this song is for people who chose themselves for good","when you stop explaining and start doing","this is my song for moments when i'm unapologetically myself","the kind of music for people who learned that respect isn't asked for, it's established"
            ],
            aesthetic: [
                "this song is my mood board in sonic form","the kind of music that becomes your personal signature","this is exactly my vibe","when a song captures your essence","this is the soundtrack to my aesthetic universe","the kind of rhythm that defines a style","i listen to this and feel like my character","when music becomes your identity","this song is the sound of my aesthetic","the kind of beat that matches your look","this is the song of my aesthetic","when you hear this and think of your tumblr posts from 5 years ago","this song is the film in my head","the kind of music that becomes the signature of your era","i listen to this and visualize my life the way i want it","when a song is so yours it feels made for you","this is the sound i'm always looking for","the kind of rhythm that matches the golden light","this song is my way of existing","when music and your identity merge","this is the soundtrack to my most me moments","the kind of beat for people who've curated their vibe","i listen to this and feel in my own world","when you hear this and your personal aesthetic makes sense","this song is for people who live with intention","the kind of music for the cinematic moments of your life","this is the track for my golden afternoons","when a song captures your aesthetic mood perfectly","this song is the sound of someone who knows who they are","the kind of rhythm for collectors of beautiful moments","i listen to this while watching the rain through the window","when music becomes part of your visual world","this is for the curators of experiences","the kind of beat that matches the photos you never post","this song is the colour of my day","when you hear this you see sequences of beautiful life","this is my song for aesthetic moments","the kind of music for people who live slowly and with style","i listen to this and imagine the best version of myself","when a song is so consistent with you it's almost scary","this song is your visual manifesto in audio","the kind of rhythm for photographic moments in life","this is for people who curated their energy before it was a trend","when you hear this you understand what vibe means","this song is the aesthetic i try to live","the kind of beat for moments of maximum sensory awareness","i listen to this while getting lost in something beautiful","when music becomes the perfect backdrop to your life","this is the soundtrack to my golden hours","the kind of rhythm that becomes your personal brand","this song is for people who curate their universe","when you hear this your identity has an audio track","this is my song for moments of daily beauty","the kind of music for moments when you feel in your own story","i listen to this and feel exactly how i want to feel","when a song describes your mood without using words","this song is the audio of my favourite aesthetic","the kind of beat for slow and beautiful afternoons","this is for people who collect moments over things","when you hear this your aesthetic sense vibrates","this song is the sound of my lifestyle","the kind of rhythm for moments of visual quiet","i listen to this when i want to be in my own dimension","when music captures what photos can't","this is the soundtrack to my life the way i want it to be","the kind of beat for moments of pure personal expression","this song is my sonic signature","when you hear this you've finally found your sound","this is for people who live with care and intention","the kind of music that becomes part of you without you noticing","i listen to this and feel in my element","when a song is so consistent with who you are it feels like magic","this song is your inner world making sound"
            ],
            relatable: [
                "why does this song know everything about me","the kind of track that looks you in the eye","this is literally the soundtrack to my life","when you listen to a song and think wait, are you talking about me","this song exposed me","the kind of lyrics that seem written from your diary","this is the song of my exact moment","when music is too precise to be a coincidence","this song understands me better than i understand myself","the kind of track that makes you want to respond to the lyrics","this is my situation in one song","when you hear something and think wait that's me","this song said out loud what i couldn't even think","the kind of music for people who always feel slightly out of place","this is the song for everyone who recognizes themselves","when music describes your internal breakdown with precision","this is the soundtrack to all my overthinking","the kind of track for chronic overthinkers","this song saw me without me asking it to","when you hear this and think but how did it know","this is exactly how i've been feeling lately","the kind of music for people who feel too much","this said the things i'd had in my head for months","when a song articulates what you can't articulate","this is for all the feelings that aren't mine anymore","the kind of track that makes you do that recognition grimace","this song is my internal monologue","when music is your unasked spokesperson","this is the song for people who often feel misunderstood","the kind of lyrics that seem written by someone who knows you","this song made me want to send it to everyone","when something describes your experience so well it's almost scary","this is for the people who nod along while listening","the kind of track for people who overthink everything","this song is my life blended into 3 minutes","when you hear this and for once someone gets it","this is exactly my vibe in this period","the kind of music for moments of total recognition","this said what i would never have known how to say","when a song captures human experience with precision","this song is for everyone who feels this way","the kind of track that makes you laugh and cry at the same time","this is the soundtrack to my internal chaos","when you hear this and think finally someone said it","this is for the moments when a song is watching you","the kind of music for people with emotions too complex to explain","this song is my exact feeling","when music makes you feel less alone in your way of being","this is for the people who nod with their whole body while listening","the kind of track for people who recognize themselves in everything","this song did what no therapist has done","when you hear this and want to send it to everyone you care about","this is exactly how i feel and i didn't know how to say it","the kind of music for moments of sonic epiphany","i listen to this and think yes, exactly, this","when a song talks about you without knowing you","this song is my unwritten confession","the kind of track that makes you want to share it with everyone","this is for everyone who thinks there might be something wrong with them","when you hear this and finally feel normal","this song is universally personal","the kind of music for people who never felt quite understood enough","this said everything i'd been avoiding thinking","when music becomes your voice","this is for people who recognize themselves in songs more than in real life","the kind of track for people who feel everything too intensely","this song is my moment of finally being seen","when you hear this and for once you're not alone in your way of being","this is the song for everyone who recognized themselves"
            ],
            dreamy: [
                "this song takes me somewhere else","the kind of music for when you want to be elsewhere","this is the soundtrack to my most beautiful dreams","when you hear this the real world disappears","this song is a place that doesn't exist but i'd visit","the kind of slow rhythm for daydream afternoons","i listen to this and imagine a different life","when music creates parallel worlds","this song is my imaginary safe space","the kind of beat for mental travel","this is the track for my lucid dreams","when you hear this you're somewhere between here and elsewhere","this song is pure fantasy in sonic form","the kind of music for aimless nocturnal drives","i listen to this when i want to inhabit another dimension","when sound becomes a landscape","this is the song for my imaginary golden afternoons","the kind of rhythm for people who live on dreams big and small","this song is my personal cinema","when you hear this and reality gets soft","this is for moments of gentle escape","the kind of beat that opens portals","i listen to this and float","when music takes you to another season","this song is sunrise in a place i've never been","the kind of rhythm for chronic dreamers","this is the soundtrack to parallel lives","when you hear this and you're travelling without moving","this song is the night sky in sonic form","the kind of music for moments of contemplation","i listen to this when i want to leave without getting up","when music becomes a waking dream","this is for people who live in their own head a lot","the kind of beat for moments of pure escape","this song is the place i retreat to","when you hear this and time stretches","this is the track of my freest thoughts","the kind of rhythm for people who love getting lost","i listen to this and visualize worlds i've never seen","when music is so beautiful it becomes a place","this song is my favourite place that doesn't exist","the kind of music for the suspended hours of night","this is for moments when you're between multiple things at once","when you hear this and your mind wanders freely","this song is my personal sci-fi","the kind of beat for weightless afternoons","i listen to this when i want clouds","when music creates internal landscapes","this is the soundtrack to my most beautiful fantasies","the kind of rhythm for people who feed on dreams","this song is a place to go without going anywhere","when you hear this and you're simultaneously here and elsewhere","this is for moments of gentle fading from reality","the kind of beat for people who live in their own visions","i listen to this when i want to inhabit my imagination","when music is so dreamlike you can barely hear it","this song is the sound of what could be","the kind of rhythm for wandering dreamers","this is the track for my moments of deep peace","when you hear this you understand what floating means","this song is a miniature universe","the kind of music for moments between sleep and waking","i listen to this and think about all the lives i'll never live","when a song transports you gently","this is for people who inhabit their dreams carefully","the kind of beat for the starry nights of the mind","this song is my absolute favourite place","when you hear this the world becomes more beautiful","this is the soundtrack to dreams worth having","the kind of rhythm for people who know how to fly while standing still"
            ],
            chaotic: [
                "this song understands my chaotic energy","the kind of track for when you have three thoughts at once","this is for people who can't sit still","when your life seems like an improvised plan b","this song is my thursday afternoon brain","the kind of rhythm for people who do everything at a sprint","i listen to this when i'm in that impossible to explain mood","when you don't know if you're okay or not but you're dancing anyway","this song is the energy of someone with too many browser tabs open","the kind of music for creative chaos moments","this is for people who improvise their whole life","when you hear this and finally someone gets your energy","this song is my brain at 11pm","the kind of rhythm for people who are spontaneous by constitution","i listen to this when the day went in an unpredictable direction","when you've done 5 unrelated things and you're still happy","this is the song of plans that change every hour","the kind of music for people who love entropy","this song is the kind of energy that makes people ask are you okay","when chaos is your natural state and you're fine with it","this is for people who turn disorder into art","the kind of rhythm for people who wake up with 20 ideas","i listen to this when i'm doing three things simultaneously","when your life is a fast montage of unrelated scenes","this song gets my chaotic neutral vibe","the kind of music for moments when you don't know what you're doing but you're doing it","this is for people who do important things the hard way","when you hear this and feel recognized in the chaos","this song is my energetic signature","the kind of rhythm for compulsive creators","i listen to this and give myself permission not to have a plan","when you're fine in the disorder and can't explain why","this is the song for when everything is chaotic but okay","the kind of music for people who don't follow the manual","this song is my 2pm mental state","when you've started 4 things and finished none but you're in a vibe","this is for people who love the surprises they created themselves","the kind of rhythm for moments when you're running without knowing where","i listen to this when i have to do too many things but want to dance","when life makes no sense but this song does","this song is for the creative chaos that is your personality","the kind of music for heads that never stop","this is the soundtrack to my impossible days","when you're living 5 storylines simultaneously","this song is my sonic energy drink","the kind of rhythm for people with adhd of the soul","i listen to this and feel in control of the chaos","when things go their own way and you go with them singing","this is for creators of unplanned situations","the kind of music for people who find peace in the unpredictable","this song is the rhythm of my braindump","when you don't know where the energy comes from but you have it","this is the track for my moments of maximum chaotic vitality","the kind of rhythm for people who improvise even their emotions","i listen to this when i'm in everything everywhere mode","when you have a thousand ideas and zero method and it works anyway","this song is for the systematically disorganized","the kind of music for nocturnal creators","this is the soundtrack to my working brain","when the confusion is productive and you found the right song","this song is my daily gentle earthquake","the kind of rhythm for people who embrace unpredictability","i listen to this when my life is exceeding expectations in an uncontrolled way","when you're in chaos mode and have no intention of leaving","this is for people who live better without a fixed plan"
            ],
            main: [
                "this is the song for my current chapter","the kind of music for when you realize you're the protagonist","this is the soundtrack to my moment","when you hear this and life feels like a good film","this is my song of the year, maybe my life","the kind of rhythm for someone living their own story","i listen to this in the moments i want to remember","when you walk to this and the city feels like yours","this song is my cinematic montage","the kind of music for moments of personal revelation","this is the track for my character","when you hear this and realize you're in the right moment","this song is the sound of my growth","the kind of rhythm for someone who knows who they are","i listen to this when i want to feel like the protagonist of my story","when life becomes cinematic with this playing","this is for moments when you realize you're becoming someone","the kind of music for important chapters","this song is my sonic manifesto","when you hear this and know you're living something real","this is the soundtrack to my glow up","the kind of rhythm for someone writing their best story","i listen to this and remember why i'm doing what i'm doing","when the song captures exactly your era","this song is for moments of maximum clarity","the kind of music for people who found their path","this is for people living their own arc","when you hear this and want to document the moment","this song is the sound of my becoming","the kind of rhythm for quiet protagonists","i listen to this in decisive moments","when music makes you feel like you're going where you're meant to go","this is the song for someone building something","the kind of music for important transition moments","this song is the theme music of my story","when you hear this and know you're exactly where you should be","this is for someone living their turning point","the kind of rhythm for moments of maximum self-awareness","i listen to this when i'm doing the things that matter","when a song becomes the signature of your chapter","this song is my soundtrack for this period","the kind of music for someone in the middle of their most beautiful story","this is for moments when you feel fully alive","when you hear this and know you're the main character","this song is the sound of my life taking shape","the kind of rhythm for someone living with intention and presence","i listen to this when i want to feel in my own narrative arc","when music captures exactly your moment in life","this is the song of the best chapter","the kind of music for protagonists under construction","this song is my moment of maximum self","when you hear this you want everyone to see this","this is for people becoming who they always wanted to be","the kind of rhythm for moments of personal recognition","i listen to this and think yes, that's me","when a song understands exactly where you are in your story","this song is the soundtrack to my evolution","the kind of music for moments when you're an accidental protagonist","this is for someone living their best season","when you hear this you want to freeze the moment","this song is the sound of someone growing","the kind of rhythm for stories worth telling","i listen to this in moments that will become important memories","when music makes you realize you're already in the best part","this is the soundtrack of someone who chose themselves","the kind of music for moments of pure presence","this song is my best era in sonic form","when you hear this you realize your story deserves to be lived","this is for people who know they're in the middle of something important","the kind of rhythm for protagonists of their own life","i listen to this when i know this moment is going to be special","when a song becomes the sound of your most authentic moment"
            ]
        };

        let selectedCategory = 'happy';

        document.querySelectorAll('.caption-cat-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.caption-cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.category;
            };
        });

        document.getElementById('random-caption-btn').onclick = () => {
            const captions = viralCaptions[selectedCategory];
            const randomCaption = captions[Math.floor(Math.random() * captions.length)];
            
            document.getElementById('caption-input').value = randomCaption;
            caption.innerText = randomCaption;
            
            const btn = document.getElementById('random-caption-btn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = 'scale(1)', 100);
        };

        // ============================================
        // EXPORT ALL FUNCTIONALITY
        // ============================================
        
        document.getElementById('export-all-btn').onclick = async () => {
            if (videoQueue.length === 0) {
                alert('Queue is empty! Add videos before exporting.');
                return;
            }

            const exportAllBtn = document.getElementById('export-all-btn');
            exportAllBtn.disabled = true;
            
            const status = document.getElementById('export-status');
            const progress = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            const percentText = document.getElementById('percent-text');
            
            status.classList.remove('hidden');

            try {
                for (let queueIndex = 0; queueIndex < videoQueue.length; queueIndex++) {
                    const item = videoQueue[queueIndex];
                    
                    statusText.innerText = `Video ${queueIndex + 1}/${videoQueue.length}: Preparing...`;
                    progress.style.width = '0%';
                    percentText.innerText = '0%';

                    // Setup video source
                    const sourceVideo = document.getElementById('source-video');
                    sourceVideo.src = URL.createObjectURL(item.videoFile);
                    await new Promise(r => sourceVideo.onloadedmetadata = r);

                    const renderCanvas = document.getElementById('render-canvas');
                    const renderCtx = renderCanvas.getContext('2d', { willReadFrequently: true });
                    
                    const targetWidth = 1080;
                    const targetHeight = 1920;
                    
                    renderCanvas.width = targetWidth;
                    renderCanvas.height = targetHeight;

                    const fps = 30;
                    const duration = item.vEnd - item.vStart;

                    const { Muxer, ArrayBufferTarget } = window.Mp4Muxer;

                    const muxerConfig = {
                        target: new ArrayBufferTarget(),
                        video: {
                            codec: 'avc',
                            width: renderCanvas.width,
                            height: renderCanvas.height
                        },
                        fastStart: 'in-memory'
                    };

                    if (item.audioFile) {
                        muxerConfig.audio = {
                            codec: 'aac',
                            numberOfChannels: 2,
                            sampleRate: 48000
                        };
                    }

                    const muxer = new Muxer(muxerConfig);
                    
                    const videoEncoder = new VideoEncoder({
                        output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                        error: e => {
                            console.error('Video encoder error:', e);
                            throw new Error('Errore di codifica video: ' + e.message);
                        }
                    });

                    videoEncoder.configure({
                        codec: 'avc1.640028',
                        width: renderCanvas.width,
                        height: renderCanvas.height,
                        bitrate: 25_000_000,
                        framerate: fps,
                        avc: { format: 'avc' }
                    });

                    let audioEncoder = null;
                    let audioData = null;

                    if (item.audioFile) {
                        const audioContext = new AudioContext({ sampleRate: 48000 });
                        const audioBuffer = await item.audioFile.arrayBuffer();
                        const decodedAudio = await audioContext.decodeAudioData(audioBuffer);
                        
                        const startSample = Math.floor(item.aStart * decodedAudio.sampleRate);
                        const endSample = Math.floor((item.aStart + duration) * decodedAudio.sampleRate);
                        const sampleCount = endSample - startSample;
                        
                        audioData = {
                            left: new Float32Array(sampleCount),
                            right: new Float32Array(sampleCount),
                            sampleRate: decodedAudio.sampleRate
                        };
                        
                        const leftChannel = decodedAudio.getChannelData(0);
                        const rightChannel = decodedAudio.numberOfChannels > 1 ? decodedAudio.getChannelData(1) : leftChannel;
                        
                        for (let i = 0; i < sampleCount; i++) {
                            audioData.left[i] = leftChannel[startSample + i] || 0;
                            audioData.right[i] = rightChannel[startSample + i] || 0;
                        }

                        audioEncoder = new AudioEncoder({
                            output: (chunk, meta) => muxer.addAudioChunk(chunk, meta),
                            error: e => {
                                console.error('Audio encoder error:', e);
                                throw new Error('Errore di codifica audio: ' + e.message);
                            }
                        });

                        audioEncoder.configure({
                            codec: 'mp4a.40.2',
                            sampleRate: 48000,
                            numberOfChannels: 2,
                            bitrate: 192000
                        });
                    }

                    sourceVideo.currentTime = item.vStart;
                    await new Promise(r => { sourceVideo.onseeked = r; });

                    const totalFrames = Math.ceil(duration * fps);
                    const targetSampleRate = 48000;
                    const sourceSampleRate = audioData ? audioData.sampleRate : 48000;
                    const samplesPerFrame = Math.floor(targetSampleRate / fps);
                    let audioSampleOffset = 0;

                    const previewHeight = 515;
                    const exportHeight = renderCanvas.height;
                    const scaleFactor = exportHeight / previewHeight;

                    function drawBulkCaption() {
                        if (item.caption && item.caption !== 'Scrivi il tuo testo') {
                            const scaledFontSize = item.fontSize * scaleFactor;
                            const scaledMaxWidth = item.captionMaxWidthPx * scaleFactor;
                            let fontFamily = 'Montserrat';
                            if (item.fontClass.includes('font-typewriter')) fontFamily = 'Courier Prime';
                            else if (item.fontClass.includes('font-classic')) fontFamily = 'Inter';
                            else if (item.fontClass.includes('font-handwriting')) fontFamily = 'Dancing Script';
                            renderCtx.font = `800 ${scaledFontSize}px ${fontFamily}`;
                            renderCtx.textAlign = 'center';
                            renderCtx.textBaseline = 'top';
                            const words = item.caption.split(' ');
                            const lines = [];
                            let currentLine = words[0];
                            for (let wi = 1; wi < words.length; wi++) {
                                const testLine = currentLine + ' ' + words[wi];
                                if (renderCtx.measureText(testLine).width > scaledMaxWidth) {
                                    lines.push(currentLine);
                                    currentLine = words[wi];
                                } else {
                                    currentLine = testLine;
                                }
                            }
                            lines.push(currentLine);
                            const lineHeight = scaledFontSize * 1.2;
                            const textY = item.captionTopPx * scaleFactor;
                            lines.forEach((line, li) => {
                                const y = textY + (li * lineHeight);
                                if (item.hasOutline) {
                                    renderCtx.strokeStyle = item.outlineColor;
                                    renderCtx.lineWidth = Math.max(scaleFactor * 1.5, 3);
                                    renderCtx.lineJoin = 'round';
                                    renderCtx.miterLimit = 2;
                                    renderCtx.strokeText(line, renderCanvas.width / 2, y);
                                }
                                renderCtx.fillStyle = item.textColor;
                                renderCtx.fillText(line, renderCanvas.width / 2, y);
                            });
                        }
                    }

                    function encodeBulkAudioFrame(frameIdx) {
                        if (!audioEncoder || !audioData) return;
                        const resampleRatio = sourceSampleRate / targetSampleRate;
                        const leftChannel = new Float32Array(samplesPerFrame);
                        const rightChannel = new Float32Array(samplesPerFrame);
                        for (let j = 0; j < samplesPerFrame; j++) {
                            const srcIdx = Math.floor(audioSampleOffset + (j * resampleRatio));
                            leftChannel[j] = srcIdx < audioData.left.length ? audioData.left[srcIdx] : 0;
                            rightChannel[j] = srcIdx < audioData.right.length ? audioData.right[srcIdx] : 0;
                        }
                        const audioFrame = new AudioData({
                            format: 'f32-planar',
                            sampleRate: targetSampleRate,
                            numberOfFrames: samplesPerFrame,
                            numberOfChannels: 2,
                            timestamp: (frameIdx * 1_000_000) / fps,
                            data: new Float32Array([...leftChannel, ...rightChannel])
                        });
                        audioEncoder.encode(audioFrame);
                        audioFrame.close();
                        audioSampleOffset += Math.floor(samplesPerFrame * resampleRatio);
                    }

                    // Reliable seek-per-frame capture
                    for (let i = 0; i < totalFrames; i++) {
                        sourceVideo.currentTime = item.vStart + (i / fps);
                        await new Promise(r => { sourceVideo.onseeked = r; });

                        if (item.removeWatermark) {
                            const scale = 1.1;
                            const sw = sourceVideo.videoWidth * scale;
                            const sh = sourceVideo.videoHeight * scale;
                            renderCtx.drawImage(sourceVideo, -(sw - renderCanvas.width) / 2, -(sh - renderCanvas.height) / 2, sw, sh);
                        } else {
                            renderCtx.drawImage(sourceVideo, 0, 0, renderCanvas.width, renderCanvas.height);
                        }
                        drawBulkCaption();

                        const vf = new VideoFrame(renderCanvas, { timestamp: (i * 1_000_000) / fps });
                        videoEncoder.encode(vf, { keyFrame: i % 30 === 0 });
                        vf.close();
                        encodeBulkAudioFrame(i);

                        const p = Math.round(((i + 1) / totalFrames) * 100);
                        progress.style.width = p + '%';
                        percentText.innerText = p + '%';

                        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
                    }


                    await videoEncoder.flush();
                    if (audioEncoder) await audioEncoder.flush();
                    muxer.finalize();

                    const buffer = muxer.target.buffer;
                    const blob = new Blob([buffer], { type: 'video/mp4' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const sanitizedCaption = (item.caption || 'video').substring(0, 30).replace(/[^a-z0-9]/gi, '_');
                    a.download = `TikTok_${queueIndex + 1}_${sanitizedCaption}.mp4`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    // Small delay between downloads
                    await new Promise(r => setTimeout(r, 500));
                }

                statusText.innerText = 'All videos exported!';
                percentText.innerText = '100%';
                progress.style.width = '100%';
                
                setTimeout(() => {
                    status.classList.add('hidden');
                    exportAllBtn.disabled = false;
                }, 3000);

            } catch (e) {
                console.error('Error during l\'export bulk:', e);
                statusText.innerText = 'Errore: ' + e.message;
                alert('Error during l\'export bulk. Controlla la console per dettagli.');
                setTimeout(() => status.classList.add('hidden'), 3000);
                exportAllBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
