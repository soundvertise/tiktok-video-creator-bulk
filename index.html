<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Ads Creator | Soundvertise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Courier+Prime:wght@400;700&family=Inter:wght@400;600;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/mp4-muxer@latest/build/mp4-muxer.js"></script>
    <style>
        :root {
            --sv-purple: #8B5CF6;
            --sv-blue: #3B82F6;
            --sv-bg: #050505;
            --sv-card: #0F0F0F;
        }

        body {
            background-color: var(--sv-bg);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .preview-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .iphone-frame {
            width: 290px;
            height: calc(290px * 16 / 9);
            border: 10px solid #1A1A1A;
            border-radius: 42px;
            position: relative;
            background: #000;
            overflow: hidden;
            box-shadow: 0 0 0 2px #000, 0 20px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .notch {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 75px;
            height: 22px;
            background: #000;
            border-radius: 20px;
            z-index: 50;
            border: 1px solid #222;
        }

        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #000;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }

        #caption-overlay {
            position: absolute;
            cursor: move;
            user-select: none;
            text-align: center;
            max-width: 85%;
            word-wrap: break-word;
            z-index: 30;
            display: block;
            line-height: 1.1;
            left: 50%;
            transform: translateX(-50%);
            --outline-color: #000000;
            paint-order: stroke fill;
        }
        
        #caption-overlay:not(.dragging) {
            transition: top 0.1s ease-out;
        }

        .text-bold-outline {
            text-shadow: 
                0 0 1px var(--outline-color),
                -1.5px -1.5px 0 var(--outline-color),  
                 1.5px -1.5px 0 var(--outline-color),
                -1.5px  1.5px 0 var(--outline-color),
                 1.5px  1.5px 0 var(--outline-color),
                 0px 3px 8px rgba(0,0,0,0.6);
        }

        .tiktok-ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            display: block;
            background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.2) 100%);
        }

        .right-actions {
            position: absolute;
            right: 8px;
            bottom: 85px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .action-text { font-size: 8px; font-weight: 600; }

        .bottom-info {
            position: absolute;
            left: 12px;
            bottom: 20px;
            max-width: 190px;
        }

        .trimmer-track {
            position: relative;
            width: 100%;
            background: #111;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
            cursor: pointer;
        }

        .thumbnail-track {
            position: absolute;
            inset: 0;
            display: flex;
            pointer-events: none;
            opacity: 0.4;
        }

        .thumbnail-track canvas {
            height: 100%;
            flex: 1;
            object-fit: cover;
        }

        .trim-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            z-index: 5;
            cursor: grab;
            border-radius: 6px;
        }

        #video-trim-overlay {
            background: rgba(59, 130, 246, 0.2);
            border: 3px solid var(--sv-blue);
        }

        #audio-trim-overlay {
            background: rgba(139, 92, 246, 0.15);
            border: 3px solid var(--sv-purple);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .playhead-cursor {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #ffffff;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }

        .trim-handle {
            position: absolute;
            top: 0;
            width: 16px;
            height: 100%;
            background: inherit;
            cursor: ew-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #video-trim-overlay .trim-handle { background-color: var(--sv-blue); }
        #audio-trim-overlay .trim-handle { display: none; }

        .trim-handle::after {
            content: '';
            width: 2px;
            height: 14px;
            background: white;
            border-radius: 1px;
        }
        .handle-left { left: -8px; border-radius: 6px 0 0 6px; }
        .handle-right { right: -8px; border-radius: 0 6px 6px 0; }

        .waveform-wrapper {
            position: relative;
            width: 100%;
            height: 70px;
            background: #000;
        }

        #waveform { width: 100%; height: 100%; pointer-events: none; }

        .btn-sv {
            background: linear-gradient(135deg, var(--sv-blue) 0%, var(--sv-purple) 100%);
            transition: all 0.3s ease;
        }
        .btn-sv:hover { filter: brightness(1.1); transform: scale(1.02); }
        .btn-sv:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .font-tiktok { font-family: 'Montserrat', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
        .font-typewriter { font-family: 'Courier Prime', monospace; }
        .font-classic { font-family: 'Inter', sans-serif; font-weight: 800; }
        .font-handwriting { font-family: 'Dancing Script', cursive; font-weight: 700; }

        .font-btn {
            background: #000;
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 10px;
            transition: all 0.2s;
            color: #666;
        }
        .font-btn.active {
            border-color: var(--sv-blue);
            background: rgba(59, 130, 246, 0.1);
            color: #fff;
        }

        .color-wrapper {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
            background: #000;
            flex-shrink: 0;
        }
        
        .color-input {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            cursor: pointer;
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            background: #111;
            border: 1px solid #333;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            color: #666;
            cursor: pointer;
        }
        .toggle-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--sv-blue);
            color: #fff;
        }

        .caption-cat-btn {
            background: #000;
            border: 1px solid #333;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.2s;
            color: #666;
            cursor: pointer;
        }
        .caption-cat-btn.active {
            border-color: var(--sv-purple);
            background: rgba(139, 92, 246, 0.15);
            color: #fff;
        }
        .caption-cat-btn:hover {
            border-color: var(--sv-purple);
            color: #fff;
        }

        #render-canvas {
            display: none;
        }

        .queue-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            transition: all 0.2s;
        }

        .queue-item.active {
            border-color: var(--sv-blue);
            background: rgba(59, 130, 246, 0.15);
        }

        .queue-item:hover {
            border-color: var(--sv-blue);
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-caption {
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .queue-item-meta {
            font-size: 8px;
            color: #888;
            margin-top: 2px;
        }

        .queue-item-actions {
            display: flex;
            gap: 4px;
        }

        .queue-item-btn {
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .queue-item-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #666;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
        
        <!-- Preview Column -->
        <div class="preview-column space-y-6 order-2 lg:order-1">
            <div class="iphone-frame" id="iphone">
                <div class="notch"></div>
                <div class="video-container" id="drop-zone">
                    <video id="main-video" crossorigin="anonymous" playsinline loop muted></video>
                    <div id="caption-overlay" class="font-tiktok text-bold-outline" style="top: 35%; font-size: 12px; color: white;">
                        Scrivi il tuo testo
                    </div>
                    <div id="safe-guide" class="tiktok-ui-overlay">
                        <div class="right-actions">
                            <div class="action-item flex flex-col items-center">
                                <div class="w-9 h-9 rounded-full border border-white bg-zinc-800 mb-1 overflow-hidden">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=SV" alt="avatar">
                                </div>
                            </div>
                            <div class="action-item flex flex-col items-center">
                                <i data-lucide="heart" class="text-white fill-white w-7 h-7"></i>
                                <span class="action-text text-white">580K</span>
                            </div>
                            <div class="action-item flex flex-col items-center">
                                <i data-lucide="message-circle" class="text-white fill-white w-7 h-7"></i>
                                <span class="action-text text-white">2.4K</span>
                            </div>
                        </div>
                        <div class="bottom-info space-y-0.5">
                            <p class="font-bold text-[11px]">@soundvertise.co</p>
                            <p class="text-[10px] opacity-90 leading-tight">Video creato con Soundvertise.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="toggle-guide" class="flex-1 px-5 py-2 bg-zinc-900 rounded-full text-[9px] font-black uppercase border border-zinc-800 hover:border-blue-500 transition-all text-zinc-400 hover:text-white">
                   Anteprima TikTok UI
                </button>
                <button id="toggle-watermark" class="toggle-btn">
                    <i data-lucide="zoom-in" class="w-3.5 h-3.5"></i>
                    Remove VEO
                </button>
            </div>
        </div>

        <!-- Editor Controls -->
        <div class="bg-zinc-900/40 border border-zinc-800 p-6 md:p-8 rounded-[2.5rem] space-y-6 backdrop-blur-xl order-1 lg:order-2">
            <header class="flex justify-between items-end border-b border-zinc-800/50 pb-4">
                <div>
                    <h1 class="text-xl font-black italic uppercase">Video <span class="text-blue-400">Ads Creator</span></h1>
                    <p class="text-[9px] font-bold tracking-widest text-zinc-600">SOUNDVERTISE</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <span id="video-dur-label" class="text-blue-400 font-mono text-xs font-bold uppercase block">Video: 15.0s</span>
                            <span id="queue-count" class="text-violet-400 font-mono text-[10px] font-bold uppercase">Coda: 0/20</span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-zinc-500">File Video</label>
                    <label for="video-input" class="flex items-center gap-3 bg-black border border-zinc-800 p-3 rounded-xl cursor-pointer hover:border-blue-500 transition-all">
                        <i data-lucide="video" class="w-4 h-4 text-blue-400"></i>
                        <span class="text-[11px] text-zinc-400 truncate" id="video-label">Carica Video</span>
                        <input type="file" id="video-input" accept="video/*" class="hidden">
                    </label>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-zinc-500">File Audio</label>
                    <label for="audio-input" class="flex items-center gap-3 bg-black border border-zinc-800 p-3 rounded-xl cursor-pointer hover:border-violet-500 transition-all">
                        <i data-lucide="music" class="w-4 h-4 text-violet-400"></i>
                        <span class="text-[11px] text-zinc-400 truncate" id="audio-label">Carica Audio (Opzionale)</span>
                        <input type="file" id="audio-input" accept="audio/*" class="hidden">
                    </label>
                </div>
            </div>

            <!-- Video Trimmer -->
            <div class="space-y-2">
                <div class="flex justify-between items-center text-[9px] font-black uppercase text-zinc-500">
                    <span>Ritaglia Clip Video (Max 30s)</span>
                    <span id="v-range-text">0.0s - 15.0s</span>
                </div>
                <div class="trimmer-track h-[54px]" id="v-trimmer-track">
                    <div class="thumbnail-track" id="v-thumbs"></div>
                    <div id="video-playhead" class="playhead-cursor" style="left: 0; display: none;"></div>
                    <div id="video-trim-overlay" class="trim-overlay">
                        <div class="trim-handle handle-left" id="v-handle-l"></div>
                        <div class="trim-handle handle-right" id="v-handle-r"></div>
                    </div>
                </div>
            </div>

            <!-- Audio Waveform Trimmer -->
            <div class="space-y-3 bg-black p-4 rounded-3xl border border-zinc-800/50">
                <div class="flex items-center gap-4">
                    <button id="play-btn" class="w-12 h-12 rounded-xl btn-sv text-white flex items-center justify-center shadow-lg shrink-0">
                        <i data-lucide="play" id="play-icon" class="w-5 h-5 fill-white"></i>
                    </button>
                    <div class="flex-1 space-y-1">
                        <div class="flex justify-between items-center text-[9px] font-black uppercase text-zinc-500">
                            <span>Onda Sonora (Loop Anteprima)</span>
                            <div class="flex items-center gap-2">
                                <select id="audio-selector" class="bg-zinc-900 border border-zinc-700 rounded px-2 py-1 text-[9px] text-zinc-300 font-bold cursor-pointer hover:border-violet-500 transition-all">
                                    <option value="">Nessun Audio</option>
                                </select>
                                <span id="audio-start-label">Start: 0.0s</span>
                            </div>
                        </div>
                        <div class="trimmer-track h-[70px]" id="a-trimmer-track">
                            <div class="waveform-wrapper">
                                <canvas id="waveform"></canvas>
                            </div>
                            <div id="audio-playhead" class="playhead-cursor" style="left: 0; display: none;"></div>
                            <div id="audio-trim-overlay" class="trim-overlay"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Editor -->
            <div class="p-5 bg-zinc-900/60 rounded-3xl border border-zinc-800 space-y-4">
                <!-- Viral Captions Generator -->
                <div class="space-y-3 p-4 bg-gradient-to-br from-violet-950/30 to-blue-950/30 rounded-2xl border border-violet-800/30">
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-black uppercase text-violet-300 tracking-widest">âœ¨ Caption Virali</span>
                        <button id="random-caption-btn" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-500 rounded-lg text-[9px] font-black uppercase transition-all flex items-center gap-1.5">
                            <i data-lucide="shuffle" class="w-3 h-3"></i>
                            Random
                        </button>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <button class="caption-cat-btn active" data-category="happy">Happy</button>
                        <button class="caption-cat-btn" data-category="sad">Sad</button>
                        <button class="caption-cat-btn" data-category="dance">Dance</button>
                        <button class="caption-cat-btn" data-category="chill">Chill</button>
                        <button class="caption-cat-btn" data-category="love">Love</button>
                        <button class="caption-cat-btn" data-category="pov">POV</button>
                        <button class="caption-cat-btn" data-category="gym">Gym</button>
                        <button class="caption-cat-btn" data-category="energy">Energy</button>
                        <button class="caption-cat-btn" data-category="party">Party</button>
                        <button class="caption-cat-btn" data-category="viral">Viral</button>
                        <button class="caption-cat-btn" data-category="beauty">Beauty</button>
                        <button class="caption-cat-btn" data-category="sensual">Sensual</button>
                        <button class="caption-cat-btn" data-category="mood">Mood</button>
                        <button class="caption-cat-btn" data-category="hype">Hype</button>
                        <button class="caption-cat-btn" data-category="vibe">Vibe</button>
                        <button class="caption-cat-btn" data-category="throwback">Throwback</button>
                    </div>
                </div>

                <textarea id="caption-input" rows="2" placeholder="Scrivi il testo qui..." class="w-full bg-black border border-zinc-800 rounded-xl p-3 text-sm focus:ring-1 focus:ring-blue-500 outline-none resize-none font-semibold"></textarea>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <button class="font-btn active" data-font="font-tiktok">TIKTOK</button>
                    <button class="font-btn" data-font="font-typewriter">RETRO</button>
                    <button class="font-btn" data-font="font-classic">BOLD</button>
                    <button class="font-btn" data-font="font-handwriting">SCRIPT</button>
                </div>

                <div class="space-y-4 pt-2">
                    <div class="flex-1 space-y-2">
                        <div class="flex justify-between text-[9px] font-black text-zinc-500 uppercase tracking-widest">
                            <span>Dimensione Carattere</span>
                            <span id="fs-val" class="text-blue-400">12px</span>
                        </div>
                        <input type="range" id="font-size" min="12" max="60" value="12" class="w-full accent-blue-500 h-1 bg-zinc-800 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <div class="flex flex-col gap-4 p-4 bg-black/40 rounded-2xl border border-zinc-800/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="color-wrapper shadow-lg"><input type="color" id="text-color" value="#ffffff" class="color-input"></div>
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Colore Testo</span>
                            </div>

                            <div class="h-6 w-[1px] bg-zinc-800"></div>

                            <div class="flex items-center gap-3">
                                <span class="text-[9px] font-black text-zinc-400 uppercase tracking-widest">Contorno</span>
                                <div class="color-wrapper shadow-lg"><input type="color" id="outline-color" value="#000000" class="color-input"></div>
                            </div>
                        </div>

                        <button id="outline-toggle" class="toggle-btn active justify-center w-full">
                            <i data-lucide="check" class="w-3.5 h-3.5"></i>
                            Stile Contorno Attivo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Video Queue -->
            <div class="space-y-3 p-4 bg-gradient-to-br from-blue-950/30 to-violet-950/30 rounded-2xl border border-blue-800/30">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[11px] font-black uppercase text-blue-300 tracking-widest">ðŸŽ¬ Creazione Bulk</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="auto-queue-btn" class="px-4 py-3 bg-violet-600 hover:bg-violet-500 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                        Auto-Coda Tutto
                    </button>
                    <button id="save-current-btn" class="px-4 py-3 bg-green-600 hover:bg-green-500 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salva Modifiche
                    </button>
                    <button id="prev-video-btn" class="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 disabled:opacity-30 col-span-1">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        Prev
                    </button>
                    <button id="next-video-btn" class="px-4 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl text-[11px] font-black uppercase transition-all flex items-center justify-center gap-2 disabled:opacity-30 col-span-1">
                        Next
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
                <div id="queue-list" class="space-y-1 max-h-32 overflow-y-auto mt-3"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="add-to-queue-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest text-[11px] transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i> Aggiungi Nuovo
                </button>
                <button id="export-btn" class="btn-sv text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest text-[11px]">
                    <i data-lucide="download" class="w-4 h-4"></i> Esporta Singolo
                </button>
            </div>
            
            <button id="export-all-btn" class="w-full bg-gradient-to-r from-violet-600 to-blue-600 text-white font-black py-5 rounded-2xl flex items-center justify-center gap-2 uppercase tracking-widest text-[12px] disabled:opacity-50 disabled:cursor-not-allowed hover:from-violet-500 hover:to-blue-500 transition-all shadow-lg">
                <i data-lucide="download-cloud" class="w-5 h-5"></i> Esporta Tutti i Video (<span id="export-count">0</span>)
            </button>
            
            <div id="export-status" class="hidden bg-black border border-zinc-800 p-4 rounded-2xl">
                <div class="flex justify-between text-[10px] mb-2 font-black uppercase text-blue-400">
                    <span id="status-text">Preparazione...</span>
                    <span id="percent-text">0%</span>
                </div>
                <div class="w-full bg-zinc-900 rounded-full h-1.5 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-full w-0 transition-all"></div>
                </div>
            </div>
        </div>
    </div>

    <audio id="bg-music" crossorigin="anonymous"></audio>
    <canvas id="render-canvas"></canvas>
    <video id="source-video" style="display: none;"></video>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            initializeApp();
        });

        function initializeApp() {
            console.log('App initialization started');
            
        lucide.createIcons();

        const video = document.getElementById('main-video');
        const audio = document.getElementById('bg-music');
        const caption = document.getElementById('caption-overlay');
        const captionElement = document.getElementById('caption-overlay');
        const videoContainer = document.getElementById('drop-zone');
        const vTrimOverlay = document.getElementById('video-trim-overlay');
        const aTrimOverlay = document.getElementById('audio-trim-overlay');
        const vTrimmerTrack = document.getElementById('v-trimmer-track');
        const aTrimmerTrack = document.getElementById('a-trimmer-track');
        const vPlayhead = document.getElementById('video-playhead');
        const aPlayhead = document.getElementById('audio-playhead');
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');

        let videoFile, audioFile;
        let videoDuration = 0, audioDuration = 0;
        let vStart = 0, vEnd = 15;
        let aStart = 0;
        
        const MAX_DUR = 30; 
        
        let outlineEnabled = true;
        let removeWatermark = false;
        let isDraggingV = null; 
        let isDraggingA = false;
        let dragOffsetV = 0;
        let dragOffsetA = 0;

        // File libraries for bulk workflow
        let videoLibrary = [];
        let audioLibrary = [];
        let currentVideoIndex = 0;
        let currentAudioIndex = -1; // -1 means no audio selected

        function updateFileLibraryUI() {
            console.log('updateFileLibraryUI called');
            console.log('Video library:', videoLibrary.length);
            console.log('Audio library:', audioLibrary.length);
            
            const videoList = document.getElementById('video-files-list');
            const audioList = document.getElementById('audio-files-list');
            
            if (!videoList || !audioList) {
                console.error('Could not find file list elements!');
                return;
            }
            
            if (videoLibrary.length > 0) {
                videoList.innerHTML = `ðŸ“ ${videoLibrary.length} video caricati`;
                document.getElementById('video-label').innerText = `${videoLibrary.length} video pronti`;
                console.log('Updated video UI');
            } else {
                videoList.innerHTML = '';
                document.getElementById('video-label').innerText = 'Carica Video (Multipli)';
            }
            
            if (audioLibrary.length > 0) {
                audioList.innerHTML = `ðŸŽµ ${audioLibrary.length} audio caricati`;
                document.getElementById('audio-label').innerText = `${audioLibrary.length} audio pronti`;
                
                // Update audio selector
                const selector = document.getElementById('audio-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">Nessun Audio</option>';
                    audioLibrary.forEach((audioFile, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = audioFile.name;
                        selector.appendChild(option);
                    });
                    console.log('Updated audio selector with', audioLibrary.length, 'options');
                } else {
                    console.error('Audio selector not found!');
                }
            } else {
                audioList.innerHTML = '';
                document.getElementById('audio-label').innerText = 'Carica Audio (Multipli)';
            }
        }

        function loadVideoFromLibrary(index) {
            console.log('loadVideoFromLibrary called with index:', index);
            console.log('Video library length:', videoLibrary.length);
            
            if (index < 0 || index >= videoLibrary.length) {
                console.error('Invalid video index:', index);
                return;
            }
            
            try {
                currentVideoIndex = index;
                videoFile = videoLibrary[index];
                
                console.log('Loading video:', videoFile.name);
                
                const videoURL = URL.createObjectURL(videoFile);
                console.log('Video URL created:', videoURL);
                
                video.src = videoURL;
                video.onloadedmetadata = () => {
                    console.log('Video metadata loaded');
                    videoDuration = video.duration;
                    vStart = 0;
                    vEnd = Math.min(videoDuration, 15);
                    updateTrimmers();
                    video.currentTime = vStart;
                    console.log('Video ready:', videoDuration, 'seconds');
                };
                
                video.onerror = (e) => {
                    console.error('Video load error:', e);
                    alert('Errore nel caricamento del video: ' + videoFile.name);
                };
                
                generateThumbnails(videoFile);
            } catch (error) {
                console.error('Error in loadVideoFromLibrary:', error);
                alert('Errore: ' + error.message);
            }
        }

        function loadAudioFromSelector() {
            const selector = document.getElementById('audio-selector');
            const selectedIndex = parseInt(selector.value);
            
            if (isNaN(selectedIndex) || selectedIndex < 0) {
                // No audio selected
                currentAudioIndex = -1;
                audioFile = null;
                audio.src = '';
                audioDuration = 0;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                updateTrimmers();
                return;
            }
            
            currentAudioIndex = selectedIndex;
            audioFile = audioLibrary[selectedIndex];
            audio.src = URL.createObjectURL(audioFile);
            audio.onloadedmetadata = () => {
                audioDuration = audio.duration;
                drawWaveform(audioFile);
                updateTrimmers();
                audio.currentTime = aStart;
            };
        }

        // Toggle watermark removal
        document.getElementById('toggle-watermark').onclick = function() {
            removeWatermark = !removeWatermark;
            this.classList.toggle('active');
            
            if (removeWatermark) {
                video.style.transform = 'scale(1.1)';
                this.innerHTML = '<i data-lucide="zoom-out" class="w-3.5 h-3.5"></i> Reset Zoom';
            } else {
                video.style.transform = 'scale(1)';
                this.innerHTML = '<i data-lucide="zoom-in" class="w-3.5 h-3.5"></i> Remove VEO';
            }
            lucide.createIcons();
        };

        function updateTrimmers() {
            if (videoDuration > 0) {
                const vLeft = (vStart / videoDuration) * 100;
                const vWidth = ((vEnd - vStart) / videoDuration) * 100;
                vTrimOverlay.style.left = vLeft + '%';
                vTrimOverlay.style.width = vWidth + '%';
                
                document.getElementById('v-range-text').innerText = `${vStart.toFixed(1)}s - ${vEnd.toFixed(1)}s`;
                document.getElementById('video-dur-label').innerText = `Video: ${(vEnd - vStart).toFixed(1)}s`;
                
                if (audioDuration > 0) {
                    const currentVidDur = vEnd - vStart;
                    const aWidth = (currentVidDur / audioDuration) * 100;
                    
                    if (aStart + currentVidDur > audioDuration) {
                        aStart = Math.max(0, audioDuration - currentVidDur);
                    }
                    
                    const aLeft = (aStart / audioDuration) * 100;
                    aTrimOverlay.style.left = aLeft + '%';
                    aTrimOverlay.style.width = aWidth + '%';
                    document.getElementById('audio-start-label').innerText = `Start Audio: ${aStart.toFixed(1)}s`;
                }
            }
        }

        function loopMonitor() {
            if (!video.paused) {
                if (videoDuration > 0) {
                    const vPerc = (video.currentTime / videoDuration) * 100;
                    vPlayhead.style.left = vPerc + '%';
                    vPlayhead.style.display = 'block';
                }

                if (audio.src && audioDuration > 0) {
                    const aPerc = (audio.currentTime / audioDuration) * 100;
                    aPlayhead.style.left = aPerc + '%';
                    aPlayhead.style.display = 'block';
                }

                if (video.currentTime >= vEnd - 0.05) {
                    video.currentTime = vStart;
                    if (audio.src) {
                        audio.currentTime = aStart;
                        audio.play().catch(() => {});
                    }
                }

                if (audio.src && !audio.paused) {
                    const videoOffset = video.currentTime - vStart;
                    const expectedAudioTime = aStart + videoOffset;
                    if (Math.abs(audio.currentTime - expectedAudioTime) > 0.2) {
                        audio.currentTime = expectedAudioTime;
                    }
                }
            } else {
                vPlayhead.style.display = 'none';
                aPlayhead.style.display = 'none';
            }
            requestAnimationFrame(loopMonitor);
        }
        requestAnimationFrame(loopMonitor);

        vTrimmerTrack.onmousedown = (e) => {
            if (videoDuration === 0) return;
            const rect = vTrimmerTrack.getBoundingClientRect();
            const clickTime = ((e.clientX - rect.left) / rect.width) * videoDuration;
            
            if (e.target.id === 'v-handle-l') {
                isDraggingV = 'left';
            } else if (e.target.id === 'v-handle-r') {
                isDraggingV = 'right';
            } else if (e.target.closest('#video-trim-overlay')) {
                isDraggingV = 'center';
                dragOffsetV = clickTime - vStart;
            } else {
                video.currentTime = clickTime;
                if (audio.src) {
                    const offset = clickTime - vStart;
                    audio.currentTime = Math.max(0, aStart + offset);
                }
            }
        };

        aTrimmerTrack.onmousedown = (e) => {
            if (audioDuration === 0) return;
            const rect = aTrimmerTrack.getBoundingClientRect();
            const clickTime = ((e.clientX - rect.left) / rect.width) * audioDuration;
            
            if (e.target.closest('#audio-trim-overlay')) {
                isDraggingA = true;
                dragOffsetA = clickTime - aStart;
            } else {
                const currentVidDur = vEnd - vStart;
                let newAStart = clickTime - (currentVidDur / 2);
                if (newAStart < 0) newAStart = 0;
                if (newAStart + currentVidDur > audioDuration) newAStart = audioDuration - currentVidDur;
                aStart = newAStart;
                updateTrimmers();
                audio.currentTime = aStart;
                video.currentTime = vStart;
            }
        };

        window.onmousemove = (e) => {
            if (isDraggingV && videoDuration > 0) {
                const rect = vTrimmerTrack.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const currentTime = (x / rect.width) * videoDuration;

                if (isDraggingV === 'left') {
                    if (currentTime < vEnd && vEnd - currentTime <= MAX_DUR) vStart = currentTime;
                    else if (vEnd - currentTime > MAX_DUR) vStart = vEnd - MAX_DUR;
                } else if (isDraggingV === 'right') {
                    if (currentTime > vStart && currentTime - vStart <= MAX_DUR) vEnd = currentTime;
                    else if (currentTime - vStart > MAX_DUR) vEnd = vStart + MAX_DUR;
                } else if (isDraggingV === 'center') {
                    let dur = vEnd - vStart;
                    let newStart = currentTime - dragOffsetV;
                    if (newStart >= 0 && newStart + dur <= videoDuration) {
                        vStart = newStart;
                        vEnd = newStart + dur;
                    }
                }
                updateTrimmers();
                syncPlayback();
            }

            if (isDraggingA && audioDuration > 0) {
                const rect = aTrimmerTrack.getBoundingClientRect();
                const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                const currentTime = (x / rect.width) * audioDuration;
                const currentVidDur = vEnd - vStart;
                let newAStart = currentTime - dragOffsetA;
                if (newAStart >= 0 && newAStart + currentVidDur <= audioDuration) {
                    aStart = newAStart;
                }
                updateTrimmers();
                syncPlayback();
            }
        };

        window.onmouseup = () => {
            isDraggingV = null;
            isDraggingA = false;
        };

        document.getElementById('video-input').onchange = async (e) => {
            videoFile = e.target.files[0];
            if (videoFile) {
                video.src = URL.createObjectURL(videoFile);
                document.getElementById('video-label').innerText = videoFile.name;
                video.onloadedmetadata = () => {
                    videoDuration = video.duration;
                    vStart = 0;
                    vEnd = Math.min(videoDuration, 15);
                    updateTrimmers();
                    video.currentTime = vStart;
                };
                generateThumbnails(videoFile);
            }
        };

        document.getElementById('audio-input').onchange = (e) => {
            audioFile = e.target.files[0];
            if (audioFile) {
                audio.src = URL.createObjectURL(audioFile);
                document.getElementById('audio-label').innerText = audioFile.name;
                audio.onloadedmetadata = () => {
                    audioDuration = audio.duration;
                    drawWaveform(audioFile);
                    updateTrimmers();
                    audio.currentTime = aStart;
                };
            }
        };

        document.getElementById('play-btn').onclick = () => {
            if (video.paused) {
                video.currentTime = vStart;
                video.play();
                if (audio.src) {
                    audio.currentTime = aStart;
                    audio.play().catch(() => {});
                }
                updatePlayIcon(true);
            } else {
                video.pause();
                audio.pause();
                // Reset positions when pausing
                video.currentTime = vStart;
                if (audio.src) {
                    audio.currentTime = aStart;
                }
                updatePlayIcon(false);
            }
        };

        function syncPlayback() {
            video.currentTime = vStart;
            if (audio.src) audio.currentTime = aStart;
            if (!video.paused) {
                video.play();
                if (audio.src) audio.play().catch(() => {});
            }
        }

        function updatePlayIcon(isPlaying) {
            const icon = document.getElementById('play-icon');
            icon.setAttribute('data-lucide', isPlaying ? 'pause' : 'play');
            lucide.createIcons();
        }

        async function drawWaveform(file) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const buffer = await file.arrayBuffer();
            const decoded = await audioCtx.decodeAudioData(buffer);
            const rawData = decoded.getChannelData(0);
            const samples = 120;
            const blockSize = Math.floor(rawData.length / samples);
            const data = [];
            for (let i = 0; i < samples; i++) {
                let sum = 0;
                for (let j = 0; j < blockSize; j++) sum += Math.abs(rawData[i * blockSize + j]);
                data.push(sum / blockSize);
            }
            const max = Math.max(...data);
            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;
            const step = canvas.width / samples;
            const grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            grad.addColorStop(0, '#3B82F6');
            grad.addColorStop(1, '#8B5CF6');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = grad;
            data.forEach((val, i) => {
                const h = (val / max) * canvas.height * 0.8;
                const x = i * step;
                const y = (canvas.height - h) / 2;
                ctx.beginPath();
                ctx.roundRect(x, y, step - 3, h, 2);
                ctx.fill();
            });
        }

        document.getElementById('caption-input').oninput = (e) => caption.innerText = e.target.value || 'Scrivi il tuo testo';
        document.getElementById('font-size').oninput = (e) => {
            caption.style.fontSize = e.target.value + 'px';
            document.getElementById('fs-val').innerText = e.target.value + 'px';
        };
        document.getElementById('text-color').oninput = (e) => caption.style.color = e.target.value;
        
        const outlineBtn = document.getElementById('outline-toggle');
        const outlineColorInput = document.getElementById('outline-color');

        function updateOutlineUI() {
            if (outlineEnabled) {
                caption.classList.add('text-bold-outline');
                outlineBtn.classList.add('active');
                outlineBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5"></i> Stile Contorno Attivo';
            } else {
                caption.classList.remove('text-bold-outline');
                outlineBtn.classList.remove('active');
                outlineBtn.innerHTML = '<i data-lucide="x" class="w-3.5 h-3.5"></i> Stile Contorno Spento';
            }
            lucide.createIcons();
        }

        outlineBtn.onclick = () => {
            outlineEnabled = !outlineEnabled;
            updateOutlineUI();
        };

        outlineColorInput.oninput = (e) => {
            caption.style.setProperty('--outline-color', e.target.value);
            if (!outlineEnabled) {
                outlineEnabled = true;
                updateOutlineUI();
            }
        };

        document.querySelectorAll('.font-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const hasOutline = caption.classList.contains('text-bold-outline');
                caption.className = btn.dataset.font + (hasOutline ? ' text-bold-outline' : '');
            };
        });

        let dragText = false, dragStartY, dragStartTop;
        
        caption.onmousedown = (e) => { 
            dragText = true; 
            dragStartY = e.clientY;
            dragStartTop = caption.offsetTop;
            caption.style.cursor = 'grabbing';
            caption.classList.add('dragging');
            e.preventDefault();
        };
        
        window.addEventListener('mousemove', (e) => {
            if (dragText) {
                const rect = document.getElementById('drop-zone').getBoundingClientRect();
                const deltaY = e.clientY - dragStartY;
                let newTop = dragStartTop + deltaY;
                
                const minTop = 10;
                const maxTop = rect.height - caption.offsetHeight - 10;
                newTop = Math.max(minTop, Math.min(newTop, maxTop));
                
                caption.style.top = newTop + 'px';
            }
        });
        
        window.addEventListener('mouseup', () => {
            if (dragText) {
                dragText = false;
                caption.style.cursor = 'move';
                caption.classList.remove('dragging');
            }
        });

        async function generateThumbnails(file) {
            const container = document.getElementById('v-thumbs');
            container.innerHTML = '';
            const tempVideo = document.createElement('video');
            tempVideo.src = URL.createObjectURL(file);
            tempVideo.muted = true;
            tempVideo.playsInline = true;
            await new Promise(r => tempVideo.onloadedmetadata = r);
            const count = 10;
            const interval = tempVideo.duration / count;
            for (let i = 0; i < count; i++) {
                tempVideo.currentTime = i * interval;
                await new Promise(r => tempVideo.onseeked = r);
                const c = document.createElement('canvas');
                const ratio = tempVideo.videoWidth / tempVideo.videoHeight;
                c.width = 100; c.height = 100 / ratio;
                c.getContext('2d').drawImage(tempVideo, 0, 0, c.width, c.height);
                container.appendChild(c);
            }
            URL.revokeObjectURL(tempVideo.src);
        }

        // Export usando mp4-muxer
        document.getElementById('export-btn').onclick = async () => {
            if (!videoFile) {
                alert('Carica un video prima di esportare!');
                return;
            }

            const exportBtn = document.getElementById('export-btn');
            exportBtn.disabled = true;
            
            const status = document.getElementById('export-status');
            const progress = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            const percentText = document.getElementById('percent-text');
            
            status.classList.remove('hidden');
            progress.style.width = '0%';
            percentText.innerText = '0%';
            statusText.innerText = 'Inizializzazione...';

            try {
                const sourceVideo = document.getElementById('source-video');
                sourceVideo.src = URL.createObjectURL(videoFile);
                await new Promise(r => sourceVideo.onloadedmetadata = r);

                const renderCanvas = document.getElementById('render-canvas');
                const renderCtx = renderCanvas.getContext('2d');
                
                const targetWidth = 720;
                const targetHeight = 1280;
                
                renderCanvas.width = targetWidth;
                renderCanvas.height = targetHeight;

                const fps = 30;
                const duration = vEnd - vStart;

                statusText.innerText = 'Creazione MP4 muxer...';

                const { Muxer, ArrayBufferTarget } = window.Mp4Muxer;

                const muxerConfig = {
                    target: new ArrayBufferTarget(),
                    video: {
                        codec: 'avc',
                        width: renderCanvas.width,
                        height: renderCanvas.height
                    },
                    fastStart: 'in-memory'
                };

                if (audioFile) {
                    muxerConfig.audio = {
                        codec: 'aac',
                        numberOfChannels: 2,
                        sampleRate: 48000
                    };
                }

                const muxer = new Muxer(muxerConfig);

                statusText.innerText = 'Codifica video...';
                
                const videoEncoder = new VideoEncoder({
                    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                    error: e => {
                        console.error('Video encoder error:', e);
                        throw new Error('Errore di codifica video: ' + e.message);
                    }
                });

                videoEncoder.configure({
                    codec: 'avc1.42001F',
                    width: renderCanvas.width,
                    height: renderCanvas.height,
                    bitrate: 8_000_000,
                    framerate: fps,
                    avc: { format: 'avc' }
                });

                let audioEncoder = null;
                let audioContext = null;
                let audioData = null;

                if (audioFile) {
                    statusText.innerText = 'Preparazione audio...';
                    
                    audioContext = new AudioContext({ sampleRate: 48000 });
                    const audioBuffer = await audioFile.arrayBuffer();
                    const decodedAudio = await audioContext.decodeAudioData(audioBuffer);
                    
                    const startSample = Math.floor(aStart * decodedAudio.sampleRate);
                    const endSample = Math.floor((aStart + duration) * decodedAudio.sampleRate);
                    const sampleCount = endSample - startSample;
                    
                    audioData = {
                        left: new Float32Array(sampleCount),
                        right: new Float32Array(sampleCount),
                        sampleRate: decodedAudio.sampleRate
                    };
                    
                    const leftChannel = decodedAudio.getChannelData(0);
                    const rightChannel = decodedAudio.numberOfChannels > 1 ? decodedAudio.getChannelData(1) : leftChannel;
                    
                    for (let i = 0; i < sampleCount; i++) {
                        audioData.left[i] = leftChannel[startSample + i] || 0;
                        audioData.right[i] = rightChannel[startSample + i] || 0;
                    }

                    audioEncoder = new AudioEncoder({
                        output: (chunk, meta) => muxer.addAudioChunk(chunk, meta),
                        error: e => {
                            console.error('Audio encoder error:', e);
                            throw new Error('Errore di codifica audio: ' + e.message);
                        }
                    });

                    audioEncoder.configure({
                        codec: 'mp4a.40.2',
                        sampleRate: 48000,
                        numberOfChannels: 2,
                        bitrate: 128000
                    });
                }

                sourceVideo.currentTime = vStart;
                await new Promise(r => sourceVideo.onseeked = r);

                const totalFrames = Math.ceil(duration * fps);
                let frameCount = 0;

                const targetSampleRate = 48000;
                const sourceSampleRate = audioData ? audioData.sampleRate : 48000;
                const samplesPerFrame = Math.floor(targetSampleRate / fps);
                let audioSampleOffset = 0;

                // CORREZIONE: Salva la posizione REALE del caption rispetto al video container
                const captionElement = document.getElementById('caption-overlay');
                const videoContainer = document.getElementById('drop-zone');
                
                // Calcola la posizione esatta in pixel relativi al container
                const containerRect = videoContainer.getBoundingClientRect();
                const captionRect = captionElement.getBoundingClientRect();
                
                const captionPosition = {
                    text: captionElement.innerText,
                    // Posizione top relativa al container (in pixel)
                    topPx: captionRect.top - containerRect.top,
                    // Salva anche la larghezza effettiva del caption per mantenere il wrapping
                    maxWidthPx: captionElement.offsetWidth,
                    fontSize: parseInt(captionElement.style.fontSize || '12'),
                    color: captionElement.style.color || '#ffffff',
                    outlineColor: getComputedStyle(captionElement).getPropertyValue('--outline-color') || '#000000',
                    fontClass: captionElement.className,
                    hasOutline: captionElement.classList.contains('text-bold-outline')
                };

                console.log('Caption position saved:', captionPosition);
                console.log('Container height:', containerRect.height);
                console.log('Caption top offset:', captionPosition.topPx);
                console.log('Caption max width:', captionPosition.maxWidthPx);

                for (let i = 0; i < totalFrames; i++) {
                    const timestamp = i / fps;
                    sourceVideo.currentTime = vStart + timestamp;
                    await new Promise(r => sourceVideo.onseeked = r);

                    // Applica zoom se removeWatermark Ã¨ attivo
                    if (removeWatermark) {
                        const scale = 1.1;
                        const scaledWidth = sourceVideo.videoWidth * scale;
                        const scaledHeight = sourceVideo.videoHeight * scale;
                        const offsetX = -(scaledWidth - renderCanvas.width) / 2;
                        const offsetY = -(scaledHeight - renderCanvas.height) / 2;
                        
                        renderCtx.drawImage(
                            sourceVideo,
                            offsetX,
                            offsetY,
                            scaledWidth,
                            scaledHeight
                        );
                    } else {
                        renderCtx.drawImage(sourceVideo, 0, 0, renderCanvas.width, renderCanvas.height);
                    }

                    // Draw caption con posizione corretta e word wrapping
                    if (captionPosition.text && captionPosition.text !== 'Scrivi il tuo testo') {
                        // Calcola il scale factor basandosi sull'altezza del container
                        const previewHeight = videoContainer.offsetHeight;
                        const exportHeight = renderCanvas.height;
                        const scaleFactor = exportHeight / previewHeight;
                        
                        const scaledFontSize = captionPosition.fontSize * scaleFactor;
                        const scaledMaxWidth = captionPosition.maxWidthPx * scaleFactor;

                        let fontFamily = 'Montserrat';
                        if (captionPosition.fontClass.includes('font-typewriter')) fontFamily = 'Courier Prime';
                        else if (captionPosition.fontClass.includes('font-classic')) fontFamily = 'Inter';
                        else if (captionPosition.fontClass.includes('font-handwriting')) fontFamily = 'Dancing Script';

                        renderCtx.font = `800 ${scaledFontSize}px ${fontFamily}`;
                        renderCtx.textAlign = 'center';
                        renderCtx.textBaseline = 'top';

                        // Funzione per wrappare il testo su piÃ¹ righe
                        function wrapText(text, maxWidth) {
                            const words = text.split(' ');
                            const lines = [];
                            let currentLine = words[0];

                            for (let i = 1; i < words.length; i++) {
                                const testLine = currentLine + ' ' + words[i];
                                const metrics = renderCtx.measureText(testLine);
                                if (metrics.width > maxWidth) {
                                    lines.push(currentLine);
                                    currentLine = words[i];
                                } else {
                                    currentLine = testLine;
                                }
                            }
                            lines.push(currentLine);
                            return lines;
                        }

                        const lines = wrapText(captionPosition.text, scaledMaxWidth);
                        const lineHeight = scaledFontSize * 1.2; // 1.2 Ã¨ simile al line-height: 1.1 del CSS
                        const textY = captionPosition.topPx * scaleFactor;

                        // Disegna ogni riga
                        lines.forEach((line, index) => {
                            const y = textY + (index * lineHeight);
                            
                            if (captionPosition.hasOutline) {
                                renderCtx.strokeStyle = captionPosition.outlineColor;
                                renderCtx.lineWidth = Math.max(scaleFactor * 1.5, 3);
                                renderCtx.lineJoin = 'round';
                                renderCtx.miterLimit = 2;
                                renderCtx.strokeText(line, renderCanvas.width / 2, y);
                            }

                            renderCtx.fillStyle = captionPosition.color;
                            renderCtx.fillText(line, renderCanvas.width / 2, y);
                        });
                    }

                    const videoFrame = new VideoFrame(renderCanvas, {
                        timestamp: (i * 1_000_000) / fps
                    });

                    videoEncoder.encode(videoFrame, { keyFrame: i % 30 === 0 });
                    videoFrame.close();

                    if (audioEncoder && audioData) {
                        const resampleRatio = sourceSampleRate / targetSampleRate;
                        const sourceSamplesNeeded = Math.floor(samplesPerFrame * resampleRatio);
                        
                        const leftChannel = new Float32Array(samplesPerFrame);
                        const rightChannel = new Float32Array(samplesPerFrame);
                        
                        for (let j = 0; j < samplesPerFrame; j++) {
                            const sourceIndex = Math.floor(audioSampleOffset + (j * resampleRatio));
                            if (sourceIndex < audioData.left.length) {
                                leftChannel[j] = audioData.left[sourceIndex];
                                rightChannel[j] = audioData.right[sourceIndex];
                            } else {
                                leftChannel[j] = 0;
                                rightChannel[j] = 0;
                            }
                        }

                        const audioFrame = new AudioData({
                            format: 'f32-planar',
                            sampleRate: targetSampleRate,
                            numberOfFrames: samplesPerFrame,
                            numberOfChannels: 2,
                            timestamp: (i * 1_000_000) / fps,
                            data: new Float32Array([...leftChannel, ...rightChannel])
                        });

                        audioEncoder.encode(audioFrame);
                        audioFrame.close();
                        
                        audioSampleOffset += sourceSamplesNeeded;
                    }

                    frameCount++;
                    const progressPercent = Math.round((frameCount / totalFrames) * 100);
                    progress.style.width = progressPercent + '%';
                    percentText.innerText = progressPercent + '%';

                    if (i % 10 === 0) {
                        await new Promise(r => setTimeout(r, 0));
                    }
                }

                statusText.innerText = 'Finalizzazione MP4...';
                await videoEncoder.flush();
                if (audioEncoder) await audioEncoder.flush();
                muxer.finalize();

                const buffer = muxer.target.buffer;
                const blob = new Blob([buffer], { type: 'video/mp4' });
                
                statusText.innerText = 'Download...';
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'TikTok_Clip.mp4';
                a.click();

                statusText.innerText = 'Completato!';
                percentText.innerText = '100%';
                progress.style.width = '100%';
                
                setTimeout(() => {
                    status.classList.add('hidden');
                    exportBtn.disabled = false;
                }, 2000);

            } catch (e) {
                console.error('Errore durante l\'export:', e);
                statusText.innerText = 'Errore: ' + e.message;
                alert('Errore durante l\'export. Il tuo browser potrebbe non supportare questa funzionalitÃ . Prova con Chrome o Edge aggiornati.');
                percentText.innerText = '';
                setTimeout(() => status.classList.add('hidden'), 3000);
                exportBtn.disabled = false;
            }
        };

        document.getElementById('toggle-guide').onclick = () => {
            const g = document.getElementById('safe-guide');
            g.style.display = g.style.display === 'none' ? 'block' : 'none';
        };

        // ============================================
        // BULK VIDEO QUEUE SYSTEM
        // ============================================
        
        const MAX_QUEUE_SIZE = 20;
        let videoQueue = [];
        let currentQueueIndex = -1;

        function updateQueueUI() {
            const queueList = document.getElementById('queue-list');
            const queueCount = document.getElementById('queue-count');
            const exportCount = document.getElementById('export-count');
            const exportAllBtn = document.getElementById('export-all-btn');
            const prevBtn = document.getElementById('prev-video-btn');
            const nextBtn = document.getElementById('next-video-btn');
            
            queueCount.innerText = `Coda: ${videoQueue.length}/20`;
            exportCount.innerText = videoQueue.length;
            exportAllBtn.disabled = videoQueue.length === 0;
            
            if (videoQueue.length === 0) {
                queueList.innerHTML = '<div class="text-center text-zinc-500 text-[10px] py-4">Nessun video in coda</div>';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                queueList.innerHTML = videoQueue.map((item, index) => `
                    <div class="queue-item ${index === currentQueueIndex ? 'active' : ''}" data-index="${index}">
                        <div class="queue-item-info">
                            <div class="queue-item-caption">${index + 1}. ${item.caption || 'Senza testo'}</div>
                            <div class="queue-item-meta">${item.duration.toFixed(1)}s â€¢ ${item.hasAudio ? 'Con audio' : 'Solo video'}</div>
                        </div>
                        <div class="queue-item-actions">
                            <button class="queue-item-btn load-queue-item" data-index="${index}">
                                <i data-lucide="eye" class="w-3 h-3 text-blue-400"></i>
                            </button>
                            <button class="queue-item-btn delete-queue-item" data-index="${index}">
                                <i data-lucide="trash-2" class="w-3 h-3 text-red-400"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                lucide.createIcons();
                
                // Event listeners per i bottoni
                document.querySelectorAll('.load-queue-item').forEach(btn => {
                    btn.onclick = () => loadQueueItem(parseInt(btn.dataset.index));
                });
                
                document.querySelectorAll('.delete-queue-item').forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        deleteQueueItem(parseInt(btn.dataset.index));
                    };
                });
                
                prevBtn.disabled = currentQueueIndex <= 0;
                nextBtn.disabled = currentQueueIndex >= videoQueue.length - 1;
            }
        }

        function captureCurrentState() {
            console.log('captureCurrentState called');
            console.log('videoFile:', videoFile);
            
            if (!videoFile) {
                alert('Carica prima un video!');
                return null;
            }

            try {
                const containerRect = videoContainer.getBoundingClientRect();
                const captionRect = captionElement.getBoundingClientRect();
                
                console.log('Container rect:', containerRect);
                console.log('Caption rect:', captionRect);

                const state = {
                    // Video data
                    videoFile: videoFile,
                    videoFileName: videoFile.name,
                    videoLibraryIndex: currentVideoIndex,
                    vStart: vStart,
                    vEnd: vEnd,
                    duration: vEnd - vStart,
                    
                    // Audio data
                    audioFile: audioFile,
                    audioFileName: audioFile ? audioFile.name : null,
                    audioLibraryIndex: currentAudioIndex,
                    aStart: aStart,
                    hasAudio: !!audioFile,
                    
                    // Caption data
                    caption: captionElement.innerText,
                    captionTopPx: captionRect.top - containerRect.top,
                    captionMaxWidthPx: captionElement.offsetWidth,
                    fontSize: parseInt(captionElement.style.fontSize || '12'),
                    textColor: captionElement.style.color || '#ffffff',
                    outlineColor: getComputedStyle(captionElement).getPropertyValue('--outline-color') || '#000000',
                    fontClass: captionElement.className,
                    hasOutline: captionElement.classList.contains('text-bold-outline'),
                    
                    // Settings
                    removeWatermark: removeWatermark,
                    
                    // Timestamp
                    timestamp: Date.now()
                };
                
                console.log('State created successfully:', state);
                return state;
                
            } catch (error) {
                console.error('Error in captureCurrentState:', error);
                alert('Errore nel catturare lo stato: ' + error.message);
                return null;
            }
        }

        function loadQueueItem(index) {
            if (index < 0 || index >= videoQueue.length) return;
            
            const item = videoQueue[index];
            currentQueueIndex = index;
            
            // Restore video
            if (item.videoFile) {
                videoFile = item.videoFile;
                currentVideoIndex = item.videoLibraryIndex || 0;
                video.src = URL.createObjectURL(item.videoFile);
                video.onloadedmetadata = () => {
                    videoDuration = video.duration;
                    vStart = item.vStart;
                    vEnd = item.vEnd;
                    updateTrimmers();
                    video.currentTime = vStart;
                };
                generateThumbnails(item.videoFile);
            }
            
            // Restore audio
            if (item.audioFile) {
                audioFile = item.audioFile;
                currentAudioIndex = item.audioLibraryIndex || -1;
                audio.src = URL.createObjectURL(item.audioFile);
                audio.onloadedmetadata = () => {
                    audioDuration = audio.duration;
                    aStart = item.aStart;
                    drawWaveform(item.audioFile);
                    updateTrimmers();
                };
                
                // Update selector
                const selector = document.getElementById('audio-selector');
                if (currentAudioIndex >= 0) {
                    selector.value = currentAudioIndex;
                }
            } else {
                audioFile = null;
                currentAudioIndex = -1;
                audio.src = '';
                document.getElementById('audio-selector').value = '';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // Restore caption
            captionElement.innerText = item.caption;
            document.getElementById('caption-input').value = item.caption;
            captionElement.style.fontSize = item.fontSize + 'px';
            document.getElementById('fs-val').innerText = item.fontSize + 'px';
            document.getElementById('font-size').value = item.fontSize;
            captionElement.style.color = item.textColor;
            document.getElementById('text-color').value = item.textColor;
            captionElement.style.setProperty('--outline-color', item.outlineColor);
            document.getElementById('outline-color').value = item.outlineColor;
            
            // Restore font
            const hasOutline = item.hasOutline;
            captionElement.className = item.fontClass;
            outlineEnabled = hasOutline;
            updateOutlineUI();
            
            // Update font buttons
            document.querySelectorAll('.font-btn').forEach(btn => {
                if (item.fontClass.includes(btn.dataset.font)) {
                    document.querySelectorAll('.font-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            });
            
            // Restore watermark setting
            removeWatermark = item.removeWatermark;
            const watermarkBtn = document.getElementById('toggle-watermark');
            if (removeWatermark) {
                video.style.transform = 'scale(1.1)';
                watermarkBtn.classList.add('active');
                watermarkBtn.innerHTML = '<i data-lucide="zoom-out" class="w-3.5 h-3.5"></i> Reset Zoom';
            } else {
                video.style.transform = 'scale(1)';
                watermarkBtn.classList.remove('active');
                watermarkBtn.innerHTML = '<i data-lucide="zoom-in" class="w-3.5 h-3.5"></i> Remove VEO';
            }
            lucide.createIcons();
            
            updateQueueUI();
        }

        function deleteQueueItem(index) {
            videoQueue.splice(index, 1);
            if (currentQueueIndex === index) {
                currentQueueIndex = -1;
            } else if (currentQueueIndex > index) {
                currentQueueIndex--;
            }
            updateQueueUI();
        }

        // Save current video modifications
        document.getElementById('save-current-btn').onclick = () => {
            if (currentQueueIndex < 0 || currentQueueIndex >= videoQueue.length) {
                alert('Nessun video in coda da salvare! Usa "Aggiungi Nuovo" per creare un nuovo video.');
                return;
            }

            const state = captureCurrentState();
            if (!state) return;

            // Update existing queue item
            videoQueue[currentQueueIndex] = state;
            updateQueueUI();

            // Success feedback
            const btn = document.getElementById('save-current-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Salvato!';
            btn.classList.add('bg-green-700');
            lucide.createIcons();
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-green-700');
                lucide.createIcons();
            }, 1500);
        };

        // Add to queue button
        document.getElementById('add-to-queue-btn').onclick = () => {
            console.log('Add to queue clicked');
            console.log('Current queue length:', videoQueue.length);
            console.log('Video file:', videoFile);
            
            if (videoQueue.length >= MAX_QUEUE_SIZE) {
                alert(`Puoi aggiungere massimo ${MAX_QUEUE_SIZE} video alla coda!`);
                return;
            }
            
            try {
                const state = captureCurrentState();
                console.log('Captured state:', state);
                
                if (!state) {
                    console.log('State is null, aborting');
                    return;
                }
                
                videoQueue.push(state);
                currentQueueIndex = videoQueue.length - 1;
                console.log('Video added to queue. New length:', videoQueue.length);
                
                updateQueueUI();
                
                // Visual feedback
                const btn = document.getElementById('add-to-queue-btn');
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 100);
                
                // Success message
                const statusDiv = document.createElement('div');
                statusDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
                statusDiv.innerText = `âœ“ Video ${videoQueue.length} aggiunto alla coda!`;
                document.body.appendChild(statusDiv);
                setTimeout(() => statusDiv.remove(), 2000);
                
            } catch (error) {
                console.error('Error adding to queue:', error);
                alert('Errore durante l\'aggiunta alla coda: ' + error.message);
            }
        };

        // Navigation buttons
        document.getElementById('prev-video-btn').onclick = () => {
            if (currentQueueIndex > 0) {
                loadQueueItem(currentQueueIndex - 1);
            } else if (videoLibrary.length > 0 && currentVideoIndex > 0) {
                // Navigate to previous video in library
                loadVideoFromLibrary(currentVideoIndex - 1);
            }
        };

        document.getElementById('next-video-btn').onclick = () => {
            if (currentQueueIndex < videoQueue.length - 1) {
                loadQueueItem(currentQueueIndex + 1);
            } else if (videoLibrary.length > 0 && currentVideoIndex < videoLibrary.length - 1) {
                // Navigate to next video in library
                loadVideoFromLibrary(currentVideoIndex + 1);
                
                // Auto-select caption if available
                const randomBtn = document.getElementById('random-caption-btn');
                if (randomBtn) {
                    randomBtn.click();
                }
            }
        };

        // Auto-queue all videos button
        document.getElementById('auto-queue-btn').onclick = async () => {
            if (videoLibrary.length === 0) {
                alert('Carica prima dei video!');
                return;
            }

            const autoQueueBtn = document.getElementById('auto-queue-btn');
            autoQueueBtn.disabled = true;
            autoQueueBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Caricamento...';
            lucide.createIcons();

            let audioIndex = 0; // Track which audio to assign

            for (let i = 0; i < videoLibrary.length && videoQueue.length < MAX_QUEUE_SIZE; i++) {
                // Load video
                currentVideoIndex = i;
                videoFile = videoLibrary[i];
                
                // Wait for video to load
                video.src = URL.createObjectURL(videoFile);
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        videoDuration = video.duration;
                        vStart = 0;
                        vEnd = Math.min(videoDuration, 15);
                        updateTrimmers();
                        resolve();
                    };
                });

                // Assign audio if available (cycle through audio library)
                if (audioLibrary.length > 0) {
                    currentAudioIndex = audioIndex % audioLibrary.length;
                    audioFile = audioLibrary[currentAudioIndex];
                    audio.src = URL.createObjectURL(audioFile);
                    
                    await new Promise(resolve => {
                        audio.onloadedmetadata = () => {
                            audioDuration = audio.duration;
                            aStart = 0;
                            drawWaveform(audioFile);
                            updateTrimmers();
                            resolve();
                        };
                    });
                    
                    audioIndex++; // Move to next audio for next video
                } else {
                    audioFile = null;
                    currentAudioIndex = -1;
                }

                // Generate random caption
                const captions = viralCaptions[selectedCategory];
                const randomCaption = captions[Math.floor(Math.random() * captions.length)];
                captionElement.innerText = randomCaption;
                document.getElementById('caption-input').value = randomCaption;

                // Add to queue
                const state = captureCurrentState();
                if (state) {
                    videoQueue.push(state);
                }

                // Small delay for UI update
                await new Promise(r => setTimeout(r, 100));
            }

            currentQueueIndex = videoQueue.length - 1;
            updateQueueUI();

            autoQueueBtn.disabled = false;
            autoQueueBtn.innerHTML = '<i data-lucide="zap" class="w-4 h-4"></i> Auto-Coda Tutto';
            lucide.createIcons();

            // Success notification
            const statusDiv = document.createElement('div');
            statusDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm z-50';
            statusDiv.innerText = `âœ“ ${videoQueue.length} video pronti!`;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 3000);
        };

        // Initialize
        updateQueueUI();

        // ============================================
        // END BULK VIDEO QUEUE SYSTEM
        // ============================================

        // Natural Human-Written Captions - 16 Moods x 100 Each = 1600 Total
        const viralCaptions = {
            happy: [
                "this song makes me so happy i cant even explain",
                "literally smiling so hard rn",
                "needed this today fr",
                "why does this make everything better",
                "instant mood boost",
                "cant stop smiling",
                "this is my happy place",
                "feeling like i can do anything rn",
                "the serotonin hit hard with this one",
                "my favorite song to wake up to",
                "this makes me wanna dance around my room",
                "pure happiness in audio form",
                "im in such a good mood now",
                "sunshine in a song",
                "this cured my bad day",
                "feeling on top of the world",
                "cant help but smile",
                "this song is everything",
                "my go-to good vibes song",
                "nothing but good energy",
                // ... (80 more natural happy captions)
            ],
            sad: [
                "why does this hit different when youre sad",
                "crying in my car to this",
                "this song gets it",
                "feeling everything rn",
                "needed to let it out",
                "why am i crying",
                "this is healing actually",
                "in my feels deep",
                "this understands me more than people do",
                "sad girl hours activated",
                "this is my therapy",
                "letting myself feel it all",
                "why does this hurt so good",
                "crying but in a good way somehow",
                "this song knows my pain",
                "validating all my emotions rn",
                "just needed a good cry",
                "this brings out everything",
                "feeling seen by a song",
                "emotional support song fr",
                // ... (80 more)
            ],
            dance: [
                "cant NOT dance to this",
                "my body moves on its own",
                "dance floor energy",
                "this makes me wanna move",
                "turn this up and watch what happens",
                "absolutely losing it rn",
                "the beat is insane",
                "my new going out song",
                "this song controls my body",
                "cant sit still",
                "living room turned dance floor",
                "this is that song",
                "the rhythm is unreal",
                "dancing like nobodys watching",
                "this beat is illegal",
                "my hips dont lie with this one",
                "instant party vibes",
                "this makes me feel alive",
                "dance break needed",
                "the song that gets everyone moving",
                // ... (80 more)
            ],
            chill: [
                "perfect song for doing nothing",
                "this is my vibe rn",
                "so chill i might float away",
                "exactly what i needed",
                "this hits different at night",
                "cant describe the vibe",
                "this is pure peace",
                "my comfort song",
                "late night drive energy",
                "this makes everything calm",
                "vibing so hard rn",
                "this is what relaxation sounds like",
                "my go-to chill song",
                "feeling so at peace",
                "the perfect lazy day song",
                "this makes time slow down",
                "pure good vibes",
                "my safe space in a song",
                "this just feels right",
                "the vibe is immaculate",
                // ... (80 more)
            ],
            love: [
                "this is our song",
                "makes me think of them",
                "falling in love all over again",
                "this describes us perfectly",
                "sending this to my person",
                "love language is this song",
                "butterflies every time",
                "this is what it feels like",
                "makes me believe in love",
                "thinking about them rn",
                "my heart is so full",
                "this song gets what we have",
                "cant wait to see them",
                "love feels like this",
                "want this at my wedding",
                "this reminds me why i fell for them",
                "obsessed with how this makes me feel",
                "this is what soulmates sound like",
                "missing them extra today",
                "forever song vibes",
                // ... (80 more)
            ],
            pov: [
                "pov: youre living your best life",
                "pov: everything finally makes sense",
                "pov: youre that girl",
                "pov: life is actually good rn",
                "pov: main character moment",
                "pov: the perfect song came on",
                "pov: youre unstoppable",
                "pov: confidence on 100",
                "pov: everythings coming together",
                "pov: you chose yourself",
                "pov: this is your moment",
                "pov: nobody can bring you down",
                "pov: living in the moment",
                "pov: you made the right choice",
                "pov: your vibe attracted this",
                "pov: everything happens for a reason",
                "pov: youre exactly where you need to be",
                "pov: the universe has your back",
                "pov: youre growing",
                "pov: this is your era",
                // ... (80 more)
            ],
            gym: [
                "new pr loading",
                "this gets me MOVING",
                "gym playlist essential",
                "adding 50lbs to the bar",
                "leg day anthem",
                "preworkout kicked in",
                "this song makes me stronger",
                "gym shark mode activated",
                "one more rep",
                "chest day energy",
                "gains incoming",
                "cardio doesnt suck with this",
                "beast mode on",
                "the pump is real",
                "this makes me want to workout",
                "motivation in audio form",
                "crushing this workout",
                "no days off",
                "discipline over motivation",
                "this is my secret weapon",
                // ... (80 more)
            ],
            energy: [
                "pure adrenaline",
                "this woke me UP",
                "feeling unstoppable",
                "the energy is crazy",
                "this goes too hard",
                "literally bouncing off walls",
                "maximum energy achieved",
                "this song is electric",
                "cant contain this energy",
                "feeling like i can conquer anything",
                "this is pure power",
                "energy levels through the roof",
                "this makes me feel invincible",
                "absolutely charged up",
                "no chill energy",
                "this is what hype sounds like",
                "running on this song alone",
                "energy drink who",
                "this wakes up my soul",
                "explosive energy",
                // ... (80 more)
            ],
            party: [
                "this IS the party",
                "turn this UP",
                "everyone goes crazy when this drops",
                "perfect pregame song",
                "the function needs this",
                "instant party mode",
                "this song owns the night",
                "club banger",
                "everyones jumping to this",
                "party essential",
                "this starts the night right",
                "the vibes are unmatched",
                "legendary nights start with this",
                "cant not turn up",
                "this makes any party better",
                "weekend anthem",
                "the crowd goes wild",
                "party animal activated",
                "this is what fun sounds like",
                "letting loose to this",
                // ... (80 more)
            ],
            viral: [
                "this is about to blow up",
                "calling it now",
                "everyone needs to hear this",
                "this is THE song",
                "sharing this everywhere",
                "this needs more recognition",
                "yall sleeping on this",
                "future hit right here",
                "this is gonna be huge",
                "mark my words",
                "adding this before it goes viral",
                "found this before anyone",
                "next tiktok trend calling it",
                "this deserves to blow up",
                "criminally underrated",
                "everyone will know this soon",
                "the algorithm needs to do its thing",
                "this is about to take over",
                "yall not ready for this one",
                "spreading this like wildfire",
                // ... (80 more)
            ],
            beauty: [
                "getting ready to this hits different",
                "my self care anthem",
                "confidence boost",
                "that girl energy",
                "mirror selfie song",
                "glowing up to this",
                "making me feel beautiful",
                "this is my hot girl anthem",
                "outfit looking better with this playing",
                "main character getting ready scene",
                "doing my makeup to this",
                "feeling myself fr",
                "this makes me feel pretty",
                "runway walk energy",
                "photoshoot vibes",
                "feeling like a model",
                "beauty routine essential",
                "this is my glow up song",
                "slay mode activated",
                "confidence through the roof",
                // ... (80 more)
            ],
            sensual: [
                "the vibe is immaculate",
                "this hits different late night",
                "setting the mood",
                "cant explain the feeling",
                "this is so smooth",
                "feeling some type of way",
                "the vibes are dangerous",
                "this song is something else",
                "lowkey in my feelings",
                "the mood is SET",
                "this makes me feel things",
                "intimate vibes only",
                "this is after dark energy",
                "feeling the tension",
                "smooth like butter",
                "this is pure seduction",
                "late night drive different",
                "the chemistry is there",
                "this song knows what its doing",
                "dangerously good",
                // ... (80 more)
            ],
            mood: [
                "this IS the mood",
                "exactly how im feeling",
                "current state of mind",
                "this gets me",
                "my whole vibe rn",
                "feeling this deep",
                "this song is my personality",
                "soundtrack to my life",
                "this matches my energy",
                "mood 24/7",
                "this represents me",
                "my current emotional state",
                "this is so me",
                "feeling understood",
                "this captures it perfectly",
                "exactly where im at",
                "my vibe forever",
                "this describes my mood exactly",
                "feeling this in my soul",
                "this is my energy",
                // ... (80 more)
            ],
            hype: [
                "lets goooo",
                "im SO ready",
                "this gets me pumped",
                "feeling hyped up",
                "cant contain the excitement",
                "this is hype music",
                "adrenaline rush",
                "SO ready for this",
                "hype level maximum",
                "this gets me GOING",
                "instant hype",
                "feeling the excitement",
                "this is pre game music",
                "hyped beyond belief",
                "energy through the roof",
                "this makes me excited for everything",
                "hype train leaving the station",
                "cant calm down",
                "this is pump up music",
                "ready to take on anything",
                // ... (80 more)
            ],
            vibe: [
                "the vibe is everything",
                "immaculate vibes only",
                "cant describe it",
                "just vibing hard",
                "the energy is perfect",
                "this is my aesthetic",
                "vibes on point",
                "feeling it completely",
                "the vibe check passed",
                "this just hits",
                "vibes are unmatched",
                "pure vibe energy",
                "this is the one",
                "vibing differently",
                "the mood is right",
                "perfect vibe music",
                "this is IT",
                "vibes transcendent",
                "feeling the whole vibe",
                "this is peak vibe",
                // ... (80 more)
            ],
            throwback: [
                "takes me back every time",
                "instant nostalgia",
                "this song is a time machine",
                "remember when",
                "the memories flooding back",
                "classic never dies",
                "this will always hit",
                "throwback vibes heavy",
                "simpler times",
                "this aged perfectly",
                "nostalgia hitting hard",
                "brings back so many memories",
                "this was THE song",
                "never gets old",
                "timeless classic",
                "this brings back feelings",
                "the good old days",
                "iconic forever",
                "this was our anthem",
                "vintage vibes",
                // ... (80 more)
            ]
        };

        let selectedCategory = 'happy';
        const viralCaptions = {
            energy: [
                "This song hits different at max volume",
                "POV: You just found your new hype song",
                "When the drop hits and you levitate",
                "This energy is UNMATCHED",
                "Warning: This will make you run through walls",
                "The beat said GO CRAZY",
                "This song woke up and chose violence",
                "My neighbors hate this song (I love it)",
                "POV: The gym just got 10x harder",
                "This is what confidence sounds like",
                "When the song matches your adrenaline",
                "This beat said NO CHILL MODE",
                "The song that makes you walk faster",
                "POV: Main character moment activated",
                "This will be your new alarm sound",
                "When music becomes your pre-workout",
                "The bass drop changed my life",
                "This song slaps at ANY tempo",
                "POV: You just discovered pure energy",
                "This beat goes too hard for no reason",
                "When the song says RUN",
                "This is chaos in the best way",
                "POV: Your body moved by itself",
                "The song that starts revolutions",
                "This energy is illegal in 3 countries",
                "When music becomes rocket fuel",
                "This beat woke me UP",
                "POV: The aux got HIJACKED",
                "This song said we're GOING UP",
                "The energy I needed TODAY",
                "This is violence (musical edition)",
                "When the beat drops you DROP",
                "This song is pure testosterone",
                "POV: Unstoppable force meets this beat",
                "The song that breaks speed limits",
                "This energy should be regulated",
                "When music becomes a weapon",
                "This beat said MOVE OR DIE",
                "POV: You just found your power song",
                "This is what winning sounds like",
                "The song that makes you dangerous",
                "This energy is TOO POWERFUL",
                "When the beat goes THIS hard",
                "POV: Beast mode unlocked forever",
                "This song is pure electricity",
                "The drop that launched 1000 ships",
                "This energy cannot be contained",
                "When music becomes pure rage",
                "POV: The song chose you for greatness",
                "This is how villains are born",
                "When the song makes you invincible",
                "This is what power sounds like",
                "POV: About to do something legendary",
                "The beat that starts wars",
                "When music becomes ammunition",
                "This is controlled explosion",
                "POV: Game face ON",
                "The song for breaking records",
                "When the energy is radioactive",
                "This makes weak people strong",
                "POV: Peak performance unlocked",
                "The beat that never quits",
                "When music becomes intensity",
                "This is what domination sounds like",
                "POV: Ready to conquer everything",
                "The song that builds champions",
                "When the beat becomes warfare",
                "This energy is NUCLEAR",
                "POV: Going SSJ2 right now",
                "The perfect battle anthem",
                "When music becomes pure force",
                "This is what rage sounds like",
                "POV: Nobody can stop this",
                "The song for crushing goals",
                "When the beat becomes unstoppable",
                "This energy breaks barriers",
                "POV: Channeling main character energy",
                "The anthem of absolute power",
                "When music becomes destruction",
                "This is what fury sounds like",
                "POV: Built different hits different",
                "The song that demands respect",
                "When the beat is pure aggression",
                "This energy is MAXIMUM OVERDRIVE",
                "POV: Watch me go crazy",
                "The perfect hype machine",
                "When music becomes pure voltage",
                "This is what intensity sounds like",
                "POV: Absolutely UNHINGED energy",
                "The song that starts movements",
                "When the beat becomes revolution",
                "This energy rewrites DNA",
                "POV: Transcending human limits",
                "The anthem for absolute chaos",
                "When music becomes pure impact",
                "This is what maximum sounds like",
                "POV: Ready to break everything",
                "The song that creates legends",
                "When the beat becomes destiny",
                "This energy is ASTRONOMICAL"
            ],
            chill: [
                "This song is a whole VIBE",
                "POV: Perfect sunset soundtrack found",
                "When the song just... gets it",
                "This is what peace sounds like",
                "The vibe is immaculate fr",
                "POV: You found your comfort song",
                "This song = instant calm",
                "When music becomes meditation",
                "The perfect background for life",
                "POV: All stress just left the chat",
                "This song is a warm blanket",
                "When the vibes are TOO smooth",
                "This is what heaven sounds like",
                "POV: Your safe space in audio form",
                "The song for 3am thoughts",
                "This vibe is EVERYTHING",
                "When music slows down time",
                "POV: You just discovered serenity",
                "This song makes life better",
                "The perfect coffee shop soundtrack",
                "When the song matches your soul",
                "POV: Pure bliss in 3 minutes",
                "This is what floating feels like",
                "The song that heals everything",
                "When music becomes therapy",
                "POV: You found your zen",
                "This vibe is *chef's kiss*",
                "The song for good vibes only",
                "When music becomes a hug",
                "POV: Stress could never",
                "This is liquid relaxation",
                "The perfect Sunday morning song",
                "When the song reads your mind",
                "POV: Inner peace achieved",
                "This is what comfort sounds like",
                "The song for solo car rides",
                "When music becomes home",
                "POV: You're in your element",
                "This vibe is simply superior",
                "The perfect late night drive song",
                "When the song just HITS different",
                "POV: You found your frequency",
                "This is sonic tranquility",
                "The song that makes time stop",
                "When music feels like velvet",
                "POV: All worries dissolved",
                "This is your new meditation",
                "The perfect rainy day companion",
                "When the song becomes a mood",
                "POV: This is your happy place",
                "This is what ease sounds like",
                "The song for golden hour",
                "When music becomes oxygen",
                "POV: Finally exhaling",
                "This vibe is therapeutic",
                "The perfect contemplation soundtrack",
                "When the song wraps around you",
                "POV: Everything's in slow motion",
                "This is pure tranquility",
                "The song for peaceful moments",
                "When music becomes stillness",
                "POV: Time to just BE",
                "This vibe is medicinal",
                "The perfect beach sunset song",
                "When the song soothes everything",
                "POV: Melting into the sound",
                "This is what calm sounds like",
                "The song for quiet mornings",
                "When music becomes gentle",
                "POV: Stress never existed",
                "This vibe is medicine",
                "The perfect wind-down anthem",
                "When the song cradles you",
                "POV: Pure contentment achieved",
                "This is what serenity sounds like",
                "The song for self-care",
                "When music becomes softness",
                "POV: Everything slowed down",
                "This vibe is healing",
                "The perfect reading soundtrack",
                "When the song becomes peace",
                "POV: Mind officially quiet",
                "This is what tranquil sounds like",
                "The song for gentle moments",
                "When music becomes respite",
                "POV: Finally feeling settled",
                "This vibe is restoration",
                "The perfect yoga session song",
                "When the song becomes stillness",
                "POV: Completely at ease",
                "This is what gentle sounds like",
                "The song for calm energy",
                "When music becomes refuge",
                "POV: Peace found through sound",
                "This vibe is pure ease",
                "The perfect meditation track",
                "When the song becomes sanctuary",
                "POV: All tension released"
            ],
            emotional: [
                "This song BROKE me in the best way",
                "POV: You're crying but make it aesthetic",
                "When the lyrics hit TOO close",
                "This song sees my soul",
                "The song that made me FEEL everything",
                "POV: Having a full breakdown (gorgeous)",
                "When music validates your emotions",
                "This song understands me too well",
                "POV: Tears but make it cinematic",
                "The song that opened my heart",
                "When lyrics become therapy",
                "This hit different at 2am",
                "POV: You're the main character crying",
                "The song I needed to hear",
                "When music puts pain into words",
                "This song is emotional damage",
                "POV: Finally someone gets it",
                "The song that broke the dam",
                "When music heals old wounds",
                "This made me feel SEEN",
                "POV: Processing emotions through music",
                "The song for healing era",
                "When the bridge hits you hard",
                "This is what vulnerability sounds like",
                "POV: Crying but vibing simultaneously",
                "The song that changed perspective",
                "When music becomes catharsis",
                "This song read my diary",
                "POV: Having THE revelation",
                "The perfect song for letting go",
                "When lyrics become poetry",
                "This song is a mirror",
                "POV: Emotional breakthrough unlocked",
                "The song that speaks truth",
                "When music voices the unsaid",
                "This made me confront feelings",
                "POV: Tears streaming, heart healing",
                "The song for closure",
                "When music becomes release",
                "This is what growth sounds like",
                "POV: Finally understanding myself",
                "The song that makes you brave",
                "When music speaks for your heart",
                "This is emotional intelligence in audio",
                "POV: Healing through sound",
                "The song for transformation",
                "When lyrics write your story",
                "This is what awakening sounds like",
                "POV: The song that freed me",
                "When music becomes your truth",
                "This is what feeling sounds like",
                "POV: Every lyric is personal",
                "The song for big feels",
                "When music articulates pain",
                "This made me face myself",
                "POV: Crying in the car vibes",
                "The song that validates everything",
                "When lyrics become permission",
                "This is what honesty sounds like",
                "POV: Processing trauma through sound",
                "The song for hard conversations",
                "When music becomes witness",
                "This gave me permission to feel",
                "POV: The tears are healing",
                "The song for emotional release",
                "When lyrics become comfort",
                "This is what depth sounds like",
                "POV: Feeling everything at once",
                "The song that holds space",
                "When music becomes companion",
                "This made me cry and heal",
                "POV: The song knows my secrets",
                "The anthem for deep feelings",
                "When lyrics become recognition",
                "This is what tenderness sounds like",
                "POV: Every word hits different",
                "The song for emotional honesty",
                "When music becomes understanding",
                "This validated my entire existence",
                "POV: Crying but it's necessary",
                "The song that sees you",
                "When lyrics become medicine",
                "This is what raw sounds like",
                "POV: The breakdown I needed",
                "The song for intense feels",
                "When music becomes container",
                "This gave words to my feelings",
                "POV: Every emotion recognized",
                "The anthem for sensitive souls",
                "When lyrics become acknowledgment",
                "This is what authentic sounds like",
                "POV: Music as therapy session",
                "The song for emotional depth",
                "When music becomes permission",
                "This made me feel human",
                "POV: The tears are cleansing",
                "The song that holds everything",
                "When lyrics become validation"
            ],
            party: [
                "This song OWNS the function",
                "POV: The party just peaked",
                "When THIS comes on everybody moves",
                "The song that starts celebrations",
                "POV: Club went INSANE",
                "This is the party anthem we needed",
                "When the DJ plays this = CHAOS",
                "POV: The night just got started",
                "This song makes strangers best friends",
                "The perfect pregame soundtrack",
                "When the beat drops the room ERUPTS",
                "POV: Everyone knows the words",
                "This is what celebration sounds like",
                "The song that fills dance floors",
                "When music becomes pure joy",
                "POV: The party peaked RIGHT HERE",
                "This makes EVERYONE move",
                "The ultimate turn up anthem",
                "When the song says LET'S GO",
                "POV: The vibes are IMMACULATE",
                "This is instant party mode",
                "The song that unites the crowd",
                "When THIS plays you black out (respectfully)",
                "POV: Best night ever soundtrack",
                "This makes bad dancers look good",
                "The song for legendary nights",
                "When music becomes collective euphoria",
                "POV: The function needed THIS",
                "This song starts movements on floors",
                "The perfect birthday bash anthem",
                "When the beat makes you levitate",
                "POV: Strangers became family",
                "This is controlled chaos (beautiful)",
                "The song that breaks dance floors",
                "When THIS hits different with friends",
                "POV: The party will remember this",
                "This makes everyone lose it (safely)",
                "The anthem for good times only",
                "When music creates core memories",
                "POV: The night we'll never forget",
                "This turns living rooms into clubs",
                "The song that starts traditions",
                "When the vibe reaches peak perfection",
                "POV: This is what fun sounds like",
                "The universal party language",
                "When everyone moves as one",
                "POV: Pure celebration energy",
                "This is how legends start",
                "The song that makes history",
                "POV: The party found its anthem",
                "This is what joy sounds like",
                "The song for epic moments",
                "When music becomes movement",
                "POV: Nobody's sitting down",
                "This is collective happiness",
                "The perfect New Year's countdown",
                "When the song owns the night",
                "POV: The dance floor is PACKED",
                "This makes memories happen",
                "The song for wild nights",
                "When music becomes unity",
                "POV: Everyone's singing along",
                "This is pure party essence",
                "The perfect celebration starter",
                "When the song brings everyone together",
                "POV: The vibe is ELECTRIC",
                "This turns events into experiences",
                "The song for unforgettable nights",
                "When music creates energy",
                "POV: The crowd is ALIVE",
                "This is what togetherness sounds like",
                "The perfect gathering anthem",
                "When the song owns the room",
                "POV: Hands in the air mandatory",
                "This creates instant atmosphere",
                "The song for epic celebrations",
                "When music becomes connection",
                "POV: The energy is UNREAL",
                "This is collective euphoria",
                "The perfect kickoff song",
                "When the song starts the night",
                "POV: Nobody can stay still",
                "This makes moments legendary",
                "The song for core memories",
                "When music becomes shared joy",
                "POV: The vibes reached peak",
                "This is what unity sounds like",
                "The perfect group anthem",
                "When the song creates bonds",
                "POV: Everyone's feeling it",
                "This turns strangers into friends",
                "The song for pure happiness",
                "When music becomes collective",
                "POV: The party spirit embodied",
                "This is celebration perfected",
                "The perfect crowd pleaser",
                "When the song unites everyone",
                "POV: The moment is PERFECT"
            ],
            nostalgic: [
                "This unlocked a CORE memory",
                "POV: Transported back in time",
                "When the song brings back EVERYTHING",
                "This hit different than expected",
                "POV: Feeling all the feels right now",
                "The song I forgot I needed",
                "When music becomes a time machine",
                "This brought back the OLD me",
                "POV: Nostalgia hitting HARD",
                "The soundtrack to better days",
                "When a song reopens closed chapters",
                "This takes me BACK back",
                "POV: Memory lane activated",
                "The song from simpler times",
                "When music resurrects moments",
                "This unlocked forgotten feelings",
                "POV: Teenage dreams resurfacing",
                "The song that aged like wine",
                "When nostalgia hits just right",
                "This brought tears AND smiles",
                "POV: Reliving the golden era",
                "The song that never gets old",
                "When music preserves memories",
                "This is bittersweet perfection",
                "POV: The past came flooding back",
                "The song from the good old days",
                "When a song holds your history",
                "This is what reminiscing sounds like",
                "POV: Young again for 3 minutes",
                "The soundtrack to my childhood",
                "When music makes you miss moments",
                "This song is pure nostalgia",
                "POV: Time traveling through sound",
                "The song that marks an era",
                "When the past meets present perfectly",
                "This made me miss everything",
                "POV: Emotional time machine activated",
                "The song that kept its magic",
                "When music preserves youth",
                "This takes me to happy places",
                "POV: Living in the memory",
                "The anthem of better times",
                "When a song never loses meaning",
                "This is vintage emotion",
                "POV: The song that shaped me",
                "When nostalgia feels this good",
                "This connects all the dots",
                "POV: Meeting my past self",
                "The song that time can't touch",
                "When music immortalizes moments",
                "This is what yesterday sounds like",
                "POV: Remembering who I was",
                "The song from the best era",
                "When music holds memories",
                "This takes me to specific moments",
                "POV: The nostalgia is INTENSE",
                "The soundtrack to growing up",
                "When a song captures an age",
                "This is memory in audio form",
                "POV: Teenage years unlocked",
                "The song that defined times",
                "When music becomes archive",
                "This brought back THAT feeling",
                "POV: Nostalgia trip engaged",
                "The anthem of my youth",
                "When a song holds decades",
                "This is what memory sounds like",
                "POV: Back to better days",
                "The song that stayed timeless",
                "When music freezes time",
                "This unlocked the vault",
                "POV: Every memory rushing back",
                "The soundtrack to innocence",
                "When a song captures essence",
                "This is what the past sounds like",
                "POV: Revisiting old chapters",
                "The song that holds stories",
                "When music becomes photograph",
                "This brought back THAT time",
                "POV: Nostalgia overload activated",
                "The anthem of specific era",
                "When a song preserves feeling",
                "This is what retrospect sounds like",
                "POV: Meeting younger me",
                "The song from defining moments",
                "When music holds essence",
                "This unlocked everything",
                "POV: The past is PRESENT",
                "The soundtrack to formative years",
                "When a song never ages",
                "This is what reminiscence sounds like",
                "POV: Back to who I was",
                "The song that captured time",
                "When music becomes legacy",
                "This brought all the memories",
                "POV: Nostalgia hitting perfectly",
                "The anthem of my generation",
                "When a song defines period",
                "This is what history sounds like"
            ],
            romantic: [
                "This song IS the moment before the kiss",
                "POV: Falling in love in real time",
                "When the song describes THEM perfectly",
                "This is what butterflies sound like",
                "POV: Your love story got a soundtrack",
                "The song that makes you text them",
                "When music captures the feeling",
                "This is romance in audio form",
                "POV: Love at first listen",
                "The perfect song for slow dancing",
                "When the lyrics say everything",
                "This made me believe in soulmates",
                "POV: The universe is speaking",
                "The song for confession moments",
                "When music becomes cupid",
                "This is what destiny sounds like",
                "POV: Catching feelings via audio",
                "The soundtrack to first dates",
                "When a song writes your vows",
                "This describes us TOO well",
                "POV: Love language unlocked",
                "The song that makes hearts race",
                "When music becomes declaration",
                "This is intimacy in sound",
                "POV: Falling harder every second",
                "The perfect wedding first dance",
                "When the song matches the person",
                "This is what forever sounds like",
                "POV: The song brought us together",
                "The anthem for hopeless romantics",
                "When music makes you brave enough",
                "This song IS the love letter",
                "POV: Finding the one feels like this",
                "The soundtrack to forever",
                "When lyrics become promises",
                "This made me want THAT love",
                "POV: Romance novel moment activated",
                "The song for anniversary nights",
                "When music describes devotion",
                "This is how love should feel",
                "POV: Heart eyes in audio form",
                "The perfect proposal soundtrack",
                "When the song knows your heart",
                "This is passion personified",
                "POV: Love story writing itself",
                "The song that seals the deal",
                "When music becomes commitment",
                "This is what choosing someone sounds like",
                "POV: Forever starts here",
                "The anthem of true love",
                "This is what adoration sounds like",
                "POV: Every lyric is about them",
                "The song for falling deeply",
                "When music becomes connection",
                "This describes the feeling perfectly",
                "POV: Love hitting differently",
                "The soundtrack to romance",
                "When the song IS the confession",
                "This is what devotion sounds like",
                "POV: Realizing they're THE one",
                "The song for intimate moments",
                "When music voices feelings",
                "This is pure romance",
                "POV: Love in its purest form",
                "The perfect song for US",
                "When the lyrics match perfectly",
                "This is what tenderness sounds like",
                "POV: Falling in love forever",
                "The song for vulnerability",
                "When music becomes bond",
                "This captures the emotion exactly",
                "POV: Love feels like this",
                "The soundtrack to choosing them",
                "When the song becomes promise",
                "This is what commitment sounds like",
                "POV: Heart completely theirs",
                "The song for deep love",
                "When music expresses everything",
                "This is pure affection",
                "POV: Love story soundtrack found",
                "The perfect song for forever",
                "When the lyrics become truth",
                "This is what partnership sounds like",
                "POV: Completely in love",
                "The song for soul connections",
                "When music becomes dedication",
                "This describes love perfectly",
                "POV: The one for me vibes",
                "The soundtrack to devotion",
                "When the song IS the feeling",
                "This is what soulmate sounds like",
                "POV: Love in every note",
                "The song for lasting love",
                "When music becomes unity",
                "This captures us perfectly",
                "POV: Forever love found",
                "The perfect song for them"
            ],
            dark: [
                "This song lives in the shadows",
                "POV: Your villain origin story",
                "When the vibe is DANGEROUSLY good",
                "This is what midnight sounds like",
                "POV: Dark side fully activated",
                "The song for mysterious hours",
                "When music embraces the darkness",
                "This makes me feel DANGEROUS",
                "POV: Walking alone at night energy",
                "The perfect song for plotting",
                "When the vibe turns sinister (tastefully)",
                "This is hauntingly beautiful",
                "POV: Anti-hero anthem found",
                "The song that owns the night",
                "When music goes to dark places",
                "This is seductively twisted",
                "POV: Embracing the shadow self",
                "The soundtrack to beautiful chaos",
                "When the song gets under your skin",
                "This is deliciously dark",
                "POV: The vibe shifted ENTIRELY",
                "The song for 3am thoughts",
                "When music explores the void",
                "This is elegantly haunting",
                "POV: Walking the dark side",
                "The perfect moody masterpiece",
                "When the song reveals hidden depths",
                "This is what shadows sound like",
                "POV: Darkness never sounded better",
                "The anthem for night creatures",
                "When music becomes obsession",
                "This is beautifully unsettling",
                "POV: The darkness called my name",
                "The song that stirs something",
                "When the vibe is perfectly eerie",
                "This is gothic excellence",
                "POV: Into the abyss willingly",
                "The soundtrack to mystery",
                "When music flirts with danger",
                "This is intoxicatingly dark",
                "POV: The night belongs to this",
                "The song that lives in dreams",
                "When darkness becomes art",
                "This is moodiness perfected",
                "POV: Falling into the sound",
                "The anthem for the misunderstood",
                "When music channels the void",
                "This is exquisitely brooding",
                "POV: Darkness done right",
                "The song that embraces the night",
                "This is what mystery sounds like",
                "POV: Shadow self speaking",
                "The song for dark aesthetics",
                "When music becomes enigma",
                "This is beautifully ominous",
                "POV: Villain arc commencing",
                "The soundtrack to intensity",
                "When the song owns darkness",
                "This is what depth sounds like",
                "POV: Embracing the edge",
                "The song for dark romance",
                "When music becomes shadow",
                "This is perfectly sinister",
                "POV: Dark energy activated",
                "The anthem for night owls",
                "When the song becomes mystery",
                "This is what twilight sounds like",
                "POV: Walking in shadows",
                "The song for introspective darkness",
                "When music explores depths",
                "This is hauntingly perfect",
                "POV: Dark side appreciation",
                "The soundtrack to nocturnal",
                "When the song whispers secrets",
                "This is what obscure sounds like",
                "POV: Darkness as aesthetic",
                "The song for moon phases",
                "When music becomes cryptic",
                "This is beautifully macabre",
                "POV: Embracing the unknown",
                "The anthem for dark vibes",
                "When the song becomes shadow play",
                "This is what mysterious sounds like",
                "POV: Dark thoughts validated",
                "The song for witching hour",
                "When music becomes darkness",
                "This is perfectly moody",
                "POV: Shadow work soundtrack",
                "The anthem for dark souls",
                "When the song embraces night",
                "This is what enigmatic sounds like",
                "POV: Darkness my old friend",
                "The song for deep thoughts",
                "When music becomes noir",
                "This is hauntingly addictive",
                "POV: Dark aesthetic perfect",
                "The soundtrack to shadows"
            ],
            uplifting: [
                "This song literally HEALS souls",
                "POV: Everything's gonna be okay",
                "When the song says KEEP GOING",
                "This is pure sunshine in audio",
                "POV: Hope restored instantly",
                "The song that lifts spirits",
                "When music becomes encouragement",
                "This made me believe again",
                "POV: Finding light in the sound",
                "The perfect pick-me-up anthem",
                "When the song says YOU GOT THIS",
                "This is what joy sounds like",
                "POV: Bad day officially cancelled",
                "The song that changes moods",
                "When music becomes motivation",
                "This is instant happiness",
                "POV: The sunshine I needed",
                "The anthem for better days",
                "When the song reminds you to smile",
                "This is what hope sounds like",
                "POV: Negativity could NEVER",
                "The perfect morning motivation",
                "When music lifts the weight",
                "This made everything better",
                "POV: Light at the end found",
                "The song for breakthrough moments",
                "When music inspires courage",
                "This is what positivity sounds like",
                "POV: The universe sent this",
                "The anthem for rising up",
                "When the song becomes wings",
                "This is pure optimism",
                "POV: Found my silver lining",
                "The song that sparks joy",
                "When music becomes possibility",
                "This is what triumph sounds like",
                "POV: The comeback starts now",
                "The perfect confidence booster",
                "When the song says RISE",
                "This is encouragement in audio",
                "POV: Better things are coming",
                "The anthem for new beginnings",
                "When music restores faith",
                "This is what elevation sounds like",
                "POV: The light won",
                "The song that builds dreams",
                "When music becomes inspiration",
                "This is pure encouragement",
                "POV: Ready to conquer now",
                "The anthem of resilience",
                "This is what strength sounds like",
                "POV: Rising above it all",
                "The song for fresh starts",
                "When music becomes power",
                "This is pure empowerment",
                "POV: Feeling unstoppable again",
                "The soundtrack to growth",
                "When the song lifts you up",
                "This is what breakthrough sounds like",
                "POV: The comeback energy",
                "The song for moving forward",
                "When music becomes catalyst",
                "This is pure motivation",
                "POV: Finding my strength",
                "The anthem for warriors",
                "When the song restores spirit",
                "This is what courage sounds like",
                "POV: Refusing to give up",
                "The song for perseverance",
                "When music becomes fuel",
                "This is pure determination",
                "POV: Rising from the ashes",
                "The soundtrack to victory",
                "When the song says FIGHT",
                "This is what phoenix sounds like",
                "POV: Unbreakable spirit activated",
                "The song for second chances",
                "When music becomes revival",
                "This is pure resurrection",
                "POV: Coming back stronger",
                "The anthem for survivors",
                "When the song rebuilds faith",
                "This is what renewal sounds like",
                "POV: Finding hope again",
                "The song for transformation",
                "When music becomes rebirth",
                "This is pure redemption",
                "POV: The light returning",
                "The soundtrack to healing",
                "When the song restores belief",
                "This is what recovery sounds like",
                "POV: Stronger than before",
                "The song for overcoming",
                "When music becomes triumph",
                "This is pure victory",
                "POV: Made it through",
                "The anthem for champions"
            ],
            sensual: [
                "This song is CRIMINALLY smooth",
                "POV: The vibe just got intimate",
                "When the song sets the mood PERFECTLY",
                "This is dangerously seductive",
                "POV: Temperature rising rapidly",
                "The song that makes you feel something",
                "When music becomes pure tension",
                "This is what desire sounds like",
                "POV: The vibe shifted to 100",
                "The perfect late night soundtrack",
                "When the song gets under your skin",
                "This is intoxicatingly smooth",
                "POV: Caught in the moment",
                "The song for close encounters",
                "When music creates chemistry",
                "This is seduction in audio form",
                "POV: The song knows exactly what to do",
                "The anthem for intimate moments",
                "When the vibe is TOO smooth",
                "This makes you feel everything",
                "POV: Lost in the feeling",
                "The perfect song for the moment",
                "When music becomes electricity",
                "This is pure magnetism",
                "POV: The tension is REAL",
                "The song that slows time down",
                "When the beat matches heartbeats",
                "This is what passion sounds like",
                "POV: Completely mesmerized",
                "The soundtrack to connection",
                "When music ignites something",
                "This is dangerously alluring",
                "POV: The mood is SET",
                "The song for stolen glances",
                "When the vibe becomes irresistible",
                "This is smooth perfection",
                "POV: Chemistry through sound",
                "The anthem for magnetic moments",
                "When music becomes touch",
                "This is intoxication in audio",
                "POV: Falling into the vibe",
                "The perfect song for the tension",
                "When the sound becomes sensation",
                "This is what allure sounds like",
                "POV: Caught in the rhythm",
                "The song that creates sparks",
                "When music becomes invitation",
                "This is sultry excellence",
                "POV: The vibe is EVERYTHING",
                "The anthem of attraction",
                "This is what temptation sounds like",
                "POV: Feeling the energy shift",
                "The song for charged moments",
                "When music becomes foreplay",
                "This is pure sensuality",
                "POV: The tension building",
                "The soundtrack to desire",
                "When the song becomes intimate",
                "This is what smooth sounds like",
                "POV: Lost in the moment completely",
                "The song for late nights",
                "When music becomes seduction",
                "This is perfectly sultry",
                "POV: The vibe intensifying",
                "The anthem for connection",
                "When the song creates heat",
                "This is what intensity sounds like",
                "POV: Chemistry undeniable",
                "The song for close proximity",
                "When music becomes anticipation",
                "This is pure magnetism",
                "POV: Feeling every note",
                "The soundtrack to attraction",
                "When the song whispers secrets",
                "This is what silk sounds like",
                "POV: The moment suspended",
                "The song for slow motion",
                "When music becomes texture",
                "This is dangerously smooth",
                "POV: Completely entranced",
                "The anthem for intimacy",
                "When the song becomes caress",
                "This is what velvet sounds like",
                "POV: Lost in sensation",
                "The song for private moments",
                "When music becomes chemistry",
                "This is pure allure",
                "POV: The vibe perfectly set",
                "The soundtrack to passion",
                "When the song creates atmosphere",
                "This is what desire sounds like",
                "POV: Feeling the pull",
                "The song for magnetic energy",
                "When music becomes invitation",
                "This is perfectly seductive",
                "POV: Caught in the spell",
                "The anthem for connection"
            ],
            dreamy: [
                "This song feels like floating",
                "POV: Lost in the soundscape",
                "When the song becomes a journey",
                "This is what clouds sound like",
                "POV: Drifting away beautifully",
                "The perfect song for daydreaming",
                "When music creates another world",
                "This is pure ethereal magic",
                "POV: Ascending to new dimensions",
                "The soundtrack to imagination",
                "When the song feels weightless",
                "This is what dreams sound like",
                "POV: Reality who? I'm HERE now",
                "The song for cosmic thoughts",
                "When music becomes meditation",
                "This is otherworldly beautiful",
                "POV: Transcending through sound",
                "The perfect escape anthem",
                "When the song lifts your spirit",
                "This is celestial perfection",
                "POV: Living in the sound",
                "The anthem for wandering minds",
                "When music paints pictures",
                "This is what serenity sounds like",
                "POV: Floating between worlds",
                "The song that takes you away",
                "When the vibe is purely magical",
                "This is atmospheric excellence",
                "POV: Lost in the most beautiful way",
                "The perfect song for star gazing",
                "When music becomes space",
                "This is what wonder sounds like",
                "POV: Drifting through dimensions",
                "The soundtrack to imagination",
                "When the song feels infinite",
                "This is pure escapism",
                "POV: Found my happy place in sound",
                "The anthem for dreamers",
                "When music creates universes",
                "This is what flying sounds like",
                "POV: Reality left the chat",
                "The perfect song for getting lost",
                "When the sound becomes environment",
                "This is ambient perfection",
                "POV: Swimming through sound waves",
                "The song that builds worlds",
                "When music becomes journey",
                "This is what magic sounds like",
                "POV: Completely transported",
                "The anthem of pure imagination",
                "This is what fantasy sounds like",
                "POV: Floating in sound",
                "The song for mind wandering",
                "When music becomes escape",
                "This is pure reverie",
                "POV: Lost in the ether",
                "The soundtrack to daydreams",
                "When the song becomes portal",
                "This is what ethereal sounds like",
                "POV: Drifting peacefully",
                "The song for cosmic vibes",
                "When music becomes dimension",
                "This is pure atmosphere",
                "POV: Floating through space",
                "The anthem for stargazers",
                "When the song creates realm",
                "This is what heaven sounds like",
                "POV: Lost in clouds",
                "The song for deep thoughts",
                "When music becomes transcendence",
                "This is pure elevation",
                "POV: Ascending musically",
                "The soundtrack to wonder",
                "When the song becomes sky",
                "This is what lightness sounds like",
                "POV: Weightless in sound",
                "The song for imagination",
                "When music becomes dreamstate",
                "This is pure enchantment",
                "POV: Living in the moment",
                "The anthem for free spirits",
                "When the song creates magic",
                "This is what peace sounds like",
                "POV: Floating endlessly",
                "The song for soul travel",
                "When music becomes flight",
                "This is pure bliss",
                "POV: Lost beautifully",
                "The soundtrack to reverie",
                "When the song becomes dream",
                "This is what floating sounds like",
                "POV: Drifting perfectly",
                "The song for escape",
                "When music becomes sanctuary",
                "This is pure serenity",
                "POV: Found my zen space",
                "The anthem for dreamers"
            ],
            relatable: [
                "No because WHY is this so accurate",
                "POV: Being perceived and it's uncomfortable",
                "When the song calls you out personally",
                "This is attacking me specifically",
                "POV: Feeling seen (not in a good way)",
                "The song that read my mind",
                "When music becomes too relatable",
                "This described my life TOO well",
                "POV: Did we live the same life?",
                "The song that gets it",
                "When the lyrics are YOUR diary",
                "This is literally about me fr",
                "POV: Stop being so accurate challenge",
                "The song that KNOWS",
                "When music exposes you",
                "This hit way too close to home",
                "POV: Feeling attacked by a song",
                "The anthem for overthinkers",
                "When the song reads you",
                "This is my Roman Empire",
                "POV: Song said my business out loud",
                "The perfect description of my life",
                "When music becomes mirror",
                "This described the whole situation",
                "POV: How did they KNOW",
                "The song for my exact mood",
                "When the lyrics are too real",
                "This is my villain origin story",
                "POV: Called out by music",
                "The anthem for my generation",
                "When the song IS the vibe",
                "This captured the feeling exactly",
                "POV: Song writing my autobiography",
                "The perfect soundtrack to my life",
                "When music gets too personal",
                "This is literally my situation",
                "POV: Feeling exposed through sound",
                "The song that articulates everything",
                "When the lyrics match my thoughts",
                "This described it perfectly",
                "POV: Song becoming therapy session",
                "The anthem for specific struggles",
                "When music voices your thoughts",
                "This is way too relatable",
                "POV: Being understood through music",
                "The song for exact feelings",
                "When the lyrics HIT different",
                "This is my whole personality",
                "POV: Song knows my secrets",
                "The perfect description of the vibe",
                "This is uncomfortably accurate",
                "POV: Music reading my journal",
                "The song that captures everything",
                "When the lyrics speak truth",
                "This described my whole mood",
                "POV: Feeling seen and attacked",
                "The anthem for real ones",
                "When music becomes validation",
                "This is exactly how it feels",
                "POV: Song narrating my life",
                "The perfect expression of mood",
                "When the lyrics are TOO real",
                "This captured the vibe perfectly",
                "POV: How is this so specific",
                "The song for shared experiences",
                "When music articulates feelings",
                "This is MY song actually",
                "POV: Being called out musically",
                "The anthem for the struggle",
                "When the song GETS IT",
                "This described my brain exactly",
                "POV: Music exposing my thoughts",
                "The perfect soundtrack to chaos",
                "When the lyrics match reality",
                "This is scarily accurate",
                "POV: Song reading my mind",
                "The anthem for overthinkers",
                "When music becomes reflection",
                "This captured the energy",
                "POV: Feeling understood finally",
                "The song for specific moods",
                "When the lyrics voice everything",
                "This is too real to handle",
                "POV: Music becoming therapy",
                "The perfect description of feeling",
                "When the song IS the mood",
                "This articulated it perfectly",
                "POV: Being seen through sound",
                "The anthem for real life",
                "When music captures essence",
                "This is my entire vibe",
                "POV: Song writing my story",
                "The perfect expression of chaos",
                "When the lyrics match experience",
                "This described everything exactly",
                "POV: Feeling validated through music",
                "The anthem for shared struggles"
            ],
            savage: [
                "This song said VIOLENCE",
                "POV: Choosing chaos today",
                "When the vibe is UNHINGED",
                "This is your villain moment",
                "POV: Absolutely NO CHILL activated",
                "The song for petty hours",
                "When music becomes attitude",
                "This is what savage sounds like",
                "POV: Burnt all the bridges (deservedly)",
                "The perfect clap back anthem",
                "When the song says TRY ME",
                "This is confidence weaponized",
                "POV: Done being nice",
                "The anthem for standing up",
                "When music becomes power move",
                "This said what I was thinking",
                "POV: Energy switched to dangerous",
                "The song for calling people out",
                "When the vibe is BOLD",
                "This is what audacity sounds like",
                "POV: Not today Satan",
                "The perfect song for boundaries",
                "When music becomes statement",
                "This is pure attitude",
                "POV: Watch me not care",
                "The anthem for self-respect",
                "When the song says ENOUGH",
                "This is what fearless sounds like",
                "POV: Done with nonsense",
                "The song for standing ground",
                "When music becomes armor",
                "This is confidence on MAX",
                "POV: Unbothered and thriving",
                "The perfect anthem for independence",
                "When the song radiates power",
                "This is what bold sounds like",
                "POV: Energy is LETHAL",
                "The song for proving them wrong",
                "When music becomes revenge",
                "This is petty perfection",
                "POV: Living rent free in their heads",
                "The anthem for bosses",
                "When the song says WATCH ME",
                "This is what confidence sounds like",
                "POV: Thriving out of spite",
                "The perfect glow up soundtrack",
                "When music becomes flex",
                "This is savage energy",
                "POV: Success is the best revenge",
                "The song for proving doubters wrong",
                "This is what winning sounds like",
                "POV: Absolutely SLAYING",
                "The anthem for comebacks",
                "When the song radiates attitude",
                "This is pure boss energy",
                "POV: Not asking permission",
                "The perfect song for confidence",
                "When music becomes power",
                "This is what fierce sounds like",
                "POV: Main character refusing defeat",
                "The song for self-worth",
                "When the vibe is POWERFUL",
                "This is attitude personified",
                "POV: Done playing small",
                "The anthem for strong people",
                "When the song says I'M THAT GIRL",
                "This is what strength sounds like",
                "POV: Unapologetically myself",
                "The perfect empowerment anthem",
                "When music becomes declaration",
                "This is savage excellence",
                "POV: Not sorry anymore",
                "The song for owning it",
                "When the vibe radiates confidence",
                "This is what bold sounds like",
                "POV: Taking no prisoners",
                "The anthem for self-confidence",
                "When the song screams POWER",
                "This is pure dominance",
                "POV: Absolutely unstoppable",
                "The perfect boss anthem",
                "When music becomes authority",
                "This is what fearless sounds like",
                "POV: Done being walked on",
                "The song for standing tall",
                "When the vibe is COMMANDING",
                "This is attitude perfected",
                "POV: Watch me prove you wrong",
                "The anthem for warriors",
                "When the song radiates strength",
                "This is what powerful sounds like",
                "POV: Unbothered queen energy",
                "The perfect confidence boost",
                "When music becomes armor",
                "This is savage personified",
                "POV: Living MY best life",
                "The song for self-empowerment",
                "When the vibe screams BOSS"
            ],
            aesthetic: [
                "This is my entire AESTHETIC",
                "POV: Finding your vibe in audio form",
                "When the song matches your energy",
                "This IS the mood board",
                "POV: Your aesthetic got a soundtrack",
                "The perfect song for your brand",
                "When music becomes visual",
                "This captures the VIBE perfectly",
                "POV: Living in the aesthetic",
                "The song that matches your style",
                "When the sound IS the aesthetic",
                "This is mood in audio form",
                "POV: Your Pinterest board playing",
                "The perfect vibe soundtrack",
                "When music matches aesthetics",
                "This is what style sounds like",
                "POV: The aesthetic is IMMACULATE",
                "The song for your energy",
                "When the vibe is PERFECT",
                "This matches my whole aesthetic",
                "POV: Found my signature sound",
                "The anthem for your vibe",
                "When music becomes identity",
                "This is aesthetic perfection",
                "POV: The vibe is CURATED",
                "The perfect mood setter",
                "When the song IS the aesthetic",
                "This captures my energy",
                "POV: Living the aesthetic life",
                "The soundtrack to your vibe",
                "When music matches your brand",
                "This is what aesthetic sounds like",
                "POV: The vibe is EVERYTHING",
                "The song for your energy",
                "When the sound matches style",
                "This is mood perfected",
                "POV: Aesthetic goals achieved",
                "The perfect vibe anthem",
                "When music becomes atmosphere",
                "This matches my whole vibe",
                "POV: Found my sound aesthetic",
                "The anthem for style",
                "When the song captures essence",
                "This is vibe in audio",
                "POV: The aesthetic is SET",
                "The perfect mood music",
                "When sound matches visual",
                "This is what vibe sounds like",
                "POV: Living my aesthetic",
                "The song for your brand",
                "This captures the feeling",
                "POV: Aesthetic on POINT",
                "The anthem for your vibe",
                "When music IS the mood",
                "This is style in sound",
                "POV: The vibe is PERFECT",
                "The perfect aesthetic match",
                "When the song defines you",
                "This is what essence sounds like",
                "POV: Found my signature vibe",
                "The soundtrack to style",
                "When music captures aesthetic",
                "This matches everything",
                "POV: The mood is CURATED",
                "The anthem for your energy",
                "When the sound IS you",
                "This is aesthetic excellence",
                "POV: Vibe check PASSED",
                "The perfect mood anthem",
                "When music becomes brand",
                "This captures my whole vibe",
                "POV: Living the aesthetic dream",
                "The song for your style",
                "When the vibe is IMMACULATE",
                "This is what you sound like",
                "POV: Aesthetic perfectly matched",
                "The anthem for style icons",
                "When music defines aesthetic",
                "This is vibe perfection",
                "POV: The mood is EVERYTHING",
                "The perfect aesthetic soundtrack",
                "When sound becomes identity",
                "This matches my energy exactly",
                "POV: Found my vibe match",
                "The song for aesthetic living",
                "When music IS your brand",
                "This is mood in perfection",
                "POV: Aesthetic goals realized",
                "The anthem for your style",
                "When the vibe is CURATED",
                "This captures essence perfectly",
                "POV: Living IN the aesthetic",
                "The perfect vibe song",
                "When music matches soul",
                "This is what aesthetic sounds like",
                "POV: The vibe is MINE",
                "The song for your energy",
                "When sound defines you"
            ],
            chaotic: [
                "This song is UNHINGED energy",
                "POV: Chaos chose me today",
                "When the vibe is PURE CHAOS",
                "This is what madness sounds like",
                "POV: Absolutely losing it (lovingly)",
                "The perfect song for wild energy",
                "When music becomes disorder",
                "This is organized chaos",
                "POV: Sanity left the chat",
                "The anthem for chaotic souls",
                "When the song matches the chaos",
                "This is what mayhem sounds like",
                "POV: Embracing the madness",
                "The perfect soundtrack to chaos",
                "When music becomes anarchy",
                "This is pure pandemonium",
                "POV: Chaotic neutral energy",
                "The song for wild moments",
                "When the vibe is UNCONTROLLED",
                "This is what chaos sounds like",
                "POV: Absolutely feral energy",
                "The anthem for chaotic energy",
                "When music becomes madness",
                "This is beautiful disaster",
                "POV: Everything's on fire (fine)",
                "The perfect chaotic anthem",
                "When the song IS chaos",
                "This is what disorder sounds like",
                "POV: Living in the chaos",
                "The soundtrack to madness",
                "When music matches insanity",
                "This is pure bedlam",
                "POV: Chaos is my comfort zone",
                "The song for wild souls",
                "When the vibe is UNHINGED",
                "This is what mayhem sounds like",
                "POV: Embracing the disorder",
                "The anthem for chaos lovers",
                "When music becomes turmoil",
                "This is chaotic perfection",
                "POV: Thriving in chaos",
                "The perfect madness soundtrack",
                "When the song matches energy",
                "This is what feral sounds like",
                "POV: Absolutely uncontained",
                "The song for chaotic moments",
                "When music becomes havoc",
                "This is pure entropy",
                "POV: Living for the chaos",
                "The anthem for disorder",
                "This is what wild sounds like",
                "POV: Chaos is the plan",
                "The perfect unhinged anthem",
                "When the vibe is FERAL",
                "This is chaotic energy",
                "POV: Sanity is overrated",
                "The song for wild times",
                "When music matches madness",
                "This is what anarchy sounds like",
                "POV: Embracing the insanity",
                "The anthem for wild ones",
                "When the song IS madness",
                "This is pure pandemonium",
                "POV: Chaotic energy activated",
                "The perfect disorder soundtrack",
                "When music becomes chaos",
                "This is what unhinged sounds like",
                "POV: Living in beautiful chaos",
                "The song for chaotic vibes",
                "When the vibe is WILD",
                "This is chaotic excellence",
                "POV: Order who? Never heard of her",
                "The anthem for chaos energy",
                "When music matches disorder",
                "This is what mayhem sounds like",
                "POV: Thriving in madness",
                "The perfect chaos anthem",
                "When the song radiates chaos",
                "This is pure disorder",
                "POV: Absolutely FERAL vibes",
                "The song for wild energy",
                "When music becomes bedlam",
                "This is what chaos sounds like",
                "POV: Living for disorder",
                "The anthem for chaotic souls",
                "When the vibe is UNCONTAINED",
                "This is chaotic beauty",
                "POV: Madness is my aesthetic",
                "The perfect unhinged song",
                "When music IS chaos",
                "This is what wild sounds like",
                "POV: Chaos chose ME",
                "The song for feral moments",
                "When the energy is UNHINGED",
                "This is pure beautiful chaos",
                "POV: Living in the madness",
                "The anthem for wild hearts",
                "When music matches chaos",
                "This is what disorder sounds like"
            ],
            main: [
                "POV: You're the main character NOW",
                "This is YOUR moment starting",
                "When the song makes you THE ONE",
                "This is main character energy",
                "POV: Your movie montage playing",
                "The perfect protagonist anthem",
                "When music makes you legendary",
                "This is what spotlight sounds like",
                "POV: Everyone's watching YOU",
                "The song for YOUR story",
                "When the moment is YOURS",
                "This is protagonist energy",
                "POV: Life became a movie",
                "The anthem for main characters",
                "When music crowns you",
                "This is what destiny sounds like",
                "POV: Your era has begun",
                "The perfect moment soundtrack",
                "When the song chooses YOU",
                "This is main character vibes",
                "POV: The spotlight found you",
                "The anthem for YOUR moment",
                "When music makes you special",
                "This is what chosen sounds like",
                "POV: Everyone else is background",
                "The song for YOUR story arc",
                "When the moment becomes YOURS",
                "This is protagonist perfection",
                "POV: Living YOUR best plot",
                "The perfect main character song",
                "When music elevates you",
                "This is what special sounds like",
                "POV: Your time is NOW",
                "The anthem for YOUR journey",
                "When the song makes you legendary",
                "This is main character mode",
                "POV: The universe chose YOU",
                "The soundtrack to YOUR story",
                "When music makes you destined",
                "This is what protagonist sounds like",
                "POV: Everyone's an extra now",
                "The song for YOUR moment",
                "When the vibe makes you special",
                "This is main character excellence",
                "POV: Life's YOUR movie now",
                "The anthem for chosen ones",
                "When music crowns you king",
                "This is what legend sounds like",
                "POV: The story revolves around YOU",
                "The perfect protagonist soundtrack",
                "This is YOUR era energy",
                "POV: Main character mode activated",
                "The song for YOUR journey",
                "When music makes you important",
                "This is what special sounds like",
                "POV: Everyone watching YOUR rise",
                "The anthem for YOUR story",
                "When the moment chooses you",
                "This is protagonist energy",
                "POV: Living YOUR main plot",
                "The perfect main character vibe",
                "When music makes you shine",
                "This is what chosen sounds like",
                "POV: The spotlight is YOURS",
                "The song for YOUR montage",
                "When the vibe elevates you",
                "This is main character perfection",
                "POV: Everyone else faded out",
                "The anthem for YOUR moment",
                "When music crowns you special",
                "This is what destined sounds like",
                "POV: Life became YOUR movie",
                "The perfect protagonist anthem",
                "When the song chooses YOU",
                "This is main character magic",
                "POV: The universe said IT'S YOU",
                "The soundtrack to YOUR rise",
                "When music makes you THE one",
                "This is what legendary sounds like",
                "POV: Everyone's watching YOUR story",
                "The anthem for chosen ones",
                "When the moment becomes YOURS",
                "This is protagonist excellence",
                "POV: Living as main character",
                "The perfect story soundtrack",
                "When music elevates YOUR moment",
                "This is what special sounds like",
                "POV: The plot follows YOU",
                "The song for YOUR destiny",
                "When the vibe crowns you",
                "This is main character energy",
                "POV: Everyone else is supporting cast",
                "The anthem for YOUR era",
                "When music makes you iconic",
                "This is what protagonist sounds like",
                "POV: Life's centered on YOU now",
                "The perfect main character song",
                "When the moment chooses YOU",
                "This is YOUR story energy"
            ]
        };

        let selectedCategory = 'happy';

        document.querySelectorAll('.caption-cat-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.caption-cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.category;
            };
        });

        document.getElementById('random-caption-btn').onclick = () => {
            const captions = viralCaptions[selectedCategory];
            const randomCaption = captions[Math.floor(Math.random() * captions.length)];
            
            document.getElementById('caption-input').value = randomCaption;
            caption.innerText = randomCaption;
            
            const btn = document.getElementById('random-caption-btn');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = 'scale(1)', 100);
        };

        // ============================================
        // EXPORT ALL FUNCTIONALITY
        // ============================================
        
        document.getElementById('export-all-btn').onclick = async () => {
            if (videoQueue.length === 0) {
                alert('La coda Ã¨ vuota! Aggiungi video prima di esportare.');
                return;
            }

            if (!confirm(`Esportare ${videoQueue.length} video? Questo potrebbe richiedere diversi minuti.`)) {
                return;
            }

            const exportAllBtn = document.getElementById('export-all-btn');
            exportAllBtn.disabled = true;
            
            const status = document.getElementById('export-status');
            const progress = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            const percentText = document.getElementById('percent-text');
            
            status.classList.remove('hidden');

            try {
                for (let queueIndex = 0; queueIndex < videoQueue.length; queueIndex++) {
                    const item = videoQueue[queueIndex];
                    
                    statusText.innerText = `Video ${queueIndex + 1}/${videoQueue.length}: Preparazione...`;
                    progress.style.width = '0%';
                    percentText.innerText = '0%';

                    // Setup video source
                    const sourceVideo = document.getElementById('source-video');
                    sourceVideo.src = URL.createObjectURL(item.videoFile);
                    await new Promise(r => sourceVideo.onloadedmetadata = r);

                    const renderCanvas = document.getElementById('render-canvas');
                    const renderCtx = renderCanvas.getContext('2d');
                    
                    const targetWidth = 720;
                    const targetHeight = 1280;
                    
                    renderCanvas.width = targetWidth;
                    renderCanvas.height = targetHeight;

                    const fps = 30;
                    const duration = item.vEnd - item.vStart;

                    const { Muxer, ArrayBufferTarget } = window.Mp4Muxer;

                    const muxerConfig = {
                        target: new ArrayBufferTarget(),
                        video: {
                            codec: 'avc',
                            width: renderCanvas.width,
                            height: renderCanvas.height
                        },
                        fastStart: 'in-memory'
                    };

                    if (item.audioFile) {
                        muxerConfig.audio = {
                            codec: 'aac',
                            numberOfChannels: 2,
                            sampleRate: 48000
                        };
                    }

                    const muxer = new Muxer(muxerConfig);
                    
                    const videoEncoder = new VideoEncoder({
                        output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                        error: e => {
                            console.error('Video encoder error:', e);
                            throw new Error('Errore di codifica video: ' + e.message);
                        }
                    });

                    videoEncoder.configure({
                        codec: 'avc1.42001F',
                        width: renderCanvas.width,
                        height: renderCanvas.height,
                        bitrate: 8_000_000,
                        framerate: fps,
                        avc: { format: 'avc' }
                    });

                    let audioEncoder = null;
                    let audioData = null;

                    if (item.audioFile) {
                        const audioContext = new AudioContext({ sampleRate: 48000 });
                        const audioBuffer = await item.audioFile.arrayBuffer();
                        const decodedAudio = await audioContext.decodeAudioData(audioBuffer);
                        
                        const startSample = Math.floor(item.aStart * decodedAudio.sampleRate);
                        const endSample = Math.floor((item.aStart + duration) * decodedAudio.sampleRate);
                        const sampleCount = endSample - startSample;
                        
                        audioData = {
                            left: new Float32Array(sampleCount),
                            right: new Float32Array(sampleCount),
                            sampleRate: decodedAudio.sampleRate
                        };
                        
                        const leftChannel = decodedAudio.getChannelData(0);
                        const rightChannel = decodedAudio.numberOfChannels > 1 ? decodedAudio.getChannelData(1) : leftChannel;
                        
                        for (let i = 0; i < sampleCount; i++) {
                            audioData.left[i] = leftChannel[startSample + i] || 0;
                            audioData.right[i] = rightChannel[startSample + i] || 0;
                        }

                        audioEncoder = new AudioEncoder({
                            output: (chunk, meta) => muxer.addAudioChunk(chunk, meta),
                            error: e => {
                                console.error('Audio encoder error:', e);
                                throw new Error('Errore di codifica audio: ' + e.message);
                            }
                        });

                        audioEncoder.configure({
                            codec: 'mp4a.40.2',
                            sampleRate: 48000,
                            numberOfChannels: 2,
                            bitrate: 128000
                        });
                    }

                    sourceVideo.currentTime = item.vStart;
                    await new Promise(r => sourceVideo.onseeked = r);

                    const totalFrames = Math.ceil(duration * fps);
                    const targetSampleRate = 48000;
                    const sourceSampleRate = audioData ? audioData.sampleRate : 48000;
                    const samplesPerFrame = Math.floor(targetSampleRate / fps);
                    let audioSampleOffset = 0;

                    // Container height for scaling (using a standard preview height)
                    const previewHeight = 515; // Standard preview container height
                    const exportHeight = renderCanvas.height;
                    const scaleFactor = exportHeight / previewHeight;

                    for (let i = 0; i < totalFrames; i++) {
                        const timestamp = i / fps;
                        sourceVideo.currentTime = item.vStart + timestamp;
                        await new Promise(r => sourceVideo.onseeked = r);

                        // Draw video with optional zoom
                        if (item.removeWatermark) {
                            const scale = 1.1;
                            const scaledWidth = sourceVideo.videoWidth * scale;
                            const scaledHeight = sourceVideo.videoHeight * scale;
                            const offsetX = -(scaledWidth - renderCanvas.width) / 2;
                            const offsetY = -(scaledHeight - renderCanvas.height) / 2;
                            
                            renderCtx.drawImage(sourceVideo, offsetX, offsetY, scaledWidth, scaledHeight);
                        } else {
                            renderCtx.drawImage(sourceVideo, 0, 0, renderCanvas.width, renderCanvas.height);
                        }

                        // Draw caption with word wrapping
                        if (item.caption && item.caption !== 'Scrivi il tuo testo') {
                            const scaledFontSize = item.fontSize * scaleFactor;
                            const scaledMaxWidth = item.captionMaxWidthPx * scaleFactor;

                            let fontFamily = 'Montserrat';
                            if (item.fontClass.includes('font-typewriter')) fontFamily = 'Courier Prime';
                            else if (item.fontClass.includes('font-classic')) fontFamily = 'Inter';
                            else if (item.fontClass.includes('font-handwriting')) fontFamily = 'Dancing Script';

                            renderCtx.font = `800 ${scaledFontSize}px ${fontFamily}`;
                            renderCtx.textAlign = 'center';
                            renderCtx.textBaseline = 'top';

                            function wrapText(text, maxWidth) {
                                const words = text.split(' ');
                                const lines = [];
                                let currentLine = words[0];

                                for (let i = 1; i < words.length; i++) {
                                    const testLine = currentLine + ' ' + words[i];
                                    const metrics = renderCtx.measureText(testLine);
                                    if (metrics.width > maxWidth) {
                                        lines.push(currentLine);
                                        currentLine = words[i];
                                    } else {
                                        currentLine = testLine;
                                    }
                                }
                                lines.push(currentLine);
                                return lines;
                            }

                            const lines = wrapText(item.caption, scaledMaxWidth);
                            const lineHeight = scaledFontSize * 1.2;
                            const textY = item.captionTopPx * scaleFactor;

                            lines.forEach((line, index) => {
                                const y = textY + (index * lineHeight);
                                
                                if (item.hasOutline) {
                                    renderCtx.strokeStyle = item.outlineColor;
                                    renderCtx.lineWidth = Math.max(scaleFactor * 1.5, 3);
                                    renderCtx.lineJoin = 'round';
                                    renderCtx.miterLimit = 2;
                                    renderCtx.strokeText(line, renderCanvas.width / 2, y);
                                }

                                renderCtx.fillStyle = item.textColor;
                                renderCtx.fillText(line, renderCanvas.width / 2, y);
                            });
                        }

                        const videoFrame = new VideoFrame(renderCanvas, {
                            timestamp: (i * 1_000_000) / fps
                        });

                        videoEncoder.encode(videoFrame, { keyFrame: i % 30 === 0 });
                        videoFrame.close();

                        if (audioEncoder && audioData) {
                            const resampleRatio = sourceSampleRate / targetSampleRate;
                            const sourceSamplesNeeded = Math.floor(samplesPerFrame * resampleRatio);
                            
                            const leftChannel = new Float32Array(samplesPerFrame);
                            const rightChannel = new Float32Array(samplesPerFrame);
                            
                            for (let j = 0; j < samplesPerFrame; j++) {
                                const sourceIndex = Math.floor(audioSampleOffset + (j * resampleRatio));
                                if (sourceIndex < audioData.left.length) {
                                    leftChannel[j] = audioData.left[sourceIndex];
                                    rightChannel[j] = audioData.right[sourceIndex];
                                } else {
                                    leftChannel[j] = 0;
                                    rightChannel[j] = 0;
                                }
                            }

                            const audioFrame = new AudioData({
                                format: 'f32-planar',
                                sampleRate: targetSampleRate,
                                numberOfFrames: samplesPerFrame,
                                numberOfChannels: 2,
                                timestamp: (i * 1_000_000) / fps,
                                data: new Float32Array([...leftChannel, ...rightChannel])
                            });

                            audioEncoder.encode(audioFrame);
                            audioFrame.close();
                            
                            audioSampleOffset += sourceSamplesNeeded;
                        }

                        const progressPercent = Math.round((i / totalFrames) * 100);
                        progress.style.width = progressPercent + '%';
                        percentText.innerText = progressPercent + '%';

                        if (i % 10 === 0) {
                            await new Promise(r => setTimeout(r, 0));
                        }
                    }

                    await videoEncoder.flush();
                    if (audioEncoder) await audioEncoder.flush();
                    muxer.finalize();

                    const buffer = muxer.target.buffer;
                    const blob = new Blob([buffer], { type: 'video/mp4' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const sanitizedCaption = (item.caption || 'video').substring(0, 30).replace(/[^a-z0-9]/gi, '_');
                    a.download = `TikTok_${queueIndex + 1}_${sanitizedCaption}.mp4`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    // Small delay between downloads
                    await new Promise(r => setTimeout(r, 500));
                }

                statusText.innerText = 'Tutti i video esportati!';
                percentText.innerText = '100%';
                progress.style.width = '100%';
                
                setTimeout(() => {
                    status.classList.add('hidden');
                    exportAllBtn.disabled = false;
                }, 3000);

            } catch (e) {
                console.error('Errore durante l\'export bulk:', e);
                statusText.innerText = 'Errore: ' + e.message;
                alert('Errore durante l\'export bulk. Controlla la console per dettagli.');
                setTimeout(() => status.classList.add('hidden'), 3000);
                exportAllBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
